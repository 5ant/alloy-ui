<?xml version="1.0"?>
<project name="Alloy" basedir="." default="release">
	<property name="project.dir" value="."/>
	<property name="release.name" value="alloy" />
	<property name="release.temp.dir" value="${project.dir}/resources/temp/alloy/" />
	<property name="release.version" value="0.1a"/>
	<property name="yui3.dir" value="${project.dir}/lib/yui3/" />
	<property name="yui3.file" value="yui3.zip" />

	<import file="resources/builder/bootstrap.xml"/>

	<target name="all">
		<antcall target="init-yui"/>
		<antcall target="build-aui"/>
	</target>

	<target name="build-aui" depends="remove-whitespace">
		<subant target="all">
			<fileset
				dir="${project.dir}/src"
				excludes="build.xml"
				includes="**/build.xml"
			/>
		</subant>

		<antcall target="build-skins" />
		<antcall target="clean" />
	</target>

	<target name="build-modules">
		<subant target="all">
			<fileset
				dir="${project.dir}/src/aui-base/"
				includes="build.xml"
			/>
		</subant>
	</target>

	<target name="build-skins">
		<copy todir="${project.dir}/build/aui-skins" overwrite="true">
			<fileset dir="${project.dir}/src/aui-skins"/>
		</copy>
	</target>

	<target name="build-yui">
		<subant target="all">
			<fileset
				dir="${project.dir}/lib/yui3/src"
				excludes="build.xml"
				includes="**/build.xml"
			/>
		</subant>
		<subant target="init-yui"/>
	</target>

	<target name="clean">
		<delete includeemptydirs="true">
			<fileset dir="${project.dir}/src/" defaultexcludes="false">
				<include name="**/*build_tmp*/**" />
				<include name="**/*build_rollup_tmp*/**" />
			</fileset>
		</delete>
	</target>

	<target name="clean-release">
		<delete dir="${release.temp.dir}" />
		<delete file="${project.dir}/${release.name}-${release.version}.zip" />
	</target>

	<target name="init-yui">
		<echo>Initializing YUI Library.</echo>

		<delete dir="${yui3.dir}" />
		<unzip src="${project.dir}/lib/${yui3.file}" dest="${project.dir}/lib/" />

		<copy todir="${project.dir}/build" preservelastmodified="true">
			<fileset dir="${project.dir}/lib/yui3/build">
				<include name="**/*"/>
			</fileset>
		</copy>
	</target>

	<target name="release" depends="clean-release">
		<copy todir="${release.temp.dir}">
			<fileset dir="${project.dir}">
				<include name="build/**" />
				<include name="demos/**" />
				<include name="sandbox/**" />
				<include name="*.txt" />
			</fileset>
		</copy>

		<echo>Replacing @VERSION@ tokens</echo>

		<replaceregexp match="@VERSION@" replace="${release.version}" flags="g" byline="true">
			<fileset dir="${release.temp.dir}/" includes="version.txt"/>
			<fileset dir="${release.temp.dir}/build/" includes="**/aui-*.js"/>
        </replaceregexp>

		<echo>Creating Zip file ${release.name}.zip</echo>

		<zip basedir="${release.temp.dir}" destfile="${project.dir}/${release.name}-${release.version}.zip" />
		
		<delete dir="${release.temp.dir}" />
	</target>

	<target name="remove-whitespace">
		<echo>Removing trailing spaces of the source files.</echo>

		<replaceregexp match="[\t ]+$" replace="" flags="g" byline="true">
			<fileset dir="${project.dir}/src/" includes="*.js"/>
		</replaceregexp>
	</target>
</project>
