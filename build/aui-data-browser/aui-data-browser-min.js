AUI.add("aui-data-browser",function(E){var G=E.Lang,H=G.isArray,C=G.isString,B=G.isNull,D=G.isFunction,F=E.ClassNameManager.getClassName,L="databrowser",J="searchView",I="treeView";ALERT="alert",ICON="icon",IMAGE="image",INPUT="input",LOADING="loading",RENDERED="rendered",SEARCH="search",TEXT="text",TREE="tree",ICON_FOLDER="folder-open",ICON_DEFAULT="search",ICON_ERROR=ALERT,ICON_LOADING=LOADING,isResultItem=function(A){return A.hasClass(CSS_RESULTS_ITEM);},isTreeView=function(A){return(A instanceof E.TreeView);},isTreeNodeItem=function(A){return A.hasClass(CSS_TREE_NODE);},CSS_RESULTS_ITEM=F(L,"results","item"),CSS_SEARCH=F(L,SEARCH),CSS_SEARCH_LIST=F(L,SEARCH,"list"),CSS_SEARCH_LIST_ITEM=F(L,SEARCH,"list","item"),CSS_TREE=F(L,TREE),CSS_TREE_NODE=F(L,TREE,"node"),KEY_ENTER=13,BOUNDING_BOX="boundingBox",CONTENT_BOX="contentBox",TPL_SEARCH='<div class="'+CSS_SEARCH+'"></div>',TPL_SEARCH_LIST='<ul class="'+CSS_SEARCH_LIST+'"></ul>',TPL_SEARCH_LIST_ITEM='<li class="'+CSS_RESULTS_ITEM+" "+CSS_SEARCH_LIST_ITEM+'-{1}">{0}</li>',TPL_SEARCH_LIST_ITEM_IMAGE='<img src="{2}" title="{1}" alt="" /><div>{0}</div>',TPL_SEARCH_LIST_ITEM_ICON='<span class="{2}" title="{1}"></span><div>{0}</div>',TPL_SEARCH_LIST_ITEM_TEXT='<div title="{1}">{0}</div>',TPL_TREE='<div class="'+CSS_TREE+'"></div>';var K=E.Component.create({NAME:L,ATTRS:{autoLoad:{value:true},currentView:{value:SEARCH},dataSource:{value:null,getter:function(){var A=this;var N=[];if(A.get(RENDERED)){var O=A.get(J);if(O){N[SEARCH]=O.dataSource;}var M=A.get(I);if(M){N[TREE]=M.dataSource;}}return N;}},displayName:{value:false},rootLabel:{value:""},searchView:{value:null},treeView:{value:null}},prototype:{initializer:function(){var A=this;A._createDataSource();var O=A.get(J);var M=A.get(I);var N=A.get("currentView");if(!M&&N==TREE){A.set("currentView",SEARCH);}else{if(!O&&N==SEARCH){A.set("currentView",TREE);}}},bindUI:function(){var A=this;var Q=A.get(J);var N=A.get(I);if(Q){var M=A.buttonSearch;var O=A.inputNode;Q.dataSource.on("request",E.bind(M.set,M,ICON,ICON_LOADING));O.on("focus",A._onTextboxFocus,A);O.on("keydown",A._onTextboxKeyDown,A);if(N){var P=A.buttonTree;N.dataSource.on("request",E.bind(P.set,P,ICON,ICON_LOADING));}}A.publish("dataError");A.publish("dataRequest");A.publish("dataReturn");A.publish("textboxFocus");A.publish("textboxKey");A.publish("itemSelected");A.publish("itemError");},renderUI:function(){var A=this;var M=A.get(CONTENT_BOX);if(A.get(J)){A._renderInput();var P=E.Node.create(TPL_SEARCH);P.hide();M.append(P);A._searchViewEl=P;}var N=A.get(I);if(N){var Q=N.dataSource;var O=E.Node.create(TPL_TREE);O.hide();M.append(O);N=new E.TreeView({boundingBox:O}).render();N.on("expand",function(T){var R=this;var S=T.tree.node;R._expandNode(S,Q);},A);A._treeView=N;A._treeViewEl=O;}M.delegate("click",function(S){var R=S.currentTarget;if(isResultItem(R)){var T=null;if(isTreeNodeItem(R)){R=E.Widget.getByNode(R);if(R){T=R._originalConfig;}}else{T=R.getData(L);}if(T){A.fire("itemSelected",{node:R,item:T});}else{A.fire("itemError",S);}}},"."+CSS_RESULTS_ITEM);},syncUI:function(){var A=this;var P=A.get(J);var M=A.get(I);var O=A.get("currentView");var N=A.get("autoLoad");if(N){if(O==SEARCH){if(P){A._generateQuery();}}else{if(O==TREE){if(M){A._loadTreeView();}}}}A._syncResultViews();A._toggleView();},doBeforeLoadData:function(A){return true;},handleResponse:function(O){var M=this;var P=M.get("currentView");var A=null;if(O.error){A=ICON_ERROR;}if(P==SEARCH){var N=M.buttonSearch;if(!O.error){A=ICON_DEFAULT;}else{M._query=null;}N.set(ICON,A);}else{if(P==TREE){var N=M.buttonTree;if(N){if(!O.error){A=ICON_FOLDER;}N.set(ICON,A);}}}},generateRequest:function(M){var A=this;return{request:M,callback:{success:E.bind(function(O){var N=this;N._populateSearchView(O);},A),failure:E.bind(function(O){var N=this;N._handleResponse(O);},A)}};},_createDataSource:function(){var R=this;var S=[R.get(J),R.get(I)];for(var P=0;P<S.length;P++){if(S[P]){var A=S[P].dataSource;var O=A;var T=S[P].dataSourceType;var N=S[P].schema;var M=S[P].schemaType;if(!(A instanceof E.DataSource.Local)){if(!T){T="Local";if(D(O)){T="Function";}else{if(C(O)){T="IO";}}}A=new E.DataSource[T]({source:O});}A.on("error",R.handleResponse,R);A.after("response",R.handleResponse,R);T=A.name;if(T=="dataSourceLocal"){R.set("applyLocalFilter",true);}S[P].dataSource=A;S[P].dataSourceType=T;if(N){if(N.fn){S[P].dataSource.plug(N);}else{var Q={array:E.Plugin.DataSourceArraySchema,json:E.Plugin.DataSourceJSONSchema,text:E.Plugin.DataSourceTextSchema,xml:E.Plugin.DataSourceXMLSchema};M=(M?M.toLowerCase():"array");S[P].dataSource.plug({fn:Q[M],cfg:{schema:N}});}}S[P].schema=N;}}},_expandNode:function(N,O){var A=this;if(N&&!N.hasChildNodes()){var M={cfg:(!isTreeView(N)?N._originalConfig:null),callback:{success:E.bind(function(Q){var P=this;P._populateTreeView(E.mix(Q,{node:N}));},A),failure:E.bind(function(Q){var P=this;P._handleResponse(Q);},A)}};A.fire("dataRequest",null,M);O.sendRequest(M);}},_generateQuery:function(N){var A=this;var Q=A.get("currentView");var M=A.inputNode;var P=A._query;var O=M.get("value");if(Q==TREE&&(O!=""&&P==O)){A.set("currentView",SEARCH);A._toggleView();}else{this._sendQuery(O);}},_loadTreeView:function(){var A=this;var M=A.get(I);A._expandNode(A._treeView,M.dataSource);},_onTextboxFocus:function(M){var A=this;if(!A.get("focused")){A.focus();A._initInputValue=A.inputNode.get("value");A.fire("textboxFocus");}},_onTextboxKeyDown:function(M){var A=this;var N=M.keyCode;switch(N){case KEY_ENTER:A._generateQuery(M);break;default:A.fire("textboxKey",N);break;}A._keyCode=N;},_populateSearchView:function(W){var b=this;var M=W.response;var S=b.doBeforeLoadData(W);if(S&&!W.error){b.set("currentView",SEARCH);b.fire("dataReturn",W);var U=b.get(J);var O=b.get("displayName");var Y=M.results;var P=U.folderKey;var A=[];if(P){var R=[];var c=[];var Q=0;for(var X=0;X<Y.length;X++){var f=Y[X][P];if(f!=null){if(R[f]!=null){A[R[f]].data.push(Y[X]);}else{R[f]=Q;A[Q]={name:f,data:[Y[X]]};Q++;}}else{c.push(Y[X]);
}}A.sort(function(h,g){return(h.data.length==g.data.length?0:(h.data.length>g.data.length?-1:1));});if(c.length>0){A.push({name:"",data:c});}}else{A.push({name:"",data:Y});}b._searchViewEl.html("");for(var X=0;X<A.length;X++){var T=E.Node.create(TPL_SEARCH_LIST);for(var V=0;V<A[X].data.length;V++){var d=A[X].data[V];var e=null;var Z=null;var N=null;if(d.imageUri){e=TPL_SEARCH_LIST_ITEM_IMAGE;Z=d.imageUri;N=IMAGE;}else{if(d.iconCss){e=TPL_SEARCH_LIST_ITEM_ICON;Z=d.iconCss;N=ICON;}else{e=TPL_SEARCH_LIST_ITEM_TEXT;N=TEXT;}}e=G.sub(TPL_SEARCH_LIST_ITEM,[G.sub(e,[(O?d.name:""),d.title||"",Z||""]),N]);var a=E.Node.create(e);a.setData(L,d);T.append(a);}if(P){new E.Panel({collapsible:true,collapsed:(b._searchViewEl.html()!=""),headerContent:A[X].name,bodyContent:T}).render(b._searchViewEl);}else{b._searchViewEl.append(T);}}this._toggleView();}},_populateTreeView:function(A){var T=this;var O=A.response;var N=A.node;var R=T.doBeforeLoadData(A);if(R&&!A.error&&N!=null){T.set("currentView",TREE);T.fire("dataReturn",A);var P=O.results;if(P.length>0){function Q(V){for(var U in V){if(V[U].children||(V[U].leaf!=undefined&&!V[U].leaf)){Q(V[U].children);}else{V[U].cssClass=(V[U].cssClass?" ":"")+CSS_RESULTS_ITEM;}}}Q(P);var S=T.get("rootLabel");if(S&&isTreeView(N)){var M=new E.TreeNode({label:S,children:P});N.appendChild(M);}else{E.each(P,function(U){var V=N.createNode.apply(T,[U]);N.appendChild(V);});}}this._toggleView();}else{T.fire("dataError",A);}},_renderInput:function(){var R=this;var N=R.get(CONTENT_BOX);var P=R.get("input");var A=R.get(I);var O={field:{labelText:false},icons:[{icon:ICON_DEFAULT,handler:{fn:R._generateQuery,context:R}}]};if(A){O.icons.push({icon:ICON_FOLDER,handler:{fn:function(){var U=this;U.set("currentView",TREE);U._loadTreeView();U._toggleView();},context:R}});}var S=null;var T=null;if(P){P=E.one(P);O.field.node=P;S=P.next();T=P.get("parentNode");}var Q=new E.Combobox(O).render(N);if(T){var M=Q.get("boundingBox");T.insertBefore(M,S);}R.comboBox=Q;R.inputNode=Q.get("node");R.buttonSearch=Q.icons.item(0);if(A){R.buttonTree=Q.icons.item(1);}R.set("uniqueName",E.stamp(R.inputNode));},_sendQuery:function(N){var A=this;var P=A.get(J);var O=P.dataSource;N=encodeURIComponent(N);var M=A.generateRequest(N);A.fire("dataRequest",N,M);O.sendRequest(M);A._query=N;},_syncResultViews:function(){var R=this;var T=R.get("height");if(T){var N=R.get(BOUNDING_BOX);var A=R._searchViewEl;var O=R._treeViewEl;var Q=R.comboBox;var M=0;if(Q){var S=Q.get(BOUNDING_BOX);M+=(parseFloat(S.getComputedStyle("marginTop"))+parseFloat(S.getComputedStyle("borderTopWidth"))+S.getDOM().offsetHeight+parseFloat(S.getComputedStyle("borderBottomWidth"))+parseFloat(S.getComputedStyle("marginBottom")));}var U=parseInt(R.get("height"))-M;if(A){var P=(parseFloat(A.getComputedStyle("borderTopWidth"))+parseFloat(A.getComputedStyle("paddingTop"))+parseFloat(A.getComputedStyle("paddingBottom"))+parseFloat(A.getComputedStyle("borderBottomWidth")));A.setStyle("height",(U-P)+"px");}if(O){var P=(parseFloat(O.getComputedStyle("borderTopWidth"))+parseFloat(O.getComputedStyle("paddingTop"))+parseFloat(O.getComputedStyle("paddingBottom"))+parseFloat(O.getComputedStyle("borderBottomWidth")));O.setStyle("height",(U-P)+"px");}}},_toggleView:function(){var A=this;var O=A.get("currentView");var N=A._searchViewEl;var M=A._treeViewEl;if(O==SEARCH){if(M){M.hide();}if(N){N.show();}}else{if(O==TREE){if(N){N.hide();}if(M){M.show();}}}}}});E.DataBrowser=K;},"@VERSION@",{requires:["aui-base","aui-tree","aui-panel","datasource","dataschema","aui-form-combobox"],skinnable:true});