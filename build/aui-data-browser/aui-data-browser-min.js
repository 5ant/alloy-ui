AUI.add("aui-data-browser",function(K){var s=K.Lang,T=s.isArray,J=s.isString,j=s.isNull,L=s.isFunction,p=K.ClassNameManager.getClassName,b="databrowser",P="searchView",O="treeView",i="alert",Y="icon",G="image",F="input",Q="loading",k="rendered",V="search",m="text",g="tree",H="folder-open",R="search",h=i,E=Q,n=function(t){for(var A in t){if(t[A].children||(t[A].leaf!=undefined&&!t[A].leaf)){n(t[A].children);}else{t[A].cssClass=(t[A].cssClass?" ":"")+q;}}},X=function(A){return A.hasClass(q);},D=function(A){return(A instanceof K.TreeView);},B=function(A){return A.hasClass(Z);},q=p(b,"results","item"),U=p(b,V),d=p(b,V,"list"),M=p(b,V,"list","item"),C=p(b,g),Z=p(b,g,"node"),a=13,o="boundingBox",W="contentBox",I='<div class="'+U+'"></div>',r='<ul class="'+d+'"></ul>',e='<li class="'+q+" "+M+'-{1}">{0}</li>',S='<img src="{2}" title="{1}" alt="" /><div>{0}</div>',N='<span class="{2}" title="{1}"></span><div>{0}</div>',c='<div title="{1}">{0}</div>',f='<div class="'+C+'"></div>';var l=K.Component.create({NAME:b,ATTRS:{autoLoad:{value:true},currentView:{value:V},dataSource:{value:null,getter:function(){var A=this;var u=[];if(A.get(k)){var v=A.get(P);if(v){u[V]=v.dataSource;}var t=A.get(O);if(t){u[g]=t.dataSource;}}return u;}},displayName:{value:false},rootLabel:{value:""},searchView:{value:null},treeView:{value:null}},prototype:{initializer:function(){var A=this;A._createDataSource();var v=A.get(P);var t=A.get(O);var u=A.get("currentView");if(!t&&u==g){A.set("currentView",V);}else{if(!v&&u==V){A.set("currentView",g);}}},bindUI:function(){var A=this;var x=A.get(P);var u=A.get(O);if(x){var t=A.buttonSearch;var v=A.inputNode;x.dataSource.on("request",K.bind(t.set,t,Y,E));v.on("focus",A._onTextboxFocus,A);v.on("keydown",A._onTextboxKeyDown,A);if(u){var w=A.buttonTree;u.dataSource.on("request",K.bind(w.set,w,Y,E));}}A.publish("dataError");A.publish("dataRequest");A.publish("dataReturn");A.publish("textboxFocus");A.publish("textboxKey");A.publish("itemSelected");A.publish("itemError");},renderUI:function(){var A=this;var t=A.get(W);if(A.get(P)){A._renderInput();var w=K.Node.create(I);w.hide();t.append(w);A._searchViewEl=w;}var u=A.get(O);if(u){var x=u.dataSource;var v=K.Node.create(f);v.hide();t.append(v);u=new K.TreeView({boundingBox:v}).render();u.on("expand",function(AA){var y=this;var z=AA.tree.node;y._expandNode(z,x);},A);A._treeView=u;A._treeViewEl=v;}t.delegate("click",function(z){var y=z.currentTarget;if(X(y)){var AA=null;if(B(y)){y=K.Widget.getByNode(y);if(y){AA=y._originalConfig;}}else{AA=y.getData(b);}if(AA){A.fire("itemSelected",{node:y,item:AA});}else{A.fire("itemError",z);}}},"."+q);},syncUI:function(){var A=this;var w=A.get(P);var t=A.get(O);var v=A.get("currentView");var u=A.get("autoLoad");if(u){if(v==V){if(w){A._generateQuery();}}else{if(v==g){if(t){A._loadTreeView();}}}}A._syncResultViews();A._toggleView();},doBeforeLoadData:function(A){return true;},handleResponse:function(v){var t=this;var w=t.get("currentView");var A=null;var u;if(v.error){A=h;}if(w==V){u=t.buttonSearch;if(!v.error){A=R;}else{t._query=null;}u.set(Y,A);}else{if(w==g){u=t.buttonTree;if(u){if(!v.error){A=H;}u.set(Y,A);}}}},generateRequest:function(t){var A=this;return{request:t,callback:{success:K.bind(function(v){var u=this;u._populateSearchView(v);},A),failure:K.bind(function(v){var u=this;u._handleResponse(v);},A)}};},_createDataSource:function(){var y=this;var z=[y.get(P),y.get(O)];for(var w=0;w<z.length;w++){if(z[w]){var A=z[w].dataSource;var v=A;var AA=z[w].dataSourceType;var u=z[w].schema;var t=z[w].schemaType;if(!(A instanceof K.DataSource.Local)){if(!AA){AA="Local";if(L(v)){AA="Function";}else{if(J(v)){AA="IO";}}}A=new K.DataSource[AA]({source:v});}A.on("error",y.handleResponse,y);A.after("response",y.handleResponse,y);AA=A.name;if(AA=="dataSourceLocal"){y.set("applyLocalFilter",true);}z[w].dataSource=A;z[w].dataSourceType=AA;if(u){if(u.fn){z[w].dataSource.plug(u);}else{var x={array:K.Plugin.DataSourceArraySchema,json:K.Plugin.DataSourceJSONSchema,text:K.Plugin.DataSourceTextSchema,xml:K.Plugin.DataSourceXMLSchema};t=(t?t.toLowerCase():"array");z[w].dataSource.plug({fn:x[t],cfg:{schema:u}});}}z[w].schema=u;}}},_expandNode:function(u,v){var A=this;if(u&&!u.hasChildNodes()){var t={cfg:(!D(u)?u._originalConfig:null),callback:{failure:function(w){A._handleResponse(w);},success:function(w){A._populateTreeView(K.mix(w,{node:u}));}}};A.fire("dataRequest",null,t);v.sendRequest(t);}},_generateQuery:function(u){var A=this;var x=A.get("currentView");var t=A.inputNode;var w=A._query;var v=t.get("value");if(x==g&&(v!=""&&w==v)){A.set("currentView",V);A._toggleView();}else{this._sendQuery(v);}},_loadTreeView:function(){var A=this;var t=A.get(O);A._expandNode(A._treeView,t.dataSource);},_onTextboxFocus:function(t){var A=this;if(!A.get("focused")){A.focus();A._initInputValue=A.inputNode.get("value");A.fire("textboxFocus");}},_onTextboxKeyDown:function(t){var A=this;var u=t.keyCode;if(u==a){A._generateQuery(t);}else{A.fire("textboxKey",u);}A._keyCode=u;},_populateSearchView:function(AD){var AI=this;var t=AD.response;var z=AI.doBeforeLoadData(AD);if(z&&!AD.error){AI.set("currentView",V);AI.fire("dataReturn",AD);var AB=AI.get(P);var v=AI.get("displayName");var AF=t.results;var w=AB.folderKey;var A=[];if(w){var y=[];var AJ=[];var x=0;for(var AE=0;AE<AF.length;AE++){var AM=AF[AE][w];if(AM!=null){if(y[AM]!=null){A[y[AM]].data.push(AF[AE]);}else{y[AM]=x;A[x]={name:AM,data:[AF[AE]]};x++;}}else{AJ.push(AF[AE]);}}A.sort(function(AO,AN){return(AO.data.length==AN.data.length?0:(AO.data.length>AN.data.length?-1:1));});if(AJ.length>0){A.push({name:"",data:AJ});}}else{A.push({name:"",data:AF});}AI._searchViewEl.html("");for(var AE=0;AE<A.length;AE++){var AA=K.Node.create(r);for(var AC=0;AC<A[AE].data.length;AC++){var AK=A[AE].data[AC];var AL=null;var AG=null;var u=null;if(AK.imageUri){AL=S;AG=AK.imageUri;u=G;}else{if(AK.iconCss){AL=N;AG=AK.iconCss;u=Y;}else{AL=c;u=m;}}AL=s.sub(e,[s.sub(AL,[(v?AK.name:""),AK.title||"",AG||""]),u]);var AH=K.Node.create(AL);
AH.setData(b,AK);AA.append(AH);}if(w){new K.Panel({collapsible:true,collapsed:(AI._searchViewEl.html()!=""),headerContent:A[AE].name,bodyContent:AA}).render(AI._searchViewEl);}else{AI._searchViewEl.append(AA);}}this._toggleView();}},_populateTreeView:function(z){var t=this;var w=z.response;var y=z.node;var x=t.doBeforeLoadData(z);if(x&&!z.error&&y!=null){t.set("currentView",g);t.fire("dataReturn",z);var A=w.results;if(A.length>0){n(A);var u=t.get("rootLabel");if(u&&D(y)){var v=new K.TreeNode({label:u,children:A});y.appendChild(v);}else{K.each(A,function(AA){var AB=y.createNode.apply(t,[AA]);y.appendChild(AB);});}}this._toggleView();}else{t.fire("dataError",z);}},_renderInput:function(){var y=this;var u=y.get(W);var w=y.get("input");var A=y.get(O);var v={field:{labelText:false},icons:[{icon:R,handler:{fn:y._generateQuery,context:y}}]};if(A){v.icons.push({icon:H,handler:{fn:function(){var AB=this;AB.set("currentView",g);AB._loadTreeView();AB._toggleView();},context:y}});}var z=null;var AA=null;if(w){w=K.one(w);v.field.node=w;z=w.next();AA=w.get("parentNode");}var x=new K.Combobox(v).render(u);if(AA){var t=x.get("boundingBox");AA.insertBefore(t,z);}y.comboBox=x;y.inputNode=x.get("node");y.buttonSearch=x.icons.item(0);if(A){y.buttonTree=x.icons.item(1);}y.set("uniqueName",K.stamp(y.inputNode));},_sendQuery:function(u){var A=this;var w=A.get(P);var v=w.dataSource;u=encodeURIComponent(u);var t=A.generateRequest(u);A.fire("dataRequest",u,t);v.sendRequest(t);A._query=u;},_syncResultViews:function(){var y=this;var AA=y.get("height");if(AA){var u=y.get(o);var A=y._searchViewEl;var v=y._treeViewEl;var x=y.comboBox;var t=0;if(x){var z=x.get(o);t+=z.getBorderWidth("tb")+z.getMargin("tb")+z.get("offsetHeight");}var AB=parseInt(y.get("height"),10)-t;var w;if(A){w=A.getBorderWidth("tb")+A.getPadding("tb");A.setStyle("height",(AB-w));}if(v){w=v.getBorderWidth("tb")+v.getPadding("tb");v.setStyle("height",(AB-w));}}},_toggleView:function(){var A=this;var v=A.get("currentView");var u=A._searchViewEl;var t=A._treeViewEl;if(v==V){if(t){t.hide();}if(u){u.show();}}else{if(v==g){if(u){u.hide();}if(t){t.show();}}}}}});K.DataBrowser=l;},"@VERSION@",{requires:["aui-base","aui-tree","aui-panel","datasource","dataschema","aui-form-combobox"],skinnable:true});