AUI.add("aui-diagram-builder-impl",function(aj){var Y=aj.Lang,c=Y.isArray,E=Y.isObject,aJ=Y.isString,aE=Y.isBoolean,aR=aj.Array,U=function(A){return(A instanceof aj.DiagramBuilderBase);},aF=function(A){return(A instanceof aj.DiagramNode);},af=function(A){return(A instanceof aj.Anchor);},ap=function(A,aU){var aT=c(aU)?aU:aU.getXY();var aV=c(A)?A:A.getXY();return aR.map(aV,function(aX,aW){return Math.max(0,aX-aT[aW]);});},an="addAnchor",aM="addAnchorMessage",j="addNode",ar="anchor",ak="anchors",ae="anchorsDragConfig",Q="availableField",V="boolean",o="boundingBox",aN="builder",ac="cancel",ay="click",aK="closeEvent",B="closeMessage",ah="content",J="controls",aw="controlsToolbar",av="data",ad="dblclick",T="delete",al="deleteMessage",aB="description",C="diagram",ag="diagram-builder",aq="diagramNode",x="diagram-node",aC="dragNode",M="editing",y="editEvent",H="editMessage",a="esc",aD="field",q="fields",ao="fieldsDragConfig",p="hover",ax="id",N="keydown",ai="link",aa="max",t="maxSources",r="mouseenter",W="mouseleave",m="name",n="node",au="p1",at="p2",d="parentNode",l="pencil",ab="records",k="recordset",h="region",aO="rendered",F="required",aG="selected",G="shuffle",O="source",aH="sources",aI="string",i="target",I="targets",K="tmpConnector",e="type",L="viewport",aL="wrapper",v="xy",aQ="-",g=".",P="",f="#",D="_",u=aj.getClassName,R=u(C,aN,ar,n,aa,I),am=u(C,aN,ar,p),aA=u(C,aN,ar,n),z=u(C,aN,ar,n,aL),s=u(C,aN,J),X=u(C,n),b=u(C,n,ah),az=u(C,n,M),aP=u(C,n,aG);var Z=function(){var aT="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",A="<br/>";aj.all(".aui-diagram-node").each(function(aZ){var aU=P,aW=aj.Widget.getByNode(aZ),aV=aW.get("name"),aY=aW.get("boundingBox"),aX=aY.one(".log")||aj.Node.create("<div class=log />").appendTo(aY);aU+=aV+A;aW.get(q).each(function(a0){aU+=aT+"a: "+a0.get("id")+A;a0.get("targets").each(function(a1){var a2=a1.get(aq);a1.get("node").setContent(a1.get("id"));aU+=aT+aT+"t: "+a2.get("name")+" (s: "+a1.get("id")+")"+A;});a0.get("sources").each(function(a2){var a1=a2.get(aq);a2.get("node").setContent(a2.get("id"));aU+=aT+aT+"s: "+a1.get("name")+" (t: "+a2.get("id")+")"+A;});});aX.setContent(aU);});};var w=aj.Component.create({NAME:ag,ATTRS:{fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:E},tmpConnector:{setter:"_setTmpConnector",value:{},validator:E}},EXTENDS:aj.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editNode:null,initializer:function(){var A=this;A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});A.handlerKeyDown=aj.getDoc().on(N,aj.bind(A._afterKeyEvent,A));A.dropContainer.delegate(ay,aj.bind(A._onNodeClick,A),g+X);A.dropContainer.delegate(ad,aj.bind(A._onNodeEdit,A),g+X);A.dropContainer.delegate(r,aj.bind(A._onMouseenterAnchors,A),g+aA);A.dropContainer.delegate(W,aj.bind(A._onMouseleaveAnchors,A),g+aA);},syncUI:function(){var A=this;aj.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.tmpConnector=new aj.Connector(A.get(K));},connect:function(aU,aW){var aT=this;if(aJ(aU)){aU=aj.Widget.getByNode(f+aj.DiagramNode.buildNodeId(aU));}if(aJ(aW)){aW=aj.Widget.getByNode(f+aj.DiagramNode.buildNodeId(aW));}if(aU&&aW){var aV=aU.findAvailableAnchor();var A=aW.findAvailableAnchor();if(aV&&A){aV.connect(A);}}return aT;},connectAll:function(aT){var A=this;aR.each(aT,function(aU){if(aU.hasOwnProperty(O)&&aU.hasOwnProperty(i)){A.connect(aU.source,aU.target);}});return A;},createField:function(aT){var A=this;if(!aF(aT)){aT.builder=A;aT.viewport=A.get(L);aT=new (A.getFieldClass(aT.type||n))(aT);}aT.set(aN,A);return aT;},getFieldClass:function(aU){var A=this;var aT=aj.DiagramBuilder.types[aU];if(aT){return aT;}else{aj.log("The field type: ["+aU+"] couldn't be found.");return null;}},isFieldsDrag:function(aU){var A=this;var aT=A.fieldsDrag;return(aU===aT.dd);},plotField:function(aT){var A=this;if(!aT.get(aO)){aT.render(A.dropContainer);}},unselectAll:function(){var A=this;var aT=A.selectedNode;if(aT){aT.set(aG,false);}A.selectedNode=null;},select:function(aT){var A=this;A.unselectAll();A.selectedNode=aT.set(aG,true).focus();},startEditingNode:function(aT){var A=this;if(aT){A.stopEditingNode();A.tabView.selectTab(aj.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(k,aT.getProperties());aT.get(o).addClass(az);A.editNode=aT;}},stopEditingNode:function(aU){var A=this;var aT=aU||A.editNode;if(aT){A.tabView.selectTab(aj.DiagramBuilder.FIELDS_TAB);aT.get(o).removeClass(az);A.editNode=null;}},_afterKeyEvent:function(aT){var A=this;if(!A.selectedNode||aT.hasModifier()||!aT.isKeyInSet(a,T)){return;}if(aT.isKey(a)){A._onEscKey(aT);}else{if(aT.isKey(T)){A._onDeleteKey(aT);}}aT.halt();},_onCancel:function(aT){var A=this;A.stopEditingNode();},_onDrag:function(aU){var A=this;var aT=aU.target;if(A.isFieldsDrag(aT)){var aV=aj.Widget.getByNode(aT.get(aC));aV.get(q).each(function(aW){aW.alignConnectors();});}},_onDragEnd:function(aU){var A=this;var aT=aU.target;if(A.isFieldsDrag(aT)){var aV=aj.Widget.getByNode(aT.get(aC));aV.set(v,aV.getLeftTop());}},_onDropHit:function(aU){var A=this;var aT=aU.drag;if(A.isAvailableFieldsDrag(aT)){var aW=aT.get(n).getData(Q);var aV=A.addField({xy:ap(aT.lastXY,A.dropContainer),type:aW.get(e),fields:[{}]});A.select(aV);}},_onDeleteKey:function(aT){var A=this;var aU=A.selectedNode;if(!aU.get(F)){aU.close();}},_onEscKey:function(aT){var A=this;A.unselectAll();A.stopEditingNode();},_onMouseenterAnchors:function(aT){var A=this;aT.currentTarget.addClass(am);},_onMouseleaveAnchors:function(aT){var A=this;aT.currentTarget.removeClass(am);},_onNodeClick:function(aT){var A=this;var aU=aj.Widget.getByNode(aT.currentTarget);A.select(aU);},_onNodeEdit:function(aT){var A=this;if(!aT.target.ancestor(g+b,true)){return;}var aU=aj.Widget.getByNode(aT.currentTarget);if(aU){A.startEditingNode(aU);}},_onSave:function(aU){var A=this;var aT=A.editNode;var aV=A.propertyList.get(k);if(aT){aR.each(aV.get(ab),function(aW){var aX=aW.get(av);aT.set(aX.attributeName,aX.value);});A.stopEditingNode(aT);
}},_setTmpConnector:function(aT){var A=this;return aj.merge({lazyDraw:true,viewport:A.viewport},aT);},_setFieldsDragConfig:function(aU){var A=this;var aT=A.dropContainer;return aj.merge({bubbleTargets:A,container:aT,dragConfig:{plugins:[{cfg:{constrain:aT},fn:aj.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:aj.Plugin.DDWinScroll}]},nodes:g+X},aU||{});},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new aj.DD.Delegate(A.get(ao));}}});aj.DiagramBuilder=w;aj.DiagramBuilder.types={};var S=aj.Component.create({NAME:x,EXTENDS:aj.Overlay,AUGMENTS:[aj.FieldSupport]});var aS=aj.Component.create({NAME:x,UI_ATTRS:[q,m,F,aG],ATTRS:{anchorsDragConfig:{value:null,setter:"_setAnchorsDragConfig",validator:E},builder:{setter:"_setBuilder",validator:U},required:{value:false,validator:aE},description:{value:P,validator:aJ},height:{value:90},name:{valueFn:function(){var A=this;return A.get(e)+(++aj.Env._uidx);},validator:aJ},selected:{value:false,validator:aE},strings:{value:{addAnchorMessage:"Add Anchor",closeMessage:"Close",deleteMessage:"Are you sure you want to delete?",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},type:{value:n,validator:aJ},controlsToolbar:{validator:E,valueFn:"_valueControlsToolbar"},width:{value:90},zIndex:{value:100},tabIndex:{value:1}},EXTENDS:S,buildNodeId:function(A){return aq+D+aD+D+A;},prototype:{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+z+'"></div>',CONTROLS_TEMPLATE:'<div class="'+s+'"></div>',initializer:function(){var A=this;A._renderNodes();A._setupAnchorsDrag();A.after({render:A._afterRender});A.on({"drag:drag":A._onAnchorDrag,"drag:end":A._onAnchorDragEnd,"drag:start":A._onAnchorDragStart,"drop:hit":A._onAnchorDropHit});A.get(o).addClass(X+aQ+A.get(e));A.set("bodyContent",A.get(m));},alignAnchors:function(){var aT=this;var aX=aT.get(q);var aV=aT.get(o).get(h),aW=Math.floor(360/aX.size()),aU=aV.width/2,A=aV.height/2,aZ=aV.left+aV.width/2,aY=aV.top+aV.height/2;aX.each(function(a3,a2){var a1=a3.get(n);var a4=a1.get(h);var a0=aT._getEllipseXY(aU,A,aZ,aY,a2*aW);a1.setXY([a0[0]-a4.width/2,a0[1]-a4.height/2]);a3.alignConnectors();});return aT;},close:function(){var aT=this;var A=aT.getStrings();if(confirm(A[al])){aT.get(q).each(function(aU){aU.destroy();});aT.destroy();}Z();return aT;},createField:function(aU){var A=this;if(!af(aU)){var aT=A.get(aN);aU.diagramNode=A;aU.viewport=(aT?aT.get(L):null);aU=new aj.Anchor(aU);}return aU;},findAvailableAnchor:function(){var A=this;var aT=null;A.get(q).some(function(aU){if(!aU.hasConnection()){aT=aU;return true;}});if(!aT){aT=A.addField({});}return aT;},getConnectionNode:function(){var A=this;return new aj.DiagramNode({xy:[100,100]});},getLeftTop:function(){var A=this;return ap(A.get(o),A._getContainer());},getProperties:function(){var A=this;var aT=A.getPropertyModel();aR.each(aT,function(aW){var aV=A.get(aW.attributeName),aU=Y.type(aV);if(aU===V||aU===aI){aV=String(aV);}aW.value=aV;});return aT;},getPropertyModel:function(){var aT=this;var A=aT.getStrings();return[{attributeName:aB,editor:new aj.TextAreaCellEditor(),name:A[aB]},{attributeName:m,editor:new aj.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[m]},{attributeName:e,editor:false,name:A[e]}];},syncDragTargets:function(){var A=this;A.anchorsDrag.syncTargets();},syncDropTargets:function(aT){var A=this;A.get(q).each(function(aV){var aU=aj.DD.DDM.getDrop(aV.get(n));if(aU){if(aV.get(aH).size()===aV.get(t)){aU.removeFromGroup(ak);}else{aU.addToGroup(ak);}}});},_afterRender:function(aT){var A=this;A.alignAnchors();A._renderControls();},_getContainer:function(){var A=this;return(A.get(aN).dropContainer||A.get(o).get(d));},_getEllipseXY:function(aT,A,aW,aV,aX){var aU=aX*Math.PI/180;return[aW+aT*Math.cos(aU),aV-A*Math.sin(aU)];},_handleAddAnchorEvent:function(aT){var A=this;A.addField({});},_handleAddNodeEvent:function(aU){var A=this;var aT=A.get(aN);var aV=A.findAvailableAnchor();if(aV){var aW=A.getConnectionNode();aT.addField(aW);aV.connect(aW.addField({}));}},_handleEditEvent:function(aT){var A=this;A.get(aN).startEditingNode(A);},_handleCloseEvent:function(aT){var A=this;if(!A.get(F)){A.close();}},_onAnchorDrag:function(aU){var A=this;var aT=A.get(aN);aT.tmpConnector.set(at,aU.target.get(aC).getCenterXY());},_onAnchorDragEnd:function(aU){var A=this;var aT=A.get(aN).tmpConnector.shape;aT.clear();aT.end();},_onAnchorDragStart:function(aU){var A=this;var aT=A.get(aN);aT.tmpConnector.set(au,aU.target.get(n).getCenterXY());},_onAnchorDropHit:function(aT){var A=this;var aU=aj.Anchor.getAnchorByNode(aT.drag.get(n));var aV=aj.Anchor.getAnchorByNode(aT.drop.get(n));aU.connect(aV);Z();},_renderControls:function(){var A=this;var aT=A.get(o);A.controlsNode=aj.Node.create(A.CONTROLS_TEMPLATE).appendTo(aT);},_renderNodes:function(){var A=this;var aT=A.get(o);A.anchorWrapper=aj.Node.create(A.ANCHOR_WRAPPER_TEMPLATE).appendTo(aT);},_renderControlsToolbar:function(aT){var A=this;A.controlsToolbar=new aj.Toolbar(A.get(aw)).render(A.controlsNode);A._uiSetRequired(A.get(F));},_setBuilder:function(aT){var A=this;A.get(q).each(function(aU){aU.set(L,aT.get(L));});return aT;},_setAnchorsDragConfig:function(aU){var A=this;var aT=A.get(aN);return aj.merge({bubbleTargets:A,container:A.anchorWrapper,dragConfig:{groups:[ak],plugins:[{cfg:{constrain:(aT?aT.get(L):null)},fn:aj.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:aj.Plugin.DDWinScroll},{cfg:{moveOnEnd:false},fn:aj.Plugin.DDProxy}]},nodes:g+aA,target:true},aU||{});},_setupAnchorsDrag:function(){var A=this;A.anchorsDrag=new aj.DD.Delegate(A.get(ae));A.anchorsDrag.dd.addInvalid(g+R);},_uiSetFields:function(aT){var A=this;if(A.get(aO)){A.alignAnchors();A.syncDragTargets();A.syncDropTargets();}},_uiSetName:function(aU){var A=this;var aT=A.get(o);aT.set(ax,aj.DiagramNode.buildNodeId(aU));},_uiSetRequired:function(aV){var aU=this;var aT=aU.getStrings();var A=aU.controlsToolbar;if(A){if(aV){A.remove(aK);}else{A.add({handler:aj.bind(aU._handleCloseEvent,aU),icon:ac,id:aK,title:aT[B]});}}},_uiSetSelected:function(aT){var A=this;
A.get(o).toggleClass(aP,aT);if(aT&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(aU){var A=this;var aT=A._getContainer().getXY();this._posNode.setXY([aU[0]+aT[0],aU[1]+aT[1]]);},_valueControlsToolbar:function(aU){var aT=this;var A=aT.getStrings();return{activeState:false,children:[{handler:aj.bind(aT._handleEditEvent,aT),icon:l,id:y,title:A[H]},{handler:aj.bind(aT._handleAddAnchorEvent,aT),icon:ai,id:an,title:A[aM]},{handler:aj.bind(aT._handleAddNodeEvent,aT),icon:G,id:j},{handler:aj.bind(aT._handleCloseEvent,aT),icon:ac,id:aK,title:A[B]}]};}}});aj.DiagramNode=aS;aj.DiagramBuilder.types[n]=aj.DiagramNode;},"@VERSION@",{requires:["aui-diagram-builder-base","overlay"],skinnable:true});