AUI.add("aui-diagram-builder-impl",function(al){var Z=al.Lang,c=Z.isArray,F=Z.isObject,aL=Z.isString,aG=Z.isBoolean,aT=al.Array,U=function(A){return(A instanceof al.DiagramBuilderBase);},aH=function(A){return(A instanceof al.DiagramNode);},ah=function(A){return(A instanceof al.Anchor);},aq=function(A,aW){var aV=c(aW)?aW:aW.getXY();var aX=c(A)?A:A.getXY();return aT.map(aX,function(aZ,aY){return Math.max(0,aZ-aV[aY]);});},ao="addAnchor",aO="addAnchorMessage",j="addNode",at="anchor",am="anchors",ag="anchorsDragConfig",Q="availableField",W="boolean",p="boundingBox",aP="builder",ad="cancel",ae="canvas",aA="click",aM="closeEvent",C="closeMessage",aj="content",K="controls",ay="controlsToolbar",ax="data",af="dblclick",T="delete",aw="deleteConnectorsMessage",n="deleteNodesMessage",aD="description",D="diagram",ai="diagram-builder",ar="diagramNode",y="diagram-node",aE="dragNode",M="editing",z="editEvent",I="editMessage",a="esc",aF="field",r="fields",ap="fieldsDragConfig",V="graphic",q="hover",az="id",N="keydown",ak="link",ab="max",u="maxSources",s="mouseenter",X="mouseleave",m="name",o="node",av="p1",au="p2",d="parentNode",l="pencil",ac="records",k="recordset",h="region",aQ="rendered",G="required",aI="selected",H="shuffle",O="source",aJ="sources",aK="string",i="target",J="targets",L="tmpConnector",e="type",aN="wrapper",w="xy",aS="-",g=".",P="",f="#",E="_",v=al.getClassName,R=v(D,aP,at,o,ab,J),an=v(D,aP,at,q),aC=v(D,aP,at,o),B=v(D,aP,at,o,aN),t=v(D,aP,K),Y=v(D,o),b=v(D,o,aj),aB=v(D,o,M),aR=v(D,o,aI);var aa=function(){var aV="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",A="<br/>";al.all(".aui-diagram-node").each(function(a1){var aW=P,aY=al.Widget.getByNode(a1),aX=aY.get("name"),a0=aY.get("boundingBox"),aZ=a0.one(".log")||al.Node.create("<div class=log />").appendTo(a0);aW+=aX+A;aY.get(r).each(function(a2){aW+=aV+"a: "+a2.get("id")+A;a2.get("targets").each(function(a3){var a4=a3.get(ar);a3.get("node").setContent(a3.get("id"));aW+=aV+aV+"t: "+a4.get("name")+" (s: "+a3.get("id")+")"+A;});a2.get("sources").each(function(a4){var a3=a4.get(ar);a4.get("node").setContent(a4.get("id"));aW+=aV+aV+"s: "+a3.get("name")+" (t: "+a4.get("id")+")"+A;});});aZ.setContent(aW);});};var x=al.Component.create({NAME:ai,ATTRS:{fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:F},graphic:{valueFn:function(){return new al.Graphic();},validator:F},strings:{value:{deleteConnectorsMessage:"Are you sure you want to delete the selected connector(s)?"}},tmpConnector:{setter:"_setTmpConnector",value:{},validator:F}},EXTENDS:al.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editNode:null,initializer:function(){var A=this;A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});A.handlerKeyDown=al.getDoc().on(N,al.bind(A._afterKeyEvent,A));A.dropContainer.delegate(aA,al.bind(A._onNodeClick,A),g+Y);A.dropContainer.delegate(af,al.bind(A._onNodeEdit,A),g+Y);A.dropContainer.delegate(s,al.bind(A._onMouseenterAnchors,A),g+aC);A.dropContainer.delegate(X,al.bind(A._onMouseleaveAnchors,A),g+aC);},renderUI:function(){var A=this;al.DiagramBuilder.superclass.renderUI.apply(this,arguments);A._renderGraphic();},syncUI:function(){var A=this;al.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.tmpConnector=new al.Connector(A.get(L));},connect:function(aW,aY){var aV=this;if(aL(aW)){aW=al.Widget.getByNode(f+al.DiagramNode.buildNodeId(aW));}if(aL(aY)){aY=al.Widget.getByNode(f+al.DiagramNode.buildNodeId(aY));}if(aW&&aY){var aX=aW.findAvailableAnchor();var A=aY.findAvailableAnchor();if(aX&&A){aX.connect(A);}}return aV;},connectAll:function(aV){var A=this;aT.each(aV,function(aW){if(aW.hasOwnProperty(O)&&aW.hasOwnProperty(i)){A.connect(aW.source,aW.target);}});return A;},createField:function(aV){var A=this;if(!aH(aV)){aV.builder=A;aV=new (A.getFieldClass(aV.type||o))(aV);}aV.set(aP,A);return aV;},deleteConnectors:function(aV){var A=this;aT.each(aV,function(aW){var aX=aW.get(at);if(aX){var aY=aX.findConnectorTarget(aW);if(aY){aX.disconnect(aY);}}});},eachConnetor:function(aW){var A=this;var aV=false;A.get(r).some(function(aX){aX.get(r).some(function(aY){al.some(aY.connectors,function(aZ){aV=aW.call(A,aZ,aY,aX);return aV;});return aV;});return aV;});},getSelectedConnectors:function(){var A=this;var aV=[];A.eachConnetor(function(aW){if(aW.get(aI)){aV.push(aW);}});return aV;},getFieldClass:function(aW){var A=this;var aV=al.DiagramBuilder.types[aW];if(aV){return aV;}else{al.log("The field type: ["+aW+"] couldn't be found.");return null;}},isFieldsDrag:function(aW){var A=this;var aV=A.fieldsDrag;return(aW===aV.dd);},plotField:function(aV){var A=this;if(!aV.get(aQ)){aV.render(A.dropContainer);}},unselectConnectors:function(){var A=this;aT.each(A.getSelectedConnectors(),function(aV){aV.set(aI,false);});},unselectFields:function(){var A=this;var aV=A.selectedNode;if(aV){aV.set(aI,false);}A.selectedNode=null;},select:function(aV){var A=this;A.unselectFields();A.selectedNode=aV.set(aI,true).focus();},startEditingNode:function(aV){var A=this;if(aV){A.stopEditingNode();A.tabView.selectTab(al.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(k,aV.getProperties());aV.get(p).addClass(aB);A.editNode=aV;}},stopEditingNode:function(aW){var A=this;var aV=aW||A.editNode;if(aV){A.tabView.selectTab(al.DiagramBuilder.FIELDS_TAB);aV.get(p).removeClass(aB);A.editNode=null;}},_afterKeyEvent:function(aV){var A=this;if(aV.hasModifier()){return;}if(aV.isKey(a)){A._onEscKey(aV);}else{if(aV.isKey(T)){A._onDeleteKey(aV);}}},_onCancel:function(aV){var A=this;A.stopEditingNode();},_onDrag:function(aW){var A=this;var aV=aW.target;if(A.isFieldsDrag(aV)){var aX=al.Widget.getByNode(aV.get(aE));aX.get(r).each(function(aY){aY.alignConnectors();});}},_onDragEnd:function(aW){var A=this;var aV=aW.target;if(A.isFieldsDrag(aV)){var aX=al.Widget.getByNode(aV.get(aE));aX.set(w,aX.getLeftTop());}},_onDropHit:function(aW){var A=this;var aV=aW.drag;if(A.isAvailableFieldsDrag(aV)){var aY=aV.get(o).getData(Q);
var aX=A.addField({xy:aq(aV.lastXY,A.dropContainer),type:aY.get(e),fields:[{}]});A.select(aX);}},_onDeleteKey:function(aX){var aV=this;var A=aV.getStrings();var aW=aV.getSelectedConnectors();if(aW.length&&confirm(A[aw])){aV.deleteConnectors(aW);}var aY=aV.selectedNode;if(aY){if(!aY.get(G)){aY.close();}}aX.halt();},_onEscKey:function(aV){var A=this;A.unselectConnectors();A.unselectFields();A.stopEditingNode();aV.halt();},_onMouseenterAnchors:function(aV){var A=this;aV.currentTarget.addClass(an);},_onMouseleaveAnchors:function(aV){var A=this;aV.currentTarget.removeClass(an);},_onNodeClick:function(aV){var A=this;var aW=al.Widget.getByNode(aV.currentTarget);A.select(aW);},_onNodeEdit:function(aV){var A=this;if(!aV.target.ancestor(g+b,true)){return;}var aW=al.Widget.getByNode(aV.currentTarget);if(aW){A.startEditingNode(aW);}},_onSave:function(aW){var A=this;var aV=A.editNode;var aX=A.propertyList.get(k);if(aV){aT.each(aX.get(ac),function(aY){var aZ=aY.get(ax);aV.set(aZ.attributeName,aZ.value);});A.stopEditingNode(aV);}},_renderGraphic:function(){var A=this;A.get(V).render(A.get(ae));},_setTmpConnector:function(aV){var A=this;return al.merge({lazyDraw:true,graphic:A.get(V)},aV);},_setFieldsDragConfig:function(aW){var A=this;var aV=A.dropContainer;return al.merge({bubbleTargets:A,container:aV,dragConfig:{plugins:[{cfg:{constrain:aV},fn:al.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:al.Plugin.DDWinScroll}]},nodes:g+Y},aW||{});},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new al.DD.Delegate(A.get(ap));}}});al.DiagramBuilder=x;al.DiagramBuilder.types={};var S=al.Component.create({NAME:y,EXTENDS:al.Overlay,AUGMENTS:[al.FieldSupport]});var aU=al.Component.create({NAME:y,UI_ATTRS:[r,m,G,aI],ATTRS:{anchorsDragConfig:{value:null,setter:"_setAnchorsDragConfig",validator:F},builder:{validator:U},required:{value:false,validator:aG},description:{value:P,validator:aL},height:{value:90},name:{valueFn:function(){var A=this;return A.get(e)+(++al.Env._uidx);},validator:aL},selected:{value:false,validator:aG},strings:{value:{addAnchorMessage:"Add Anchor",closeMessage:"Close",deleteNodesMessage:"Are you sure you want to delete the selected node(s)?",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},type:{value:o,validator:aL},controlsToolbar:{validator:F,valueFn:"_valueControlsToolbar"},width:{value:90},zIndex:{value:100},tabIndex:{value:1}},EXTENDS:S,buildNodeId:function(A){return ar+E+aF+E+A;},prototype:{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+B+'"></div>',CONTROLS_TEMPLATE:'<div class="'+t+'"></div>',initializer:function(){var A=this;A._renderNodes();A._setupAnchorsDrag();A.after({render:A._afterRender});A.on({"drag:drag":A._onAnchorDrag,"drag:end":A._onAnchorDragEnd,"drag:start":A._onAnchorDragStart,"drop:hit":A._onAnchorDropHit});A.get(p).addClass(Y+aS+A.get(e));A.set("bodyContent",A.get(m));},alignAnchors:function(){var aV=this;var aZ=aV.get(r);var aX=aV.get(p).get(h),aY=Math.floor(360/aZ.size()),aW=aX.width/2,A=aX.height/2,a1=aX.left+aX.width/2,a0=aX.top+aX.height/2;aZ.each(function(a5,a4){var a3=a5.get(o);var a6=a3.get(h);var a2=aV._getEllipseXY(aW,A,a1,a0,a4*aY);a3.setXY([a2[0]-a6.width/2,a2[1]-a6.height/2]);a5.alignConnectors();});return aV;},close:function(){var aV=this;var A=aV.getStrings();if(confirm(A[n])){aV.get(r).each(function(aW){aW.destroy();});aV.destroy();}return aV;},createField:function(aW){var A=this;if(!ah(aW)){var aV=A.get(aP);aW.diagramNode=A;aW=new al.Anchor(aW);}return aW;},findAvailableAnchor:function(){var A=this;var aV=null;A.get(r).some(function(aW){if(!aW.hasConnection()){aV=aW;return true;}});if(!aV){aV=A.addField({});}return aV;},getConnectionNode:function(){var A=this;return new al.DiagramNode({xy:[100,100]});},getLeftTop:function(){var A=this;return aq(A.get(p),A._getContainer());},getProperties:function(){var A=this;var aV=A.getPropertyModel();aT.each(aV,function(aY){var aX=A.get(aY.attributeName),aW=Z.type(aX);if(aW===W||aW===aK){aX=String(aX);}aY.value=aX;});return aV;},getPropertyModel:function(){var aV=this;var A=aV.getStrings();return[{attributeName:aD,editor:new al.TextAreaCellEditor(),name:A[aD]},{attributeName:m,editor:new al.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[m]},{attributeName:e,editor:false,name:A[e]}];},syncDragTargets:function(){var A=this;A.anchorsDrag.syncTargets();},syncDropTargets:function(aV){var A=this;A.get(r).each(function(aX){var aW=al.DD.DDM.getDrop(aX.get(o));if(aW){if(aX.get(aJ).size()===aX.get(u)){aW.removeFromGroup(am);}else{aW.addToGroup(am);}}});},_afterRender:function(aV){var A=this;A.alignAnchors();A._renderControls();},_getContainer:function(){var A=this;return(A.get(aP).dropContainer||A.get(p).get(d));},_getEllipseXY:function(aV,A,aY,aX,aZ){var aW=aZ*Math.PI/180;return[aY+aV*Math.cos(aW),aX-A*Math.sin(aW)];},_handleAddAnchorEvent:function(aV){var A=this;A.addField({});},_handleAddNodeEvent:function(aW){var A=this;var aV=A.get(aP);var aX=A.findAvailableAnchor();if(aX){var aY=A.getConnectionNode();aV.addField(aY);aX.connect(aY.addField({}));}},_handleEditEvent:function(aV){var A=this;A.get(aP).startEditingNode(A);},_handleCloseEvent:function(aV){var A=this;if(!A.get(G)){A.close();}},_onAnchorDrag:function(aW){var A=this;var aV=A.get(aP);aV.tmpConnector.set(au,aW.target.get(aE).getCenterXY());},_onAnchorDragEnd:function(aW){var A=this;var aV=A.get(aP).tmpConnector.shape;aV.clear();aV.end();},_onAnchorDragStart:function(aW){var A=this;var aV=A.get(aP);aV.tmpConnector.set(av,aW.target.get(o).getCenterXY());},_onAnchorDropHit:function(aV){var A=this;var aW=al.Anchor.getAnchorByNode(aV.drag.get(o));var aX=al.Anchor.getAnchorByNode(aV.drop.get(o));aW.connect(aX);aa();},_renderControls:function(){var A=this;var aV=A.get(p);A.controlsNode=al.Node.create(A.CONTROLS_TEMPLATE).appendTo(aV);},_renderNodes:function(){var A=this;var aV=A.get(p);A.anchorWrapper=al.Node.create(A.ANCHOR_WRAPPER_TEMPLATE).appendTo(aV);},_renderControlsToolbar:function(aV){var A=this;A.controlsToolbar=new al.Toolbar(A.get(ay)).render(A.controlsNode);
A._uiSetRequired(A.get(G));},_setAnchorsDragConfig:function(aW){var A=this;var aV=A.get(aP);return al.merge({bubbleTargets:A,container:A.anchorWrapper,dragConfig:{groups:[am],plugins:[{cfg:{constrain:(aV?aV.get(ae):null)},fn:al.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:al.Plugin.DDWinScroll},{cfg:{moveOnEnd:false},fn:al.Plugin.DDProxy}]},nodes:g+aC,target:true},aW||{});},_setupAnchorsDrag:function(){var A=this;A.anchorsDrag=new al.DD.Delegate(A.get(ag));A.anchorsDrag.dd.addInvalid(g+R);},_uiSetFields:function(aV){var A=this;if(A.get(aQ)){A.alignAnchors();A.syncDragTargets();A.syncDropTargets();}},_uiSetName:function(aW){var A=this;var aV=A.get(p);aV.set(az,al.DiagramNode.buildNodeId(aW));},_uiSetRequired:function(aX){var aW=this;var aV=aW.getStrings();var A=aW.controlsToolbar;if(A){if(aX){A.remove(aM);}else{A.add({handler:al.bind(aW._handleCloseEvent,aW),icon:ad,id:aM,title:aV[C]});}}},_uiSetSelected:function(aV){var A=this;A.get(p).toggleClass(aR,aV);if(aV&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(aW){var A=this;var aV=A._getContainer().getXY();this._posNode.setXY([aW[0]+aV[0],aW[1]+aV[1]]);},_valueControlsToolbar:function(aW){var aV=this;var A=aV.getStrings();return{activeState:false,children:[{handler:al.bind(aV._handleEditEvent,aV),icon:l,id:z,title:A[I]},{handler:al.bind(aV._handleAddAnchorEvent,aV),icon:ak,id:ao,title:A[aO]},{handler:al.bind(aV._handleAddNodeEvent,aV),icon:H,id:j},{handler:al.bind(aV._handleCloseEvent,aV),icon:ad,id:aM,title:A[C]}]};}}});al.DiagramNode=aU;al.DiagramBuilder.types[o]=al.DiagramNode;},"@VERSION@",{requires:["aui-diagram-builder-base","overlay"],skinnable:true});