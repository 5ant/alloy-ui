AUI.add("aui-diagram-builder-impl",function(ak){var Y=ak.Lang,c=Y.isArray,E=Y.isObject,aK=Y.isString,aF=Y.isBoolean,aS=ak.Array,T=function(A){return(A instanceof ak.DiagramBuilderBase);},aG=function(A){return(A instanceof ak.DiagramNode);},ag=function(A){return(A instanceof ak.Anchor);},aq=function(A,aV){var aU=c(aV)?aV:aV.getXY();var aW=c(A)?A:A.getXY();return aS.map(aW,function(aY,aX){return Math.max(0,aY-aU[aX]);});},ao="addAnchor",aN="addAnchorMessage",j="addNode",at="anchor",al="anchors",af="anchorsDragConfig",P="availableField",V="boolean",o="boundingBox",aO="builder",ac="cancel",ad="canvas",az="click",aL="closeEvent",B="closeMessage",ai="content",J="controls",ax="controlsToolbar",aw="data",ae="dblclick",S="delete",am="deleteMessage",aC="description",C="diagram",ah="diagram-builder",ar="diagramNode",x="diagram-node",aD="dragNode",L="editing",y="editEvent",H="editMessage",a="esc",aE="field",q="fields",ap="fieldsDragConfig",U="graphic",p="hover",ay="id",M="keydown",aj="link",aa="max",t="maxSources",r="mouseenter",W="mouseleave",m="name",n="node",av="p1",au="p2",d="parentNode",l="pencil",ab="records",k="recordset",h="region",aP="rendered",F="required",aH="selected",G="shuffle",N="source",aI="sources",aJ="string",i="target",I="targets",K="tmpConnector",e="type",aM="wrapper",v="xy",aR="-",g=".",O="",f="#",D="_",u=ak.getClassName,Q=u(C,aO,at,n,aa,I),an=u(C,aO,at,p),aB=u(C,aO,at,n),z=u(C,aO,at,n,aM),s=u(C,aO,J),X=u(C,n),b=u(C,n,ai),aA=u(C,n,L),aQ=u(C,n,aH);var Z=function(){var aU="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",A="<br/>";ak.all(".aui-diagram-node").each(function(a0){var aV=O,aX=ak.Widget.getByNode(a0),aW=aX.get("name"),aZ=aX.get("boundingBox"),aY=aZ.one(".log")||ak.Node.create("<div class=log />").appendTo(aZ);aV+=aW+A;aX.get(q).each(function(a1){aV+=aU+"a: "+a1.get("id")+A;a1.get("targets").each(function(a2){var a3=a2.get(ar);a2.get("node").setContent(a2.get("id"));aV+=aU+aU+"t: "+a3.get("name")+" (s: "+a2.get("id")+")"+A;});a1.get("sources").each(function(a3){var a2=a3.get(ar);a3.get("node").setContent(a3.get("id"));aV+=aU+aU+"s: "+a2.get("name")+" (t: "+a3.get("id")+")"+A;});});aY.setContent(aV);});};var w=ak.Component.create({NAME:ah,ATTRS:{fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:E},graphic:{valueFn:function(){return new ak.Graphic();},validator:E},tmpConnector:{setter:"_setTmpConnector",value:{},validator:E}},EXTENDS:ak.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editNode:null,initializer:function(){var A=this;A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});A.handlerKeyDown=ak.getDoc().on(M,ak.bind(A._afterKeyEvent,A));A.dropContainer.delegate(az,ak.bind(A._onNodeClick,A),g+X);A.dropContainer.delegate(ae,ak.bind(A._onNodeEdit,A),g+X);A.dropContainer.delegate(r,ak.bind(A._onMouseenterAnchors,A),g+aB);A.dropContainer.delegate(W,ak.bind(A._onMouseleaveAnchors,A),g+aB);},renderUI:function(){var A=this;ak.DiagramBuilder.superclass.renderUI.apply(this,arguments);A._renderGraphic();},syncUI:function(){var A=this;ak.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.tmpConnector=new ak.Connector(A.get(K));},connect:function(aV,aX){var aU=this;if(aK(aV)){aV=ak.Widget.getByNode(f+ak.DiagramNode.buildNodeId(aV));}if(aK(aX)){aX=ak.Widget.getByNode(f+ak.DiagramNode.buildNodeId(aX));}if(aV&&aX){var aW=aV.findAvailableAnchor();var A=aX.findAvailableAnchor();if(aW&&A){aW.connect(A);}}return aU;},connectAll:function(aU){var A=this;aS.each(aU,function(aV){if(aV.hasOwnProperty(N)&&aV.hasOwnProperty(i)){A.connect(aV.source,aV.target);}});return A;},createField:function(aU){var A=this;if(!aG(aU)){aU.builder=A;aU=new (A.getFieldClass(aU.type||n))(aU);}aU.set(aO,A);return aU;},getFieldClass:function(aV){var A=this;var aU=ak.DiagramBuilder.types[aV];if(aU){return aU;}else{ak.log("The field type: ["+aV+"] couldn't be found.");return null;}},isFieldsDrag:function(aV){var A=this;var aU=A.fieldsDrag;return(aV===aU.dd);},plotField:function(aU){var A=this;if(!aU.get(aP)){aU.render(A.dropContainer);}},unselectAll:function(){var A=this;var aU=A.selectedNode;if(aU){aU.set(aH,false);}A.selectedNode=null;},select:function(aU){var A=this;A.unselectAll();A.selectedNode=aU.set(aH,true).focus();},startEditingNode:function(aU){var A=this;if(aU){A.stopEditingNode();A.tabView.selectTab(ak.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(k,aU.getProperties());aU.get(o).addClass(aA);A.editNode=aU;}},stopEditingNode:function(aV){var A=this;var aU=aV||A.editNode;if(aU){A.tabView.selectTab(ak.DiagramBuilder.FIELDS_TAB);aU.get(o).removeClass(aA);A.editNode=null;}},_afterKeyEvent:function(aU){var A=this;if(!A.selectedNode||aU.hasModifier()||!aU.isKeyInSet(a,S)){return;}if(aU.isKey(a)){A._onEscKey(aU);}else{if(aU.isKey(S)){A._onDeleteKey(aU);}}aU.halt();},_onCancel:function(aU){var A=this;A.stopEditingNode();},_onDrag:function(aV){var A=this;var aU=aV.target;if(A.isFieldsDrag(aU)){var aW=ak.Widget.getByNode(aU.get(aD));aW.get(q).each(function(aX){aX.alignConnectors();});}},_onDragEnd:function(aV){var A=this;var aU=aV.target;if(A.isFieldsDrag(aU)){var aW=ak.Widget.getByNode(aU.get(aD));aW.set(v,aW.getLeftTop());}},_onDropHit:function(aV){var A=this;var aU=aV.drag;if(A.isAvailableFieldsDrag(aU)){var aX=aU.get(n).getData(P);var aW=A.addField({xy:aq(aU.lastXY,A.dropContainer),type:aX.get(e),fields:[{}]});A.select(aW);}},_onDeleteKey:function(aU){var A=this;var aV=A.selectedNode;if(!aV.get(F)){aV.close();}},_onEscKey:function(aU){var A=this;A.unselectAll();A.stopEditingNode();},_onMouseenterAnchors:function(aU){var A=this;aU.currentTarget.addClass(an);},_onMouseleaveAnchors:function(aU){var A=this;aU.currentTarget.removeClass(an);},_onNodeClick:function(aU){var A=this;var aV=ak.Widget.getByNode(aU.currentTarget);A.select(aV);},_onNodeEdit:function(aU){var A=this;if(!aU.target.ancestor(g+b,true)){return;}var aV=ak.Widget.getByNode(aU.currentTarget);if(aV){A.startEditingNode(aV);}},_onSave:function(aV){var A=this;
var aU=A.editNode;var aW=A.propertyList.get(k);if(aU){aS.each(aW.get(ab),function(aX){var aY=aX.get(aw);aU.set(aY.attributeName,aY.value);});A.stopEditingNode(aU);}},_renderGraphic:function(){var A=this;A.get(U).render(A.get(ad));},_setTmpConnector:function(aU){var A=this;return ak.merge({lazyDraw:true,graphic:A.get(U)},aU);},_setFieldsDragConfig:function(aV){var A=this;var aU=A.dropContainer;return ak.merge({bubbleTargets:A,container:aU,dragConfig:{plugins:[{cfg:{constrain:aU},fn:ak.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:ak.Plugin.DDWinScroll}]},nodes:g+X},aV||{});},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new ak.DD.Delegate(A.get(ap));}}});ak.DiagramBuilder=w;ak.DiagramBuilder.types={};var R=ak.Component.create({NAME:x,EXTENDS:ak.Overlay,AUGMENTS:[ak.FieldSupport]});var aT=ak.Component.create({NAME:x,UI_ATTRS:[q,m,F,aH],ATTRS:{anchorsDragConfig:{value:null,setter:"_setAnchorsDragConfig",validator:E},builder:{setter:"_setBuilder",validator:T},required:{value:false,validator:aF},description:{value:O,validator:aK},height:{value:90},name:{valueFn:function(){var A=this;return A.get(e)+(++ak.Env._uidx);},validator:aK},selected:{value:false,validator:aF},strings:{value:{addAnchorMessage:"Add Anchor",closeMessage:"Close",deleteMessage:"Are you sure you want to delete?",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},type:{value:n,validator:aK},controlsToolbar:{validator:E,valueFn:"_valueControlsToolbar"},width:{value:90},zIndex:{value:100},tabIndex:{value:1}},EXTENDS:R,buildNodeId:function(A){return ar+D+aE+D+A;},prototype:{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+z+'"></div>',CONTROLS_TEMPLATE:'<div class="'+s+'"></div>',initializer:function(){var A=this;A._renderNodes();A._setupAnchorsDrag();A.after({render:A._afterRender});A.on({"drag:drag":A._onAnchorDrag,"drag:end":A._onAnchorDragEnd,"drag:start":A._onAnchorDragStart,"drop:hit":A._onAnchorDropHit});A.get(o).addClass(X+aR+A.get(e));A.set("bodyContent",A.get(m));},alignAnchors:function(){var aU=this;var aY=aU.get(q);var aW=aU.get(o).get(h),aX=Math.floor(360/aY.size()),aV=aW.width/2,A=aW.height/2,a0=aW.left+aW.width/2,aZ=aW.top+aW.height/2;aY.each(function(a4,a3){var a2=a4.get(n);var a5=a2.get(h);var a1=aU._getEllipseXY(aV,A,a0,aZ,a3*aX);a2.setXY([a1[0]-a5.width/2,a1[1]-a5.height/2]);a4.alignConnectors();});return aU;},close:function(){var aU=this;var A=aU.getStrings();if(confirm(A[am])){aU.get(q).each(function(aV){aV.destroy();});aU.destroy();}Z();return aU;},createField:function(aV){var A=this;if(!ag(aV)){var aU=A.get(aO);aV.diagramNode=A;aV.graphic=(aU?aU.get(U):null);aV=new ak.Anchor(aV);}return aV;},findAvailableAnchor:function(){var A=this;var aU=null;A.get(q).some(function(aV){if(!aV.hasConnection()){aU=aV;return true;}});if(!aU){aU=A.addField({});}return aU;},getConnectionNode:function(){var A=this;return new ak.DiagramNode({xy:[100,100]});},getLeftTop:function(){var A=this;return aq(A.get(o),A._getContainer());},getProperties:function(){var A=this;var aU=A.getPropertyModel();aS.each(aU,function(aX){var aW=A.get(aX.attributeName),aV=Y.type(aW);if(aV===V||aV===aJ){aW=String(aW);}aX.value=aW;});return aU;},getPropertyModel:function(){var aU=this;var A=aU.getStrings();return[{attributeName:aC,editor:new ak.TextAreaCellEditor(),name:A[aC]},{attributeName:m,editor:new ak.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[m]},{attributeName:e,editor:false,name:A[e]}];},syncDragTargets:function(){var A=this;A.anchorsDrag.syncTargets();},syncDropTargets:function(aU){var A=this;A.get(q).each(function(aW){var aV=ak.DD.DDM.getDrop(aW.get(n));if(aV){if(aW.get(aI).size()===aW.get(t)){aV.removeFromGroup(al);}else{aV.addToGroup(al);}}});},_afterRender:function(aU){var A=this;A.alignAnchors();A._renderControls();},_getContainer:function(){var A=this;return(A.get(aO).dropContainer||A.get(o).get(d));},_getEllipseXY:function(aU,A,aX,aW,aY){var aV=aY*Math.PI/180;return[aX+aU*Math.cos(aV),aW-A*Math.sin(aV)];},_handleAddAnchorEvent:function(aU){var A=this;A.addField({});},_handleAddNodeEvent:function(aV){var A=this;var aU=A.get(aO);var aW=A.findAvailableAnchor();if(aW){var aX=A.getConnectionNode();aU.addField(aX);aW.connect(aX.addField({}));}},_handleEditEvent:function(aU){var A=this;A.get(aO).startEditingNode(A);},_handleCloseEvent:function(aU){var A=this;if(!A.get(F)){A.close();}},_onAnchorDrag:function(aV){var A=this;var aU=A.get(aO);aU.tmpConnector.set(au,aV.target.get(aD).getCenterXY());},_onAnchorDragEnd:function(aV){var A=this;var aU=A.get(aO).tmpConnector.shape;aU.clear();aU.end();},_onAnchorDragStart:function(aV){var A=this;var aU=A.get(aO);aU.tmpConnector.set(av,aV.target.get(n).getCenterXY());},_onAnchorDropHit:function(aU){var A=this;var aV=ak.Anchor.getAnchorByNode(aU.drag.get(n));var aW=ak.Anchor.getAnchorByNode(aU.drop.get(n));aV.connect(aW);Z();},_renderControls:function(){var A=this;var aU=A.get(o);A.controlsNode=ak.Node.create(A.CONTROLS_TEMPLATE).appendTo(aU);},_renderNodes:function(){var A=this;var aU=A.get(o);A.anchorWrapper=ak.Node.create(A.ANCHOR_WRAPPER_TEMPLATE).appendTo(aU);},_renderControlsToolbar:function(aU){var A=this;A.controlsToolbar=new ak.Toolbar(A.get(ax)).render(A.controlsNode);A._uiSetRequired(A.get(F));},_setBuilder:function(aU){var A=this;A.get(q).each(function(aV){aV.set(U,aU.get(U));});return aU;},_setAnchorsDragConfig:function(aV){var A=this;var aU=A.get(aO);return ak.merge({bubbleTargets:A,container:A.anchorWrapper,dragConfig:{groups:[al],plugins:[{cfg:{constrain:(aU?aU.get(ad):null)},fn:ak.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:ak.Plugin.DDWinScroll},{cfg:{moveOnEnd:false},fn:ak.Plugin.DDProxy}]},nodes:g+aB,target:true},aV||{});},_setupAnchorsDrag:function(){var A=this;A.anchorsDrag=new ak.DD.Delegate(A.get(af));A.anchorsDrag.dd.addInvalid(g+Q);},_uiSetFields:function(aU){var A=this;if(A.get(aP)){A.alignAnchors();A.syncDragTargets();A.syncDropTargets();}},_uiSetName:function(aV){var A=this;var aU=A.get(o);aU.set(ay,ak.DiagramNode.buildNodeId(aV));},_uiSetRequired:function(aW){var aV=this;
var aU=aV.getStrings();var A=aV.controlsToolbar;if(A){if(aW){A.remove(aL);}else{A.add({handler:ak.bind(aV._handleCloseEvent,aV),icon:ac,id:aL,title:aU[B]});}}},_uiSetSelected:function(aU){var A=this;A.get(o).toggleClass(aQ,aU);if(aU&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(aV){var A=this;var aU=A._getContainer().getXY();this._posNode.setXY([aV[0]+aU[0],aV[1]+aU[1]]);},_valueControlsToolbar:function(aV){var aU=this;var A=aU.getStrings();return{activeState:false,children:[{handler:ak.bind(aU._handleEditEvent,aU),icon:l,id:y,title:A[H]},{handler:ak.bind(aU._handleAddAnchorEvent,aU),icon:aj,id:ao,title:A[aN]},{handler:ak.bind(aU._handleAddNodeEvent,aU),icon:G,id:j},{handler:ak.bind(aU._handleCloseEvent,aU),icon:ac,id:aL,title:A[B]}]};}}});ak.DiagramNode=aT;ak.DiagramBuilder.types[n]=ak.DiagramNode;},"@VERSION@",{requires:["aui-diagram-builder-base","overlay"],skinnable:true});