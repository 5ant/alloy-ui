AUI.add("aui-diagram-builder-impl",function(h){var K=h.Lang,u=K.isArray,E=K.isObject,e=K.isString,o=h.Array,y=function(A){return(A instanceof h.DiagramBuilderBase);},p=function(A){return(A instanceof h.DiagramNode);},n=function(A,N){var M=u(N)?N:N.getXY();var O=u(A)?A:A.getXY();return o.map(O,function(Q,P){return Math.max(0,Q-M[P]);});},B="availableField",I="boundingBox",L="builder",g="data",t="dblclick",a="description",C="diagram",d="diagram-builder",v="diagram-node",c="dragNode",b="editing",x="fields",s="fieldsDragConfig",z="name",J="node",f="parentNode",i="records",D="recordset",G="rendered",j="type",k="xy",r=".",q="",w=h.getClassName,l=w(C,J,b),F=w(C,J);var m=h.Component.create({NAME:d,ATTRS:{fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:E}},EXTENDS:h.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editNode:null,initializer:function(){var A=this;A.on({cancel:A._onCancel,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});A.dropContainer.delegate(t,h.bind(A._onNodeEdit,A),r+F);},syncUI:function(){var A=this;h.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();},createField:function(M){var A=this;if(!p(M)){M=new (A.getFieldClass(M.type||J))(M);}M.set(L,A);return M;},getFieldClass:function(N){var A=this;var M=h.DiagramBuilder.types[N];if(M){return M;}else{h.log("The field type: ["+N+"] couldn't be found.");return null;}},isFieldsDrag:function(N){var A=this;var M=A.fieldsDrag;return(N===M.dd);},plotFields:function(){var M=this;var A=M.get(x);A.each(function(N){M.plotField(N);});},plotField:function(M){var A=this;if(!M.get(G)){M.render(A.dropContainer);}},startEditingNode:function(M){var A=this;if(M){A.stopEditingNode();A.tabView.selectTab(h.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(D,M.getProperties());M.get(I).addClass(l);A.editNode=M;}},stopEditingNode:function(N){var A=this;var M=N||A.editNode;if(M){A.tabView.selectTab(h.DiagramBuilder.FIELDS_TAB);M.get(I).removeClass(l);A.editNode=null;}},_onCancel:function(M){var A=this;A.stopEditingNode();},_onDragEnd:function(N){var A=this;var M=N.target;if(A.isFieldsDrag(M)){var O=h.Widget.getByNode(M.get(c));O.set(k,O.getLeftTop());}},_onDropHit:function(N){var A=this;var M=N.drag;if(A.isAvailableFieldsDrag(M)){var O=M.get(J).getData(B);A.addField({xy:n(M.lastXY,A.dropContainer),type:O.get(j)});}},_onNodeEdit:function(M){var A=this;var N=h.Widget.getByNode(M.currentTarget);if(N){A.startEditingNode(N);}},_onSave:function(N){var A=this;var M=A.editNode;var O=A.propertyList.get(D);if(M){o.each(O.get(i),function(P){var Q=P.get(g);M.set(Q.attributeName,Q.value);});A.stopEditingNode(M);}},_setFieldsDragConfig:function(N){var A=this;var M=A.dropContainer;return h.merge({bubbleTargets:A,container:M,dragConfig:{plugins:[{cfg:{constrain:M},fn:h.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:h.Plugin.DDWinScroll}]},nodes:r+F},N||{});},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new h.DD.Delegate(A.get(s));}}});h.DiagramBuilder=m;h.DiagramBuilder.types={};var H=h.Component.create({NAME:v,ATTRS:{builder:{validator:y},description:{value:q,validator:e},height:{value:100},name:{valueFn:function(){var A=this;return A.get(j)+(++h.Env._uidx);},validator:e},strings:{value:{description:"Description",name:"Name",type:"Type"}},type:{value:J,validator:e},width:{value:200}},EXTENDS:h.Overlay,prototype:{getLeftTop:function(){var A=this;return n(A.get(I),A._getContainer());},getProperties:function(){var A=this;var M=A.getPropertyModel();o.each(M,function(N){N.value=A.get(N.attributeName);});return M;},getPropertyModel:function(){var M=this;var A=M.getStrings();return[{attributeName:a,editor:new h.TextAreaCellEditor(),name:A[a]},{attributeName:z,editor:new h.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[z]},{attributeName:j,editor:false,name:A[j]}];},_getContainer:function(){var A=this;return(A.get(L).dropContainer||A.get(I).get(f));},_uiSetXY:function(N){var A=this;var M=A._getContainer().getXY();this._posNode.setXY([N[0]+M[0],N[1]+M[1]]);}}});H.buildNodeId=function(A){return v+_DOLLAR+FIELD+_DOLLAR+A;};h.DiagramNode=H;h.DiagramBuilder.types["node"]=h.DiagramNode;},"@VERSION@",{requires:["aui-diagram-builder-base","overlay"],skinnable:true});