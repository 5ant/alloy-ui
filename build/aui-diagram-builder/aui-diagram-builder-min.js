AUI.add("aui-diagram-builder-base",function(ad){var S=ad.Lang,d=S.isArray,ap=S.isBoolean,K=S.isNumber,z=S.isObject,at=S.isString,H=function(A){return(A instanceof ad.ArrayList);},Q=function(A){return(A instanceof ad.Node);},C=function(A){return(A instanceof ad.AvailableField);},aD=ad.Array,U="add",k="addNode",aC="auto",L="availableField",P="availableFields",az="availableFieldsDragConfig",am="base",s="boundingBox",aw="builder",Y="cancel",aa="canvas",aq="clearfix",a="container",ab="content",u="contentBox",O="contentNode",D="createDocumentFragment",y="diagram",E="diagram-builder-base",Z="disk",o="draggable",ay="drop",ak="dropConfig",W="dropContainer",ao="field",t="fields",n="fieldsContainer",an="height",p="helper",V="icon",v="iconClass",aj="id",af="label",ai="list",N="maxFields",r="node",ac="propertyList",ax="rendered",al="save",q="settings",M="tab",F="tabView",b="tabs",e="tabview",J="toolbar",j="toolbarContainer",w=ad.getClassName,aB=" ",g=".",G="$",h="#",aE=w(y,aw,am,ay,a),x=w(y,aw,am,aa),B=w(y,aw,am,ao),f=w(y,aw,am,t,a),ag=w(y,aw,am,ao,o),c=w(y,aw,am,ao,V),T=w(y,aw,am,ao,af),m=w(y,aw,am,b,a),X=w(y,aw,am,b,a,ab),ah=w(y,aw,am,M,U),I=w(y,aw,am,M,q),au=w(y,aw,am,J,a),ae=w(p,aq),l=w(V),av=w(e,ab),aA=w(e,ai);var i=ad.Component.create({NAME:L,ATTRS:{draggable:{value:true,validator:ap},label:{validator:at},iconClass:{validator:at},id:{value:ad.guid(),setter:"_setId",validator:at},node:{valueFn:function(aF){var A=this;if(!Q(aF)){aF=ad.Node.create(ad.Lang.sub(A.FIELD_ITEM_TEMPLATE,{iconClass:A.get(v)}));aF.setData(L,A);}return aF;},validator:Q,writeOnce:true},type:{value:r,validator:at}},EXTENDS:ad.Base,buildNodeId:function(A){return P+G+ao+G+A;},getAvailableFieldById:function(A){return ad.AvailableField.getAvailableFieldByNode(h+ad.AvailableField.buildNodeId(A));},getAvailableFieldByNode:function(A){return ad.one(A).getData(L);},prototype:{FIELD_ITEM_TEMPLATE:'<li class="'+B+'">'+'<span class="'+[l,c].join(aB)+' {iconClass}"></span>'+'<span class="'+T+'"></span>'+"</li>",initializer:function(){var A=this;var aF=A.get(r);A.after({draggableChange:A._afterDraggableChange,idChange:A._afterIdChange,labelChange:A._afterLabelChange});A.labelNode=aF.one(g+T);A._uiSetDraggable(A.get(o));A._uiSetId(A.get(aj));A._uiSetLabel(A.get(af));},_afterDraggableChange:function(aF){var A=this;A._uiSetDraggable(aF.newVal);},_afterIdChange:function(aF){var A=this;A._uiSetId(aF.newVal);},_afterLabelChange:function(aF){var A=this;A._uiSetLabel(aF.newVal);},_setId:function(A){return ad.AvailableField.buildNodeId(A);},_uiSetDraggable:function(aF){var A=this;A.get(r).toggleClass(ag,aF);},_uiSetId:function(aF){var A=this;A.get(r).set(aj,aF);},_uiSetLabel:function(aF){var A=this;A.labelNode.setContent(aF);}}});ad.AvailableField=i;var R=function(){};R.ATTRS={fields:{value:[],setter:"_setFields",validator:function(A){return d(A)||H(A);}},maxFields:{value:Infinity,validator:K}};ad.mix(R.prototype,{_setFields:function(aF){var A=this;if(H(aF)){return aF;}else{return A.createFields(aF);}},_updateFields:function(aF){var A=this;A.set(t,aF);},addField:function(aF){var A=this;if(A.get(t).size()<A.get(N)){var aG=A.createField(aF);if(aG){A._updateFields(A.get(t).add(aG));}return aG;}return null;},createFields:function(aG){var aF=this;var A=[];aD.each(aG,function(aI,aH){if(aH<aF.get(N)){A.push(aF.createField(aI));}});return new ad.ArrayList(A);},removeField:function(aF){var A=this;A._updateFields(A.get(t).remove(aF));},createField:function(A){return A;}});ad.FieldSupport=R;var ar=ad.Component.create({NAME:E,ATTRS:{availableFields:{setter:"_setAvailableFields",validator:d},availableFieldsDragConfig:{value:null,setter:"_setAvailableFieldsDragConfig",validator:z},canvas:{valueFn:function(){return ad.Node.create(this.CANVAS_TEMPLATE);}},dropConfig:{value:null,setter:"_setDropConfig",validator:z},dropContainer:{valueFn:function(){return ad.Node.create(this.DROP_CONTAINER_TEMPLATE);}},fieldsContainer:{valueFn:function(){return ad.Node.create(this.FIELDS_CONTAINER_TEMPLATE);}},propertyList:{setter:"_setPropertyList",validator:z,value:null},strings:{value:{addNode:"Add node",cancel:"Cancel",propertyName:"Property Name",save:"Save",settings:"Settings",value:"Value"}},tabView:{setter:"_setTabView",validator:z,value:null,writeOnce:true},toolbar:{setter:"_setToolbar",validator:z,value:null},toolbarContainer:{valueFn:function(){return ad.Node.create(this.TOOLBAR_CONTAINER_TEMPLATE);}}},HTML_PARSER:{dropContainer:g+aE,fieldsContainer:g+f,toolbarContainer:g+au,canvas:g+x},UI_ATTRS:[P,t],AUGMENTS:[ad.FieldSupport],prototype:{DROP_CONTAINER_TEMPLATE:'<div class="'+aE+'"></div>',TOOLBAR_CONTAINER_TEMPLATE:'<div class="'+au+'"></div>',FIELDS_CONTAINER_TEMPLATE:'<ul class="'+f+'"></ul>',CANVAS_TEMPLATE:'<div tabindex="1" class="'+x+'"></div>',fieldsNode:null,propertyList:null,settingsNode:null,tabView:null,toolbar:null,initializer:function(){var A=this;A.publish({cancel:{defaultFn:A._defCancelFn}});A.after({render:A._afterRender});A.after(A._afterUiSetHeight,A,"_uiSetHeight");A.canvas=A.get(aa);A.dropContainer=A.get(W);A.fieldsContainer=A.get(n);A.toolbarContainer=A.get(j);},isAvailableFieldsDrag:function(aG){var A=this;var aF=A.availableFieldsDrag;return(aG===aF.dd);},plotFields:function(){var aF=this;var A=aF.get(t);A.each(function(aG){aF.plotField(aG);});},renderUI:function(){var A=this;A._renderTabs();A._renderCanvas();A._uiSetAvailableFields(A.get(P));},syncUI:function(){var A=this;var aF=A.get(u);A._setupDrop();A._setupAvailableFieldsDrag();aF.addClass(ae);},_afterActiveTabChange:function(aG){var A=this;var aF=aG.newVal.get(O);if(A.get(ax)&&(aF===A.settingsNode)){A._renderSettings();}},_afterRender:function(aF){var A=this;A.plotFields();},_afterUiSetHeight:function(aF){var A=this;A.dropContainer.setStyle(an,K(aF)?aF+A.DEF_UNIT:aF);},_defCancelFn:function(aF){var A=this;A.tabView.selectTab(0);},_handleCancelEvent:function(){var A=this;A.fire(Y);},_handleSaveEvent:function(){var A=this;A.fire(al);},_renderCanvas:function(){var A=this;var aF=A.get(u);var aG=A.canvas;
aG.appendChild(A.dropContainer);aF.appendChild(aG);},_renderPropertyList:function(){var A=this;if(!A.propertyList){A.propertyList=new ad.PropertyList(A.get(ac)).render(A.settingsNode);A.propertyList.get(s).unselectable();}},_renderSettings:function(){var A=this;A._renderPropertyList();A._renderToolbar();},_renderTabs:function(){var A=this;if(!A.tabView){var aF=new ad.TabView(A.get(F));A.tabView=aF;A.fieldsNode=aF.getTab(0).get(O);A.settingsNode=aF.getTab(1).get(O);}},_renderToolbar:function(){var A=this;if(!A.toolbar){A.toolbar=new ad.Toolbar(A.get(J)).render(A.settingsNode);}},_setupDrop:function(){var A=this;A.drop=new ad.DD.Drop(A.get(ak));},_setupAvailableFieldsDrag:function(){var A=this;A.availableFieldsDrag=new ad.DD.Delegate(A.get(az));},_setAvailableFields:function(aG){var aF=this;var A=[];aD.each(aG,function(aI,aH){A.push(C(aI)?aI:new ad.AvailableField(aI));});return A;},_setDropConfig:function(aF){var A=this;return ad.merge({bubbleTargets:A,groups:[P],node:A.dropContainer},aF||{});},_setAvailableFieldsDragConfig:function(aF){var A=this;return ad.merge({bubbleTargets:A,container:A.get(s),dragConfig:{groups:[P],plugins:[{cfg:{moveOnEnd:false},fn:ad.Plugin.DDProxy}]},nodes:g+ag},aF||{});},_setPropertyList:function(aF){var A=this;return ad.merge({bubbleTargets:A,width:250,scroll:{height:400,width:aC}},aF);},_setTabView:function(aI){var aF=this;var aH=aF.get(s);var aJ=aH.one(g+aA);var aG={after:{activeTabChange:ad.bind(aF._afterActiveTabChange,aF)},boundingBox:aH.one(g+m),contentBox:aH.one(g+X),bubbleTargets:aF,contentNode:aH.one(g+av),cssClass:m,listNode:aJ,render:aF.get(u)};if(!aJ){var A=aF.getStrings();aG.items=[{cssClass:ah,label:A[k]},{cssClass:I,label:A[q]}];}return ad.merge(aG,aI);},_setToolbar:function(aG){var aF=this;var A=aF.getStrings();return ad.merge({activeState:false,bubbleTargets:aF,children:[{handler:ad.bind(aF._handleSaveEvent,aF),label:A[al],icon:Z},{handler:ad.bind(aF._handleCancelEvent,aF),label:A[Y]}]},aG);},_uiSetAvailableFields:function(aH){var A=this;var aG=A.fieldsNode;if(aG){var aF=ad.getDoc().invoke(D);aD.each(aH,function(aI){aF.appendChild(aI.get(r));});aG.setContent(A.fieldsContainer.setContent(aF));}},_uiSetFields:function(aF){var A=this;if(A.get(ax)){A.plotFields();}}}});ad.DiagramBuilderBase=ar;},"@VERSION@",{requires:["aui-tabs","aui-property-list","collection","dd"],skinnable:true});AUI.add("aui-diagram-builder-impl",function(ap){var ad=ap.Lang,c=ad.isArray,G=ad.isObject,aP=ad.isString,aL=ad.isBoolean,aX=ap.Array,X=function(A){return(A instanceof ap.DiagramBuilderBase);},aM=function(A){return(A instanceof ap.DiagramNode);},al=function(A){return(A instanceof ap.Anchor);},av=function(A,a0){var aZ=c(a0)?a0:a0.getXY();var a1=c(A)?A:A.getXY();return aX.map(a1,function(a3,a2){return Math.max(0,a3-aZ[a2]);});},ab="activeElement",at="addAnchor",aS="addAnchorMessage",j="addNode",ax="anchor",aq="anchors",ak="anchorsDragConfig",S="availableField",Z="boolean",p="boundingBox",aT="builder",ah="cancel",ai="canvas",aE="click",aQ="closeEvent",D="closeMessage",an="content",M="controls",aC="controlsToolbar",aB="data",aj="dblclick",W="delete",aA="deleteConnectorsMessage",n="deleteNodesMessage",aH="description",E="diagram",am="diagram-builder",aw="diagramNode",z="diagram-node",aI="dragNode",B="editEvent",J="editMessage",O="editing",a="esc",aK="field",r="fields",au="fieldsDragConfig",Y="graphic",aJ="height",q="hover",aD="id",Q="keydown",ao="link",af="max",T="maxFields",u="maxSources",s="mouseenter",aa="mouseleave",m="name",o="node",az="p1",ay="p2",d="parentNode",l="pencil",ag="records",k="recordset",h="region",aU="rendered",I="required",aO="selected",H="shuffle",P="source",aN="sources",i="target",K="targets",N="tmpConnector",e="type",L="width",aR="wrapper",x="xy",w="zIndex",aW="-",g=".",R="",f="#",F="_",v=ap.getClassName,U=v(E,aT,ax,o,af,K),ar=v(E,aT,ax,q),aG=v(E,aT,ax,o),C=v(E,aT,ax,o,aR),t=v(E,aT,M),ac=v(E,o),b=v(E,o,an),aF=v(E,o,O),aV=v(E,o,aO);var ae=function(){var aZ="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",A="<br/>";ap.all(".aui-diagram-node").each(function(a5){var a0=R,a2=ap.Widget.getByNode(a5),a1=a2.get("name"),a4=a2.get("boundingBox"),a3=a4.one(".log")||ap.Node.create("<div class=log />").appendTo(a4);a0+=a1+A;a2.get(r).each(function(a6){a0+=aZ+"a: "+a6.get("id")+A;a6.get("targets").each(function(a7){var a8=a7.get(aw);a7.get("node").setContent(a7.get("id"));a0+=aZ+aZ+"t: "+a8.get("name")+" (s: "+a7.get("id")+")"+A;});a6.get("sources").each(function(a8){var a7=a8.get(aw);a8.get("node").setContent(a8.get("id"));a0+=aZ+aZ+"s: "+a7.get("name")+" (t: "+a8.get("id")+")"+A;});});a3.setContent(a0);});};var y=ap.Component.create({NAME:am,ATTRS:{fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:G},graphic:{valueFn:function(){return new ap.Graphic();},validator:G},strings:{value:{addNode:"Add node",cancel:"Cancel",deleteConnectorsMessage:"Are you sure you want to delete the selected connector(s)?",propertyName:"Property Name",save:"Save",settings:"Settings",value:"Value"}},tmpConnector:{setter:"_setTmpConnector",value:{},validator:G}},EXTENDS:ap.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{selectedConnector:null,selectedNode:null,initializer:function(){var A=this;A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});A.handlerKeyDown=ap.getDoc().on(Q,ap.bind(A._afterKeyEvent,A));A.dropContainer.delegate(aE,ap.bind(A._onNodeClick,A),g+ac);A.dropContainer.delegate(aj,ap.bind(A._onNodeEdit,A),g+ac);A.dropContainer.delegate(s,ap.bind(A._onMouseenterAnchors,A),g+aG);A.dropContainer.delegate(aa,ap.bind(A._onMouseleaveAnchors,A),g+aG);},renderUI:function(){var A=this;ap.DiagramBuilder.superclass.renderUI.apply(this,arguments);A._renderGraphic();},syncUI:function(){var A=this;ap.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.tmpConnector=new ap.Connector(A.get(N));},closeEditProperties:function(){var A=this;var aZ=A.editingNode;A.tabView.selectTab(ap.DiagramBuilder.FIELDS_TAB);
if(aZ){aZ.get(p).removeClass(aF);}A.editingConnector=null;A.editingNode=null;},connect:function(a0,a4,a3){var aZ=this;if(aP(a0)){a0=ap.Widget.getByNode(f+ap.DiagramNode.buildNodeId(a0));}if(aP(a4)){a4=ap.Widget.getByNode(f+ap.DiagramNode.buildNodeId(a4));}if(a0&&a4){var a2=a0.findAvailableAnchor();var A=a4.findAvailableAnchor();if(a2&&A){a2.connect(A,a3);}}return aZ;},connectAll:function(aZ){var A=this;aX.each(aZ,function(a0){if(a0.hasOwnProperty(P)&&a0.hasOwnProperty(i)){A.connect(a0.source,a0.target,a0.connector);}});return A;},createField:function(aZ){var A=this;if(!aM(aZ)){aZ.builder=A;aZ=new (A.getFieldClass(aZ.type||o))(aZ);}aZ.set(aT,A);return aZ;},deleteConnectors:function(aZ){var A=this;aX.each(aZ,function(a0){var a1=a0.get(ax);if(a1){var a2=a1.findConnectorTarget(a0);if(a2){a1.disconnect(a2);}}});},eachConnetor:function(a0){var A=this;var aZ=false;A.get(r).some(function(a1){a1.get(r).some(function(a2){ap.some(a2.connectors,function(a3){aZ=a0.call(A,a3,a2,a1);return aZ;});return aZ;});return aZ;});},editConnector:function(aZ){var A=this;if(aZ){A.closeEditProperties();A.tabView.selectTab(ap.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(k,aZ.getProperties());A.editingConnector=A.selectedConnector=aZ;}},editNode:function(aZ){var A=this;if(aZ){A.closeEditProperties();A.tabView.selectTab(ap.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(k,aZ.getProperties());aZ.get(p).addClass(aF);A.editingNode=A.selectedNode=aZ;}},getSelectedConnectors:function(){var A=this;var aZ=[];A.eachConnetor(function(a0){if(a0.get(aO)){aZ.push(a0);}});return aZ;},getFieldClass:function(a0){var A=this;var aZ=ap.DiagramBuilder.types[a0];if(aZ){return aZ;}else{ap.log("The field type: ["+a0+"] couldn't be found.");return null;}},isFieldsDrag:function(a0){var A=this;var aZ=A.fieldsDrag;return(a0===aZ.dd);},plotField:function(aZ){var A=this;if(!aZ.get(aU)){aZ.render(A.dropContainer);}},unselectConnectors:function(){var A=this;aX.each(A.getSelectedConnectors(),function(aZ){aZ.set(aO,false);});},unselectNodes:function(){var A=this;var aZ=A.selectedNode;if(aZ){aZ.set(aO,false);}A.selectedNode=null;},select:function(aZ){var A=this;A.unselectNodes();A.selectedNode=aZ.set(aO,true).focus();},stopEditing:function(){var A=this;A.unselectConnectors();A.unselectNodes();A.closeEditProperties();},toJSON:function(){var A=this;var aZ={nodes:[]};A.get(r).each(function(a1){var a2=a1.get(m);var a0={transitions:[]};aX.each(a1.SERIALIZABLE_ATTRS,function(a3){a0[a3]=a1.get(a3);});a1.get(r).each(function(a3){a3.get(K).each(function(a4){a0.transitions.push({connector:a3.getConnector(a4).toJSON(),source:a2,target:a4.get(aw).get(m)});});});aZ.nodes.push(a0);});return aZ;},_afterKeyEvent:function(aZ){var A=this;if(aZ.hasModifier()||ap.getDoc().get(ab).test(":input,td")){return;}if(aZ.isKey(a)){A._onEscKey(aZ);}else{if(aZ.isKey(W)){A._onDeleteKey(aZ);}}},_onCancel:function(aZ){var A=this;A.closeEditProperties();},_onDrag:function(a0){var A=this;var aZ=a0.target;if(A.isFieldsDrag(aZ)){var a1=ap.Widget.getByNode(aZ.get(aI));a1.get(r).each(function(a2){a2.alignConnectors();});}},_onDragEnd:function(a0){var A=this;var aZ=a0.target;if(A.isFieldsDrag(aZ)){var a1=ap.Widget.getByNode(aZ.get(aI));a1.set(x,a1.getLeftTop());}},_onDropHit:function(a0){var A=this;var aZ=a0.drag;if(A.isAvailableFieldsDrag(aZ)){var a2=aZ.get(o).getData(S);var a1=A.addField({xy:av(aZ.lastXY,A.dropContainer),type:a2.get(e),fields:[{}]});A.select(a1);}},_onDeleteKey:function(a1){var aZ=this;var A=aZ.getStrings();var a0=aZ.getSelectedConnectors();if(a0.length&&confirm(A[aA])){aZ.deleteConnectors(a0);}var a2=aZ.selectedNode;if(a2){if(!a2.get(I)){a2.close();}}a1.halt();},_onEscKey:function(aZ){var A=this;A.stopEditing();aZ.halt();},_onMouseenterAnchors:function(aZ){var A=this;aZ.currentTarget.addClass(ar);},_onMouseleaveAnchors:function(aZ){var A=this;aZ.currentTarget.removeClass(ar);},_onNodeClick:function(aZ){var A=this;var a0=ap.Widget.getByNode(aZ.currentTarget);A.select(a0);},_onNodeEdit:function(aZ){var A=this;if(!aZ.target.ancestor(g+b,true)){return;}var a0=ap.Widget.getByNode(aZ.currentTarget);if(a0){A.editNode(a0);}},_onSave:function(a0){var A=this;var aZ=A.editingNode;var a1=A.editingConnector;var a2=A.propertyList.get(k);if(aZ){aX.each(a2.get(ag),function(a3){var a4=a3.get(aB);aZ.set(a4.attributeName,a4.value);});}else{if(a1){aX.each(a2.get(ag),function(a3){var a4=a3.get(aB);a1.set(a4.attributeName,a4.value);});}}A.closeEditProperties();},_renderGraphic:function(){var A=this;A.get(Y).render(A.get(ai));},_setTmpConnector:function(a0){var A=this;var aZ=A.get(ai).getXY();return ap.merge({p1:aZ,p2:aZ,lazyDraw:true,graphic:A.get(Y)},a0);},_setFieldsDragConfig:function(a0){var A=this;var aZ=A.dropContainer;return ap.merge({bubbleTargets:A,container:aZ,dragConfig:{plugins:[{cfg:{constrain:aZ},fn:ap.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:ap.Plugin.DDWinScroll}]},nodes:g+ac},a0||{});},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new ap.DD.Delegate(A.get(au));}}});ap.DiagramBuilder=y;ap.DiagramBuilder.types={};var V=ap.Component.create({NAME:z,EXTENDS:ap.Overlay,AUGMENTS:[ap.FieldSupport]});var aY=ap.Component.create({NAME:z,UI_ATTRS:[r,m,I,aO],ATTRS:{anchorsDragConfig:{value:null,setter:"_setAnchorsDragConfig",validator:G},builder:{validator:X},required:{value:false,validator:aL},description:{value:R,validator:aP},height:{value:90},name:{valueFn:function(){var A=this;return A.get(e)+(++ap.Env._uidx);},validator:aP},selected:{value:false,validator:aL},strings:{value:{addAnchorMessage:"Add Anchor",closeMessage:"Close",deleteNodesMessage:"Are you sure you want to delete the selected node(s)?",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},type:{value:o,validator:aP},controlsToolbar:{validator:G,valueFn:"_valueControlsToolbar"},width:{value:90},zIndex:{value:100},tabIndex:{value:1}},EXTENDS:V,buildNodeId:function(A){return aw+F+aK+F+A;},prototype:{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+C+'"></div>',CONTROLS_TEMPLATE:'<div class="'+t+'"></div>',SERIALIZABLE_ATTRS:[aH,m,I,e,L,aJ,w,x,T],initializer:function(){var A=this;
A._renderNodes();A._setupAnchorsDrag();A.after({render:A._afterRender});A.on({"drag:drag":A._onAnchorDrag,"drag:end":A._onAnchorDragEnd,"drag:start":A._onAnchorDragStart,"drop:hit":A._onAnchorDropHit});A.get(p).addClass(ac+aW+A.get(e));A.set("bodyContent",A.get(m));},destructor:function(){var A=this;A.get(aT).removeField(A);},alignAnchors:function(){var aZ=this;var a3=aZ.get(r);var a1=aZ.get(p).get(h),a2=Math.floor(360/a3.size()),a0=a1.width/2,A=a1.height/2,a5=a1.left+a1.width/2,a4=a1.top+a1.height/2;a3.each(function(a9,a8){var a7=a9.get(o);var ba=a7.get(h);var a6=aZ._getEllipseXY(a0,A,a5,a4,a8*a2);a7.setXY([a6[0]-ba.width/2,a6[1]-ba.height/2]);a9.alignConnectors();});return aZ;},close:function(){var aZ=this;var A=aZ.getStrings();if(confirm(A[n])){aZ.get(r).each(function(a0){a0.destroy();});aZ.destroy();}return aZ;},createField:function(a0){var A=this;if(!al(a0)){var aZ=A.get(aT);a0.diagramNode=A;a0=new ap.Anchor(a0);}return a0;},findAvailableAnchor:function(){var A=this;var aZ=null;A.get(r).some(function(a0){if(!a0.hasConnection()){aZ=a0;return true;}});if(!aZ){aZ=A.addField({});}return aZ;},getConnectionNode:function(){var A=this;return new ap.DiagramNode({xy:[100,100]});},getLeftTop:function(){var A=this;return av(A.get(p),A._getContainer());},getProperties:function(){var A=this;var aZ=A.getPropertyModel();aX.each(aZ,function(a2){var a1=A.get(a2.attributeName),a0=ad.type(a1);if(a0===Z){a1=String(a1);}a2.value=a1;});return aZ;},getPropertyModel:function(){var aZ=this;var A=aZ.getStrings();return[{attributeName:aH,editor:new ap.TextAreaCellEditor(),name:A[aH]},{attributeName:m,editor:new ap.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[m]},{attributeName:e,editor:false,name:A[e]}];},syncDragTargets:function(){var A=this;A.anchorsDrag.syncTargets();},syncDropTargets:function(aZ){var A=this;A.get(r).each(function(a1){var a0=ap.DD.DDM.getDrop(a1.get(o));if(a0){if(a1.get(aN).size()===a1.get(u)){a0.removeFromGroup(aq);}else{a0.addToGroup(aq);}}});},_afterRender:function(aZ){var A=this;A.alignAnchors();A._renderControls();},_getContainer:function(){var A=this;return(A.get(aT).dropContainer||A.get(p).get(d));},_getEllipseXY:function(aZ,A,a2,a1,a3){var a0=a3*Math.PI/180;return[a2+aZ*Math.cos(a0),a1-A*Math.sin(a0)];},_handleAddAnchorEvent:function(aZ){var A=this;A.addField({});},_handleAddNodeEvent:function(a0){var A=this;var aZ=A.get(aT);var a1=A.findAvailableAnchor();if(a1){var a2=A.getConnectionNode();aZ.addField(a2);a1.connect(a2.addField({}));}},_handleEditEvent:function(aZ){var A=this;A.get(aT).editNode(A);},_handleCloseEvent:function(aZ){var A=this;if(!A.get(I)){A.close();}},_onAnchorDrag:function(a0){var A=this;var aZ=A.get(aT);aZ.tmpConnector.set(ay,a0.target.get(aI).getCenterXY());},_onAnchorDragEnd:function(a0){var A=this;var aZ=A.get(aT).tmpConnector.shape;aZ.clear();aZ.end();},_onAnchorDragStart:function(a0){var A=this;var aZ=A.get(aT);aZ.tmpConnector.set(az,a0.target.get(o).getCenterXY());},_onAnchorDropHit:function(aZ){var A=this;var a0=ap.Anchor.getAnchorByNode(aZ.drag.get(o));var a1=ap.Anchor.getAnchorByNode(aZ.drop.get(o));a0.connect(a1);ae();},_renderControls:function(){var A=this;var aZ=A.get(p);A.controlsNode=ap.Node.create(A.CONTROLS_TEMPLATE).appendTo(aZ);},_renderNodes:function(){var A=this;var aZ=A.get(p);A.anchorWrapper=ap.Node.create(A.ANCHOR_WRAPPER_TEMPLATE).appendTo(aZ);},_renderControlsToolbar:function(aZ){var A=this;A.controlsToolbar=new ap.Toolbar(A.get(aC)).render(A.controlsNode);A._uiSetRequired(A.get(I));},_setAnchorsDragConfig:function(a0){var A=this;var aZ=A.get(aT);return ap.merge({bubbleTargets:A,container:A.anchorWrapper,dragConfig:{groups:[aq],plugins:[{cfg:{constrain:(aZ?aZ.get(ai):null)},fn:ap.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:ap.Plugin.DDWinScroll},{cfg:{moveOnEnd:false},fn:ap.Plugin.DDProxy}]},nodes:g+aG,target:true},a0||{});},_setupAnchorsDrag:function(){var A=this;A.anchorsDrag=new ap.DD.Delegate(A.get(ak));A.anchorsDrag.dd.addInvalid(g+U);},_uiSetFields:function(aZ){var A=this;if(A.get(aU)){A.alignAnchors();A.syncDragTargets();A.syncDropTargets();}},_uiSetName:function(a0){var A=this;var aZ=A.get(p);aZ.set(aD,ap.DiagramNode.buildNodeId(a0));},_uiSetRequired:function(a1){var a0=this;var aZ=a0.getStrings();var A=a0.controlsToolbar;if(A){if(a1){A.remove(aQ);}else{A.add({handler:ap.bind(a0._handleCloseEvent,a0),icon:ah,id:aQ,title:aZ[D]});}}},_uiSetSelected:function(aZ){var A=this;A.get(p).toggleClass(aV,aZ);if(aZ&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(a0){var A=this;var aZ=A._getContainer().getXY();this._posNode.setXY([a0[0]+aZ[0],a0[1]+aZ[1]]);},_valueControlsToolbar:function(a0){var aZ=this;var A=aZ.getStrings();return{activeState:false,children:[{handler:ap.bind(aZ._handleEditEvent,aZ),icon:l,id:B,title:A[J]},{handler:ap.bind(aZ._handleAddAnchorEvent,aZ),icon:ao,id:at,title:A[aS]},{handler:ap.bind(aZ._handleAddNodeEvent,aZ),icon:H,id:j},{handler:ap.bind(aZ._handleCloseEvent,aZ),icon:ah,id:aQ,title:A[D]}]};}}});ap.DiagramNode=aY;ap.DiagramBuilder.types[o]=ap.DiagramNode;},"@VERSION@",{requires:["aui-diagram-builder-base","overlay"],skinnable:true});AUI.add("aui-diagram-builder-connector",function(p){var aa=p.Lang,C=aa.isArray,G=aa.isBoolean,Z=aa.isNumber,O=aa.isObject,m=aa.isString,u=p.Array,d=function(A){return(A instanceof p.Anchor);},R=function(A){return(A instanceof p.ArrayList);},v=function(A){return(A instanceof p.DiagramNode);},Q=function(A){return(A instanceof p.Graphic);},M="anchor",S="arrowPoints",T="boundingBox",ab="builder",P="click",I="color",x="connector",a="dataAnchor",b="description",L="diagram",D="diagramNode",K="fill",J="graphic",z="id",V="lazyDraw",W="max",o="maxSources",n="maxTargets",g="mouseenter",q="mouseleave",H="name",Y="node",t="p1",s="p2",h="path",F="selected",B="shape",N="shapeHover",r="shapeSelected",l="sources",i="stroke",j="targets",X="wrapper",y=".",w="",k="#",E=p.getClassName,c=E(L,ab,M,Y,W,j),f=E(L,ab,M,Y,W,l),e=E(L,ab,M,Y,X),U=E(L,ab,M,Y);p.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(ah,ac,aj,A,ai,af){var ak=this;
ah.moveTo(ac,aj);ah.lineTo(A,ai);var ad=Math.atan2(ai-aj,A-ac),ag=(A+ac)/2,ae=(ai+aj)/2;ak.drawPolygon(ah,ak.translatePoints(ak.rotatePoints(af||ak.ARROW_POINTS,ad),ag,ae));},drawPolygon:function(ac,ad){var A=this;ac.moveTo(ad[0][0],ad[0][1]);u.each(ad,function(af,ae){if(ae>0){ac.lineTo(ad[ae][0],ad[ae][1]);}});ac.lineTo(ad[0][0],ad[0][1]);},translatePoints:function(ad,ac,af){var A=this;var ae=[];u.each(ad,function(ah,ag){ae.push([ad[ag][0]+ac,ad[ag][1]+af]);});return ae;},rotatePoints:function(ac,ae){var A=this;var ad=[];u.each(ac,function(ag,af){ad.push(A.rotatePoint(ae,ac[af][0],ac[af][1]));});return ad;},rotatePoint:function(ac,A,ad){return[(A*Math.cos(ac))-(ad*Math.sin(ac)),(A*Math.sin(ac))+(ad*Math.cos(ac))];}};p.Connector=p.Base.create("line",p.Base,[],{SERIALIZABLE_ATTRS:[I,b,V,H,r,N,t,s],shape:null,initializer:function(ad){var A=this;var ac=A.get(V);A.after({p1Change:A.draw,p2Change:A.draw,selectedChange:A._afterSelectedChange});A._initShapes();if(!ac){A.draw();}A._uiSetSelected(A.get(F),!ac);},destroy:function(){var A=this;A.get(J).removeShape(A.shape);},draw:function(){var A=this;var ac=A.shape;var ae=A.getCoordinate(A.get(t));var ad=A.getCoordinate(A.get(s));ac.clear();p.PolygonUtil.drawLineArrow(ac,ae[0],ae[1],ad[0],ad[1],A.get(S));ac.end();},getCoordinate:function(ad){var A=this;var ac=A.get(J).getXY();return[ad[0]-ac[0],ad[1]-ac[1]];},getProperties:function(){var A=this;var ac=A.getPropertyModel();u.each(ac,function(ad){ad.value=A.get(ad.attributeName);});return ac;},getPropertyModel:function(){var ac=this;var ad=ac.get(M);var A=ad?ad.get(D).getStrings():{};return[{attributeName:b,editor:new p.TextAreaCellEditor(),name:A[b]},{attributeName:H,editor:new p.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[H]}];},toJSON:function(){var A=this;var ac={};u.each(A.SERIALIZABLE_ATTRS,function(ad){ac[ad]=A.get(ad);});return ac;},_afterSelectedChange:function(ac){var A=this;A._uiSetSelected(ac.newVal);},_initShapes:function(){var A=this;var ac=A.shape=A.get(J).getShape(A.get(B));ac.on(P,p.bind(A._onShapeClick,A));ac.on(g,p.bind(A._onShapeMouseEnter,A));ac.on(q,p.bind(A._onShapeMouseLeave,A));},_onShapeClick:function(af){var A=this;var ad=A.get(M);var ae=A.get(F);if(ad){var ac=ad.getBuilder();if(af.hasModifier()){ac.closeEditProperties();}else{ac.unselectConnectors();if(ae){ac.closeEditProperties();}else{ac.editConnector(A);}}}A.set(F,!ae);},_onShapeMouseEnter:function(ac){var A=this;if(!A.get(F)){A._updateShape(A.get(N));}},_onShapeMouseLeave:function(ac){var A=this;if(!A.get(F)){A._updateShape(A.get(B));}},_setShape:function(ac){var A=this;return p.merge({type:h,stroke:{color:A.get(I),weight:2},fill:{color:A.get(I)}},ac);},_updateShape:function(ae,ac){var A=this;var ad=A.shape;if(ae.hasOwnProperty(K)){ad.set(K,ae[K]);}if(ae.hasOwnProperty(i)){ad.set(i,ae[i]);}if(ac!==false){A.draw();}},_uiSetSelected:function(ad,ac){var A=this;A._updateShape(ad?A.get(r):A.get(B),ac);}},{ATTRS:{anchor:{},color:{value:"#666",validator:m},description:{value:w,validator:m},lazyDraw:{value:false,validator:G},name:{valueFn:function(){var A=this;return x+(++p.Env._uidx);},validator:m},graphic:{validator:Q},shapeHover:{value:{fill:{color:"#000"},stroke:{color:"#000",weight:5}}},selected:{value:false,validator:G},shape:{value:null,setter:"_setShape"},shapeSelected:{value:{fill:{color:"#000"},stroke:{color:"#000",weight:5}}},arrowPoints:{value:p.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:C},p2:{value:[0,0],validator:C}}});p.Anchor=p.Base.create("anchor",p.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+e+'"></div>',NODE_TEMPLATE:'<div class="'+U+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(n));},addSource:function(ac){var A=this;if(A.get(l).size()<A.get(o)){A.set(l,A.get(l).remove(ac).add(ac));}return A;},addTarget:function(ac){var A=this;if(A.get(j).size()<A.get(n)){A.set(j,A.get(j).remove(ac).add(ac));}return A;},alignConnectors:function(){var A=this;A.get(j).each(function(ac){var ad=A.getConnector(ac);if(ad){ad.set(t,A.getCenterXY());ad.set(s,ac.getCenterXY());}});A.get(l).each(function(ac){var ad=ac.getConnector(A);if(ad){ad.set(t,ac.getCenterXY());ad.set(s,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(Y).remove();},connect:function(ad,ac){var A=this;if(v(ad)){ad=ad.findAvailableAnchor();}A.addTarget(ad);ad.addSource(A);if(!A.isConnected(ad)){var ae=p.merge(ad.get(x),ac);ae.anchor=A;ae.p1=A.getCenterXY();ae.p2=ad.getCenterXY();A.connectors[ad.get(z)]=new p.Connector(ae);}setTimeout(function(){ad.get(D).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(j).each(p.bind(A.connect,A));return A;},disconnect:function(ac){var A=this;A.getConnector(ac).destroy();A.removeTarget(ac);ac.removeSource(A);setTimeout(function(){ac.get(D).syncDropTargets();},50);},disconnectTargets:function(){var A=this;A.get(j).each(function(ac){A.disconnect(ac);});return A;},disconnectSources:function(){var A=this;A.get(l).each(function(ac){ac.disconnect(A);});return A;},findConnectorTarget:function(ac){var A=this;var ad=null;p.some(A.connectors,function(af,ae){if(af===ac){ad=p.Anchor.getAnchorByNode(k+ae);return true;}});return ad;},getBuilder:function(){var A=this;return A.get(D).get(ab);},getCenterXY:function(){var A=this;return A.get(Y).getCenterXY();},getConnector:function(ac){var A=this;return A.connectors[ac.get(z)];},hasConnection:function(){var A=this;return((A.get(j).size()>0)||(A.get(l).size()>0));},isConnected:function(ac){var A=this;return A.connectors.hasOwnProperty(ac.get(z));},removeSource:function(ac){var A=this;A.set(l,A.get(l).remove(ac));return A;},removeTarget:function(ac){var A=this;A.set(j,A.get(j).remove(ac));delete A.connectors[ac.get(z)];return A;},_afterSourcesChange:function(ac){var A=this;A._uiSetSources(ac.newVal);},_afterTargetsChange:function(ac){var A=this;
ac.prevVal.each(function(ad){ad.removeSource(A);});ac.newVal.each(function(ad){ad.addSource(A);});A._uiSetTargets(ac.newVal);},_renderNode:function(){var A=this;var ad=A.get(D);var ac=ad.get(T);A.wrapper=ac.one(y+e)||p.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(ac).appendChild(A.get(Y));},_setConnector:function(ac){var A=this;return p.merge({graphic:A.getBuilder().get(J)},ac);},_setSources:function(ac){var A=this;return A._setAnchors(ac);},_setTargets:function(ac){var A=this;ac=A._setAnchors(ac,true);ac.each(function(ad){ad.addSource(A);});return ac;},_setAnchors:function(ae,ad){var A=this;if(!R(ae)){var ac=[];p.Array.some(ae,function(ag,af){if(af>=A.get(ag?n:o)){return true;}ac.push(d(ag)?ag:new p.Anchor(ag));});ae=new p.ArrayList(ac);}return ae;},_setMaxSources:function(ac){var A=this;A._uiSetMaxSources(A.get(o));return ac;},_setMaxTargets:function(ac){var A=this;A._uiSetMaxTargets(A.get(n));return ac;},_setNode:function(ac){var A=this;var ad=A.get(z);return p.one(ac).set(z,ad).setData(a,A);},_uiSetSources:function(ac){var A=this;A._uiSetMaxSources(A.get(o));},_uiSetMaxSources:function(ad){var A=this;var ac=A.get(Y);ac.toggleClass(f,(A.get(l).size()===ad));},_uiSetMaxTargets:function(ad){var A=this;var ac=A.get(Y);ac.toggleClass(c,(A.get(j).size()===ad));},_uiSetTargets:function(ac){var A=this;A._uiSetMaxTargets(A.get(n));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:O},id:{readOnly:true,valueFn:function(){return p.guid();}},maxSources:{setter:"_setMaxSources",value:1,validator:Z},maxTargets:{setter:"_setMaxTargets",value:1,validator:Z},node:{setter:"_setNode",valueFn:function(){var A=this;return p.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return C(A)||R(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return C(A)||R(A);}}},getAnchorByNode:function(A){return d(A)?A:p.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});AUI.add("aui-diagram-builder",function(a){},"@VERSION@",{use:["aui-diagram-builder-base","aui-diagram-builder-impl","aui-diagram-builder-connector"],skinnable:true});