AUI.add("aui-diagram-builder-base",function(ae){var U=ae.Lang,d=U.isArray,aq=U.isBoolean,M=U.isNumber,B=U.isObject,au=U.isString,I=function(A){return(A instanceof ae.ArrayList);},S=function(A){return(A instanceof ae.Node);},D=function(A){return(A instanceof ae.AvailableField);},aE=ae.Array,P="maxFields",W="add",k="addNode",aD="auto",N="availableField",R="availableFields",aA="availableFieldsDragConfig",an="base",s="boundingBox",ax="builder",aa="cancel",ar="clearfix",a="container",ac="content",u="contentBox",J="viewport",Q="contentNode",E="createDocumentFragment",z="diagram",F="diagram-builder-base",ab="disk",o="draggable",az="drop",al="dropConfig",Z="dropContainer",ap="field",t="fields",n="fieldsContainer",ao="height",p="helper",X="icon",v="iconClass",ak="id",ag="label",aj="list",r="node",y="nodeSettings",ad="propertyList",ay="rendered",am="save",q="settings",O="tab",b="tabs",e="tabview",G="tabView",L="toolbar",j="toolbarContainer",w=ae.getClassName,aC=" ",g=".",H="$",h="#",aF=w(z,ax,an,az,a),x=w(z,ax,an,J),C=w(z,ax,an,ap),f=w(z,ax,an,t,a),ah=w(z,ax,an,ap,o),c=w(z,ax,an,ap,X),V=w(z,ax,an,ap,ag),m=w(z,ax,an,b,a),Y=w(z,ax,an,b,a,ac),ai=w(z,ax,an,O,W),K=w(z,ax,an,O,q),av=w(z,ax,an,L,a),af=w(p,ar),l=w(X),aw=w(e,ac),aB=w(e,aj);var i=ae.Component.create({NAME:N,ATTRS:{draggable:{value:true,validator:aq},label:{validator:au},iconClass:{validator:au},id:{value:ae.guid(),setter:"_setId",validator:au},node:{valueFn:function(aG){var A=this;if(!S(aG)){aG=ae.Node.create(ae.Lang.sub(A.FIELD_ITEM_TEMPLATE,{iconClass:A.get(v)}));aG.setData(N,A);}return aG;},validator:S,writeOnce:true},type:{value:r,validator:au}},EXTENDS:ae.Base,buildNodeId:function(A){return R+H+ap+H+A;},getAvailableFieldByNode:function(A){return ae.one(A).getData(N);},getAvailableFieldById:function(A){return ae.AvailableField.getAvailableFieldByNode(h+ae.AvailableField.buildNodeId(A));},prototype:{FIELD_ITEM_TEMPLATE:'<li class="'+C+'">'+'<span class="'+[l,c].join(aC)+' {iconClass}"></span>'+'<span class="'+V+'"></span>'+"</li>",initializer:function(){var A=this;var aG=A.get(r);A.after({draggableChange:A._afterDraggableChange,idChange:A._afterIdChange,labelChange:A._afterLabelChange});A.labelNode=aG.one(g+V);A._uiSetDraggable(A.get(o));A._uiSetId(A.get(ak));A._uiSetLabel(A.get(ag));},_afterDraggableChange:function(aG){var A=this;A._uiSetDraggable(aG.newVal);},_afterIdChange:function(aG){var A=this;A._uiSetId(aG.newVal);},_afterLabelChange:function(aG){var A=this;A._uiSetLabel(aG.newVal);},_setId:function(A){return ae.AvailableField.buildNodeId(A);},_uiSetDraggable:function(aG){var A=this;A.get(r).toggleClass(ah,aG);},_uiSetLabel:function(aG){var A=this;A.labelNode.setContent(aG);},_uiSetId:function(aG){var A=this;A.get(r).set(ak,aG);}}});ae.AvailableField=i;var T=function(){};T.ATTRS={fields:{value:[],setter:"_setFields",validator:function(A){return d(A)||I(A);}},maxFields:{value:Infinity,validator:M}};ae.mix(T.prototype,{createFields:function(aH){var aG=this;var A=[];aE.each(aH,function(aJ,aI){if(aI<aG.get(P)){A.push(aG.createField(aJ));}});return new ae.ArrayList(A);},addField:function(aG){var A=this;if(A.get(t).size()<A.get(P)){var aH=A.createField(aG);if(aH){A._updateFields(A.get(t).add(aH));}return aH;}return null;},removeField:function(aG){var A=this;A._updateFields(A.get(t).remove(aG));},_updateFields:function(aG){var A=this;A.set(t,aG);},_setFields:function(aG){var A=this;if(I(aG)){return aG;}else{return A.createFields(aG);}},createField:function(A){return A;}});ae.FieldSupport=T;var at=ae.Component.create({NAME:F,ATTRS:{availableFields:{setter:"_setAvailableFields",validator:d},viewport:{valueFn:function(){return ae.Node.create(this.VIEWPORT_TEMPLATE);}},dropContainer:{valueFn:function(){return ae.Node.create(this.DROP_CONTAINER_TEMPLATE);}},dropConfig:{value:null,setter:"_setDropConfig",validator:B},availableFieldsDragConfig:{value:null,setter:"_setAvailableFieldsDragConfig",validator:B},fieldsContainer:{valueFn:function(){return ae.Node.create(this.FIELDS_CONTAINER_TEMPLATE);}},propertyList:{setter:"_setPropertyList",validator:B,value:null},strings:{value:{addNode:"Add node",cancel:"Cancel",nodeSettings:"Node settings",propertyName:"Property Name",save:"Save",value:"Value"}},tabView:{setter:"_setTabView",validator:B,value:null,writeOnce:true},toolbar:{setter:"_setToolbar",validator:B,value:null},toolbarContainer:{valueFn:function(){return ae.Node.create(this.TOOLBAR_CONTAINER_TEMPLATE);}}},HTML_PARSER:{dropContainer:g+aF,fieldsContainer:g+f,toolbarContainer:g+av,viewport:g+x},UI_ATTRS:[R,t],AUGMENTS:[ae.FieldSupport],prototype:{DROP_CONTAINER_TEMPLATE:'<div class="'+aF+'"></div>',TOOLBAR_CONTAINER_TEMPLATE:'<div class="'+av+'"></div>',FIELDS_CONTAINER_TEMPLATE:'<ul class="'+f+'"></ul>',VIEWPORT_TEMPLATE:'<div tabindex="1" class="'+x+'"></div>',fieldsNode:null,propertyList:null,settingsNode:null,tabView:null,toolbar:null,initializer:function(){var A=this;A.publish({cancel:{defaultFn:A._defCancelFn}});A.after({render:A._afterRender});A.after(A._afterUiSetHeight,A,"_uiSetHeight");A.viewport=A.get(J);A.dropContainer=A.get(Z);A.fieldsContainer=A.get(n);A.toolbarContainer=A.get(j);},isAvailableFieldsDrag:function(aH){var A=this;var aG=A.availableFieldsDrag;return(aH===aG.dd);},plotFields:function(){var aG=this;var A=aG.get(t);A.each(function(aH){aG.plotField(aH);});},renderUI:function(){var A=this;A._renderTabs();A._renderViewport();A._uiSetAvailableFields(A.get(R));},syncUI:function(){var A=this;var aG=A.get(u);A._setupDrop();A._setupAvailableFieldsDrag();aG.addClass(af);},_afterActiveTabChange:function(aH){var A=this;var aG=aH.newVal.get(Q);if(A.get(ay)&&(aG===A.settingsNode)){A._renderSettings();}},_afterRender:function(aG){var A=this;A.plotFields();},_afterUiSetHeight:function(aG){var A=this;A.dropContainer.setStyle(ao,M(aG)?aG+A.DEF_UNIT:aG);},_defCancelFn:function(aG){var A=this;A.tabView.selectTab(0);},_handleCancelEvent:function(){var A=this;A.fire(aa);},_handleSaveEvent:function(){var A=this;A.fire(am);},_renderViewport:function(){var aG=this;
var aH=aG.get(u);var A=aG.viewport;A.appendChild(aG.dropContainer);aH.appendChild(A);},_renderPropertyList:function(){var A=this;if(!A.propertyList){A.propertyList=new ae.PropertyList(A.get(ad)).render(A.settingsNode);A.propertyList.get(s).unselectable();}},_renderSettings:function(){var A=this;A._renderPropertyList();A._renderToolbar();},_renderTabs:function(){var A=this;if(!A.tabView){var aG=new ae.TabView(A.get(G));A.tabView=aG;A.fieldsNode=aG.getTab(0).get(Q);A.settingsNode=aG.getTab(1).get(Q);}},_renderToolbar:function(){var A=this;if(!A.toolbar){A.toolbar=new ae.Toolbar(A.get(L)).render(A.settingsNode);}},_setupDrop:function(){var A=this;A.drop=new ae.DD.Drop(A.get(al));},_setupAvailableFieldsDrag:function(){var A=this;A.availableFieldsDrag=new ae.DD.Delegate(A.get(aA));},_setAvailableFields:function(aH){var aG=this;var A=[];aE.each(aH,function(aJ,aI){A.push(D(aJ)?aJ:new ae.AvailableField(aJ));});return A;},_setDropConfig:function(aG){var A=this;return ae.merge({bubbleTargets:A,groups:[R],node:A.dropContainer},aG||{});},_setAvailableFieldsDragConfig:function(aG){var A=this;return ae.merge({bubbleTargets:A,container:A.get(s),dragConfig:{groups:[R],plugins:[{cfg:{moveOnEnd:false},fn:ae.Plugin.DDProxy}]},nodes:g+ah},aG||{});},_setPropertyList:function(aG){var A=this;return ae.merge({bubbleTargets:A,width:250,scroll:{height:400,width:aD}},aG);},_setTabView:function(aJ){var aG=this;var aI=aG.get(s);var aK=aI.one(g+aB);var aH={after:{activeTabChange:ae.bind(aG._afterActiveTabChange,aG)},boundingBox:aI.one(g+m),contentBox:aI.one(g+Y),bubbleTargets:aG,contentNode:aI.one(g+aw),cssClass:m,listNode:aK,render:aG.get(u)};if(!aK){var A=aG.getStrings();aH.items=[{cssClass:ai,label:A[k]},{cssClass:K,label:A[y]}];}return ae.merge(aH,aJ);},_setToolbar:function(aH){var aG=this;var A=aG.getStrings();return ae.merge({activeState:false,bubbleTargets:aG,children:[{handler:ae.bind(aG._handleSaveEvent,aG),label:A[am],icon:ab},{handler:ae.bind(aG._handleCancelEvent,aG),label:A[aa]}]},aH);},_uiSetAvailableFields:function(aI){var A=this;var aH=A.fieldsNode;if(aH){var aG=ae.getDoc().invoke(E);aE.each(aI,function(aJ){aG.appendChild(aJ.get(r));});aH.setContent(A.fieldsContainer.setContent(aG));}},_uiSetFields:function(aG){var A=this;if(A.get(ay)){A.plotFields();}}}});ae.DiagramBuilderBase=at;},"@VERSION@",{requires:["aui-tabs","aui-property-list","collection","dd"],skinnable:true});AUI.add("aui-diagram-builder-impl",function(aj){var Y=aj.Lang,c=Y.isArray,E=Y.isObject,aJ=Y.isString,aE=Y.isBoolean,aR=aj.Array,U=function(A){return(A instanceof aj.DiagramBuilderBase);},aF=function(A){return(A instanceof aj.DiagramNode);},af=function(A){return(A instanceof aj.Anchor);},ap=function(A,aU){var aT=c(aU)?aU:aU.getXY();var aV=c(A)?A:A.getXY();return aR.map(aV,function(aX,aW){return Math.max(0,aX-aT[aW]);});},an="addAnchor",aM="addAnchorMessage",j="addNode",ar="anchor",ak="anchors",ae="anchorsDragConfig",Q="availableField",V="boolean",o="boundingBox",aN="builder",ac="cancel",ay="click",aK="closeEvent",B="closeMessage",ah="content",J="controls",aw="controlsToolbar",av="data",ad="dblclick",T="delete",al="deleteMessage",aB="description",C="diagram",ag="diagram-builder",aq="diagramNode",x="diagram-node",aC="dragNode",M="editing",y="editEvent",H="editMessage",a="esc",aD="field",q="fields",ao="fieldsDragConfig",p="hover",ax="id",N="keydown",ai="link",aa="max",t="maxSources",r="mouseenter",W="mouseleave",m="name",n="node",au="p1",at="p2",d="parentNode",l="pencil",ab="records",k="recordset",h="region",aO="rendered",F="required",aG="selected",G="shuffle",O="source",aH="sources",aI="string",i="target",I="targets",K="tmpConnector",e="type",L="viewport",aL="wrapper",v="xy",aQ="-",g=".",P="",f="#",D="_",u=aj.getClassName,R=u(C,aN,ar,n,aa,I),am=u(C,aN,ar,p),aA=u(C,aN,ar,n),z=u(C,aN,ar,n,aL),s=u(C,aN,J),X=u(C,n),b=u(C,n,ah),az=u(C,n,M),aP=u(C,n,aG);var Z=function(){var aT="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",A="<br/>";aj.all(".aui-diagram-node").each(function(aZ){var aU=P,aW=aj.Widget.getByNode(aZ),aV=aW.get("name"),aY=aW.get("boundingBox"),aX=aY.one(".log")||aj.Node.create("<div class=log />").appendTo(aY);aU+=aV+A;aW.get(q).each(function(a0){aU+=aT+"a: "+a0.get("id")+A;a0.get("targets").each(function(a1){var a2=a1.get(aq);a1.get("node").setContent(a1.get("id"));aU+=aT+aT+"t: "+a2.get("name")+" (s: "+a1.get("id")+")"+A;});a0.get("sources").each(function(a2){var a1=a2.get(aq);a2.get("node").setContent(a2.get("id"));aU+=aT+aT+"s: "+a1.get("name")+" (t: "+a2.get("id")+")"+A;});});aX.setContent(aU);});};var w=aj.Component.create({NAME:ag,ATTRS:{fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:E},tmpConnector:{setter:"_setTmpConnector",value:{},validator:E}},EXTENDS:aj.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editNode:null,initializer:function(){var A=this;A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});A.handlerKeyDown=aj.getDoc().on(N,aj.bind(A._afterKeyEvent,A));A.dropContainer.delegate(ay,aj.bind(A._onNodeClick,A),g+X);A.dropContainer.delegate(ad,aj.bind(A._onNodeEdit,A),g+X);A.dropContainer.delegate(r,aj.bind(A._onMouseenterAnchors,A),g+aA);A.dropContainer.delegate(W,aj.bind(A._onMouseleaveAnchors,A),g+aA);},syncUI:function(){var A=this;aj.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.tmpConnector=new aj.Connector(A.get(K));},connect:function(aU,aW){var aT=this;if(aJ(aU)){aU=aj.Widget.getByNode(f+aj.DiagramNode.buildNodeId(aU));}if(aJ(aW)){aW=aj.Widget.getByNode(f+aj.DiagramNode.buildNodeId(aW));}if(aU&&aW){var aV=aU.findAvailableAnchor();var A=aW.findAvailableAnchor();if(aV&&A){aV.connect(A);}}return aT;},connectAll:function(aT){var A=this;aR.each(aT,function(aU){if(aU.hasOwnProperty(O)&&aU.hasOwnProperty(i)){A.connect(aU.source,aU.target);}});return A;},createField:function(aT){var A=this;if(!aF(aT)){aT.builder=A;aT.viewport=A.get(L);aT=new (A.getFieldClass(aT.type||n))(aT);}aT.set(aN,A);return aT;
},getFieldClass:function(aU){var A=this;var aT=aj.DiagramBuilder.types[aU];if(aT){return aT;}else{aj.log("The field type: ["+aU+"] couldn't be found.");return null;}},isFieldsDrag:function(aU){var A=this;var aT=A.fieldsDrag;return(aU===aT.dd);},plotField:function(aT){var A=this;if(!aT.get(aO)){aT.render(A.dropContainer);}},unselectAll:function(){var A=this;var aT=A.selectedNode;if(aT){aT.set(aG,false);}A.selectedNode=null;},select:function(aT){var A=this;A.unselectAll();A.selectedNode=aT.set(aG,true).focus();},startEditingNode:function(aT){var A=this;if(aT){A.stopEditingNode();A.tabView.selectTab(aj.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(k,aT.getProperties());aT.get(o).addClass(az);A.editNode=aT;}},stopEditingNode:function(aU){var A=this;var aT=aU||A.editNode;if(aT){A.tabView.selectTab(aj.DiagramBuilder.FIELDS_TAB);aT.get(o).removeClass(az);A.editNode=null;}},_afterKeyEvent:function(aT){var A=this;if(!A.selectedNode||aT.hasModifier()||!aT.isKeyInSet(a,T)){return;}if(aT.isKey(a)){A._onEscKey(aT);}else{if(aT.isKey(T)){A._onDeleteKey(aT);}}aT.halt();},_onCancel:function(aT){var A=this;A.stopEditingNode();},_onDrag:function(aU){var A=this;var aT=aU.target;if(A.isFieldsDrag(aT)){var aV=aj.Widget.getByNode(aT.get(aC));aV.get(q).each(function(aW){aW.alignConnectors();});}},_onDragEnd:function(aU){var A=this;var aT=aU.target;if(A.isFieldsDrag(aT)){var aV=aj.Widget.getByNode(aT.get(aC));aV.set(v,aV.getLeftTop());}},_onDropHit:function(aU){var A=this;var aT=aU.drag;if(A.isAvailableFieldsDrag(aT)){var aW=aT.get(n).getData(Q);var aV=A.addField({xy:ap(aT.lastXY,A.dropContainer),type:aW.get(e),fields:[{}]});A.select(aV);}},_onDeleteKey:function(aT){var A=this;var aU=A.selectedNode;if(!aU.get(F)){aU.close();}},_onEscKey:function(aT){var A=this;A.unselectAll();A.stopEditingNode();},_onMouseenterAnchors:function(aT){var A=this;aT.currentTarget.addClass(am);},_onMouseleaveAnchors:function(aT){var A=this;aT.currentTarget.removeClass(am);},_onNodeClick:function(aT){var A=this;var aU=aj.Widget.getByNode(aT.currentTarget);A.select(aU);},_onNodeEdit:function(aT){var A=this;if(!aT.target.ancestor(g+b,true)){return;}var aU=aj.Widget.getByNode(aT.currentTarget);if(aU){A.startEditingNode(aU);}},_onSave:function(aU){var A=this;var aT=A.editNode;var aV=A.propertyList.get(k);if(aT){aR.each(aV.get(ab),function(aW){var aX=aW.get(av);aT.set(aX.attributeName,aX.value);});A.stopEditingNode(aT);}},_setTmpConnector:function(aT){var A=this;return aj.merge({lazyDraw:true,viewport:A.viewport},aT);},_setFieldsDragConfig:function(aU){var A=this;var aT=A.dropContainer;return aj.merge({bubbleTargets:A,container:aT,dragConfig:{plugins:[{cfg:{constrain:aT},fn:aj.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:aj.Plugin.DDWinScroll}]},nodes:g+X},aU||{});},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new aj.DD.Delegate(A.get(ao));}}});aj.DiagramBuilder=w;aj.DiagramBuilder.types={};var S=aj.Component.create({NAME:x,EXTENDS:aj.Overlay,AUGMENTS:[aj.FieldSupport]});var aS=aj.Component.create({NAME:x,UI_ATTRS:[q,m,F,aG],ATTRS:{anchorsDragConfig:{value:null,setter:"_setAnchorsDragConfig",validator:E},builder:{setter:"_setBuilder",validator:U},required:{value:false,validator:aE},description:{value:P,validator:aJ},height:{value:90},name:{valueFn:function(){var A=this;return A.get(e)+(++aj.Env._uidx);},validator:aJ},selected:{value:false,validator:aE},strings:{value:{addAnchorMessage:"Add Anchor",closeMessage:"Close",deleteMessage:"Are you sure you want to delete?",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},type:{value:n,validator:aJ},controlsToolbar:{validator:E,valueFn:"_valueControlsToolbar"},width:{value:90},zIndex:{value:100},tabIndex:{value:1}},EXTENDS:S,buildNodeId:function(A){return aq+D+aD+D+A;},prototype:{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+z+'"></div>',CONTROLS_TEMPLATE:'<div class="'+s+'"></div>',initializer:function(){var A=this;A._renderNodes();A._setupAnchorsDrag();A.after({render:A._afterRender});A.on({"drag:drag":A._onAnchorDrag,"drag:end":A._onAnchorDragEnd,"drag:start":A._onAnchorDragStart,"drop:hit":A._onAnchorDropHit});A.get(o).addClass(X+aQ+A.get(e));A.set("bodyContent",A.get(m));},alignAnchors:function(){var aT=this;var aX=aT.get(q);var aV=aT.get(o).get(h),aW=Math.floor(360/aX.size()),aU=aV.width/2,A=aV.height/2,aZ=aV.left+aV.width/2,aY=aV.top+aV.height/2;aX.each(function(a3,a2){var a1=a3.get(n);var a4=a1.get(h);var a0=aT._getEllipseXY(aU,A,aZ,aY,a2*aW);a1.setXY([a0[0]-a4.width/2,a0[1]-a4.height/2]);a3.alignConnectors();});return aT;},close:function(){var aT=this;var A=aT.getStrings();if(confirm(A[al])){aT.get(q).each(function(aU){aU.destroy();});aT.destroy();}Z();return aT;},createField:function(aU){var A=this;if(!af(aU)){var aT=A.get(aN);aU.diagramNode=A;aU.viewport=(aT?aT.get(L):null);aU=new aj.Anchor(aU);}return aU;},findAvailableAnchor:function(){var A=this;var aT=null;A.get(q).some(function(aU){if(!aU.hasConnection()){aT=aU;return true;}});if(!aT){aT=A.addField({});}return aT;},getConnectionNode:function(){var A=this;return new aj.DiagramNode({xy:[100,100]});},getLeftTop:function(){var A=this;return ap(A.get(o),A._getContainer());},getProperties:function(){var A=this;var aT=A.getPropertyModel();aR.each(aT,function(aW){var aV=A.get(aW.attributeName),aU=Y.type(aV);if(aU===V||aU===aI){aV=String(aV);}aW.value=aV;});return aT;},getPropertyModel:function(){var aT=this;var A=aT.getStrings();return[{attributeName:aB,editor:new aj.TextAreaCellEditor(),name:A[aB]},{attributeName:m,editor:new aj.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[m]},{attributeName:e,editor:false,name:A[e]}];},syncDragTargets:function(){var A=this;A.anchorsDrag.syncTargets();},syncDropTargets:function(aT){var A=this;A.get(q).each(function(aV){var aU=aj.DD.DDM.getDrop(aV.get(n));if(aU){if(aV.get(aH).size()===aV.get(t)){aU.removeFromGroup(ak);}else{aU.addToGroup(ak);}}});},_afterRender:function(aT){var A=this;A.alignAnchors();A._renderControls();},_getContainer:function(){var A=this;return(A.get(aN).dropContainer||A.get(o).get(d));
},_getEllipseXY:function(aT,A,aW,aV,aX){var aU=aX*Math.PI/180;return[aW+aT*Math.cos(aU),aV-A*Math.sin(aU)];},_handleAddAnchorEvent:function(aT){var A=this;A.addField({});},_handleAddNodeEvent:function(aU){var A=this;var aT=A.get(aN);var aV=A.findAvailableAnchor();if(aV){var aW=A.getConnectionNode();aT.addField(aW);aV.connect(aW.addField({}));}},_handleEditEvent:function(aT){var A=this;A.get(aN).startEditingNode(A);},_handleCloseEvent:function(aT){var A=this;if(!A.get(F)){A.close();}},_onAnchorDrag:function(aU){var A=this;var aT=A.get(aN);aT.tmpConnector.set(at,aU.target.get(aC).getCenterXY());},_onAnchorDragEnd:function(aU){var A=this;var aT=A.get(aN).tmpConnector.shape;aT.clear();aT.end();},_onAnchorDragStart:function(aU){var A=this;var aT=A.get(aN);aT.tmpConnector.set(au,aU.target.get(n).getCenterXY());},_onAnchorDropHit:function(aT){var A=this;var aU=aj.Anchor.getAnchorByNode(aT.drag.get(n));var aV=aj.Anchor.getAnchorByNode(aT.drop.get(n));aU.connect(aV);Z();},_renderControls:function(){var A=this;var aT=A.get(o);A.controlsNode=aj.Node.create(A.CONTROLS_TEMPLATE).appendTo(aT);},_renderNodes:function(){var A=this;var aT=A.get(o);A.anchorWrapper=aj.Node.create(A.ANCHOR_WRAPPER_TEMPLATE).appendTo(aT);},_renderControlsToolbar:function(aT){var A=this;A.controlsToolbar=new aj.Toolbar(A.get(aw)).render(A.controlsNode);A._uiSetRequired(A.get(F));},_setBuilder:function(aT){var A=this;A.get(q).each(function(aU){aU.set(L,aT.get(L));});return aT;},_setAnchorsDragConfig:function(aU){var A=this;var aT=A.get(aN);return aj.merge({bubbleTargets:A,container:A.anchorWrapper,dragConfig:{groups:[ak],plugins:[{cfg:{constrain:(aT?aT.get(L):null)},fn:aj.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:aj.Plugin.DDWinScroll},{cfg:{moveOnEnd:false},fn:aj.Plugin.DDProxy}]},nodes:g+aA,target:true},aU||{});},_setupAnchorsDrag:function(){var A=this;A.anchorsDrag=new aj.DD.Delegate(A.get(ae));A.anchorsDrag.dd.addInvalid(g+R);},_uiSetFields:function(aT){var A=this;if(A.get(aO)){A.alignAnchors();A.syncDragTargets();A.syncDropTargets();}},_uiSetName:function(aU){var A=this;var aT=A.get(o);aT.set(ax,aj.DiagramNode.buildNodeId(aU));},_uiSetRequired:function(aV){var aU=this;var aT=aU.getStrings();var A=aU.controlsToolbar;if(A){if(aV){A.remove(aK);}else{A.add({handler:aj.bind(aU._handleCloseEvent,aU),icon:ac,id:aK,title:aT[B]});}}},_uiSetSelected:function(aT){var A=this;A.get(o).toggleClass(aP,aT);if(aT&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(aU){var A=this;var aT=A._getContainer().getXY();this._posNode.setXY([aU[0]+aT[0],aU[1]+aT[1]]);},_valueControlsToolbar:function(aU){var aT=this;var A=aT.getStrings();return{activeState:false,children:[{handler:aj.bind(aT._handleEditEvent,aT),icon:l,id:y,title:A[H]},{handler:aj.bind(aT._handleAddAnchorEvent,aT),icon:ai,id:an,title:A[aM]},{handler:aj.bind(aT._handleAddNodeEvent,aT),icon:G,id:j},{handler:aj.bind(aT._handleCloseEvent,aT),icon:ac,id:aK,title:A[B]}]};}}});aj.DiagramNode=aS;aj.DiagramBuilder.types[n]=aj.DiagramNode;},"@VERSION@",{requires:["aui-diagram-builder-base","overlay"],skinnable:true});AUI.add("aui-diagram-builder-connector",function(m){var Q=m.Lang,u=Q.isArray,y=Q.isBoolean,P=Q.isNumber,D=Q.isObject,j=Q.isString,G=m.Array,d=function(A){return(A instanceof m.Anchor);},H=function(A){return(A instanceof m.ArrayList);},p=function(A){return(A instanceof m.DiagramNode);},C="anchor",I="arrowPoints",F="body",J="boundingBox",R="builder",z="color",q="connector",a="dataAnchor",B="diagram",v="diagramNode",x="height",s="id",L="lazyDraw",M="max",l="maxSources",k="maxTargets",O="node",o="p1",n="p2",g="path",t="shape",i="sources",h="targets",E="viewport",c="width",N="wrapper",r=".",w=m.getClassName,b=w(B,R,C,O,M,h),f=w(B,R,C,O,M,i),e=w(B,R,C,O,N),K=w(B,R,C,O);m.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(X,S,Z,A,Y,V){var aa=this;X.moveTo(S,Z);X.lineTo(A,Y);var T=Math.atan2(Y-Z,A-S),W=(A+S)/2,U=(Y+Z)/2;aa.drawPolygon(X,aa.translatePoints(aa.rotatePoints(V||aa.ARROW_POINTS,T),W,U));},drawPolygon:function(S,T){var A=this;S.moveTo(T[0][0],T[0][1]);G.each(T,function(V,U){if(U>0){S.lineTo(T[U][0],T[U][1]);}});S.lineTo(T[0][0],T[0][1]);S.end();},translatePoints:function(T,S,V){var A=this;var U=[];G.each(T,function(X,W){U.push([T[W][0]+S,T[W][1]+V]);});return U;},rotatePoints:function(S,U){var A=this;var T=[];G.each(S,function(W,V){T.push(A.rotatePoint(U,S[V][0],S[V][1]));});return T;},rotatePoint:function(S,A,T){return[(A*Math.cos(S))-(T*Math.sin(S)),(A*Math.sin(S))+(T*Math.cos(S))];}};m.Connector=m.Base.create("line",m.Base,[],{graphics:null,shape:null,initializer:function(S){var A=this;A.after({p1Change:A.draw,p2Change:A.draw});A._initGraphics();A._initShapes();if(!A.get(L)){A.draw();}},destroy:function(){var A=this;A.graphics.destroy();},draw:function(){var A=this;var S=A.shape;var U=A.getCoordinate(A.get(o));var T=A.getCoordinate(A.get(n));S.clear();m.PolygonUtil.drawLineArrow(S,U[0],U[1],T[0],T[1],A.get(I));},getCoordinate:function(T){var A=this;var S=A.get(E).getXY();return[T[0]-S[0],T[1]-S[1]];},_initGraphics:function(){var A=this;var S=new m.Graphic({width:A.get(c),height:A.get(x),render:A.get(E)});A.graphics=S;},_initShapes:function(){var A=this;A.shape=A.graphics.getShape(A.get(t));},_setShape:function(S){var A=this;return m.merge({type:g,stroke:{color:A.get(z),weight:2},fill:{color:A.get(z)}},S);}},{ATTRS:{color:{value:"#666",validator:j},lazyDraw:{value:false,validator:y},viewport:{setter:m.one,value:F},shape:{value:null,setter:"_setShape"},arrowPoints:{value:m.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:u},p2:{value:[0,0],validator:u}}});m.Anchor=m.Base.create("anchor",m.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+e+'"></div>',NODE_TEMPLATE:'<div class="'+K+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(k));},addSource:function(S){var A=this;
if(A.get(i).size()<A.get(l)){A.set(i,A.get(i).remove(S).add(S));}return A;},addTarget:function(S){var A=this;if(A.get(h).size()<A.get(k)){A.set(h,A.get(h).remove(S).add(S));}return A;},alignConnectors:function(){var A=this;A.get(h).each(function(S){var T=A.getConnector(S);if(T){T.set(o,A.getCenterXY());T.set(n,S.getCenterXY());}});A.get(i).each(function(S){var T=S.getConnector(A);if(T){T.set(o,S.getCenterXY());T.set(n,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(O).remove();},connect:function(S){var A=this;if(p(S)){S=S.findAvailableAnchor();}A.addTarget(S);S.addSource(A);if(!A.isConnected(S)){var T=S.get(q);T.p1=A.getCenterXY();T.p2=S.getCenterXY();A.connectors[S.get(s)]=new m.Connector(T);}setTimeout(function(){S.get(v).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(h).each(m.bind(A.connect,A));return A;},disconnect:function(S){var A=this;A.getConnector(S).destroy();A.removeTarget(S);S.removeSource(A);setTimeout(function(){S.get(v).syncDropTargets();},50);},disconnectTargets:function(){var A=this;A.get(h).each(function(S){A.disconnect(S);});return A;},disconnectSources:function(){var A=this;A.get(i).each(function(S){S.disconnect(A);});return A;},getCenterXY:function(){var A=this;return A.get(O).getCenterXY();},getConnector:function(S){var A=this;return A.connectors[S.get(s)];},hasConnection:function(){var A=this;return((A.get(h).size()>0)||(A.get(i).size()>0));},isConnected:function(S){var A=this;return A.connectors.hasOwnProperty(S.get(s));},removeSource:function(S){var A=this;A.set(i,A.get(i).remove(S));return A;},removeTarget:function(S){var A=this;A.set(h,A.get(h).remove(S));return A;},_afterSourcesChange:function(S){var A=this;A._uiSetSources(S.newVal);},_afterTargetsChange:function(S){var A=this;S.prevVal.each(function(T){T.removeSource(A);});S.newVal.each(function(T){T.addSource(A);});A._uiSetTargets(S.newVal);},_renderNode:function(){var A=this;var T=A.get(v);var S=T.get(J);A.wrapper=S.one(r+e)||m.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(S).appendChild(A.get(O));},_setConnector:function(S){var A=this;return m.merge({viewport:A.get(E)},S);},_setSources:function(S){var A=this;return A._setAnchors(S);},_setTargets:function(S){var A=this;S=A._setAnchors(S,true);S.each(function(T){T.addSource(A);});return S;},_setAnchors:function(U,T){var A=this;if(!H(U)){var S=[];m.Array.some(U,function(W,V){if(V>=A.get(W?k:l)){return true;}S.push(d(W)?W:new m.Anchor(W));});U=new m.ArrayList(S);}return U;},_setMaxSources:function(S){var A=this;A._uiSetMaxSources(A.get(l));return S;},_setMaxTargets:function(S){var A=this;A._uiSetMaxTargets(A.get(k));return S;},_setNode:function(S){var A=this;var T=A.get(s);return m.one(S).set(s,T).setData(a,A);},_uiSetSources:function(S){var A=this;A._uiSetMaxSources(A.get(l));},_uiSetMaxSources:function(T){var A=this;var S=A.get(O);S.toggleClass(f,(A.get(i).size()===T));},_uiSetMaxTargets:function(T){var A=this;var S=A.get(O);S.toggleClass(b,(A.get(h).size()===T));},_uiSetTargets:function(S){var A=this;A._uiSetMaxTargets(A.get(k));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:D},id:{readOnly:true,valueFn:function(){return m.guid();}},maxSources:{setter:"_setMaxSources",value:1,validator:P},maxTargets:{setter:"_setMaxTargets",value:1,validator:P},node:{setter:"_setNode",valueFn:function(){var A=this;return m.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return u(A)||H(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return u(A)||H(A);}},viewport:{setter:m.one,value:F}},getAnchorByNode:function(A){return d(A)?A:m.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});AUI.add("aui-diagram-builder",function(a){},"@VERSION@",{use:["aui-diagram-builder-base","aui-diagram-builder-impl","aui-diagram-builder-connector"],skinnable:true});