AUI.add("aui-diagram-builder-base",function(ae){var T=ae.Lang,d=T.isArray,aq=T.isBoolean,L=T.isNumber,B=T.isObject,au=T.isString,I=function(A){return(A instanceof ae.ArrayList);},R=function(A){return(A instanceof ae.Node);},D=function(A){return(A instanceof ae.AvailableField);},aE=ae.Array,O="maxFields",V="add",k="addNode",aD="auto",M="availableField",Q="availableFields",aA="availableFieldsDragConfig",an="base",s="boundingBox",ax="builder",Z="cancel",ar="clearfix",a="container",ac="content",u="contentBox",ab="canvas",P="contentNode",E="createDocumentFragment",z="diagram",F="diagram-builder-base",aa="disk",o="draggable",az="drop",al="dropConfig",Y="dropContainer",ap="field",t="fields",n="fieldsContainer",ao="height",p="helper",W="icon",v="iconClass",ak="id",ag="label",aj="list",r="node",y="nodeSettings",ad="propertyList",ay="rendered",am="save",q="settings",N="tab",b="tabs",e="tabview",G="tabView",K="toolbar",j="toolbarContainer",w=ae.getClassName,aC=" ",g=".",H="$",h="#",aF=w(z,ax,an,az,a),x=w(z,ax,an,ab),C=w(z,ax,an,ap),f=w(z,ax,an,t,a),ah=w(z,ax,an,ap,o),c=w(z,ax,an,ap,W),U=w(z,ax,an,ap,ag),m=w(z,ax,an,b,a),X=w(z,ax,an,b,a,ac),ai=w(z,ax,an,N,V),J=w(z,ax,an,N,q),av=w(z,ax,an,K,a),af=w(p,ar),l=w(W),aw=w(e,ac),aB=w(e,aj);var i=ae.Component.create({NAME:M,ATTRS:{draggable:{value:true,validator:aq},label:{validator:au},iconClass:{validator:au},id:{value:ae.guid(),setter:"_setId",validator:au},node:{valueFn:function(aG){var A=this;if(!R(aG)){aG=ae.Node.create(ae.Lang.sub(A.FIELD_ITEM_TEMPLATE,{iconClass:A.get(v)}));aG.setData(M,A);}return aG;},validator:R,writeOnce:true},type:{value:r,validator:au}},EXTENDS:ae.Base,buildNodeId:function(A){return Q+H+ap+H+A;},getAvailableFieldByNode:function(A){return ae.one(A).getData(M);},getAvailableFieldById:function(A){return ae.AvailableField.getAvailableFieldByNode(h+ae.AvailableField.buildNodeId(A));},prototype:{FIELD_ITEM_TEMPLATE:'<li class="'+C+'">'+'<span class="'+[l,c].join(aC)+' {iconClass}"></span>'+'<span class="'+U+'"></span>'+"</li>",initializer:function(){var A=this;var aG=A.get(r);A.after({draggableChange:A._afterDraggableChange,idChange:A._afterIdChange,labelChange:A._afterLabelChange});A.labelNode=aG.one(g+U);A._uiSetDraggable(A.get(o));A._uiSetId(A.get(ak));A._uiSetLabel(A.get(ag));},_afterDraggableChange:function(aG){var A=this;A._uiSetDraggable(aG.newVal);},_afterIdChange:function(aG){var A=this;A._uiSetId(aG.newVal);},_afterLabelChange:function(aG){var A=this;A._uiSetLabel(aG.newVal);},_setId:function(A){return ae.AvailableField.buildNodeId(A);},_uiSetDraggable:function(aG){var A=this;A.get(r).toggleClass(ah,aG);},_uiSetLabel:function(aG){var A=this;A.labelNode.setContent(aG);},_uiSetId:function(aG){var A=this;A.get(r).set(ak,aG);}}});ae.AvailableField=i;var S=function(){};S.ATTRS={fields:{value:[],setter:"_setFields",validator:function(A){return d(A)||I(A);}},maxFields:{value:Infinity,validator:L}};ae.mix(S.prototype,{createFields:function(aH){var aG=this;var A=[];aE.each(aH,function(aJ,aI){if(aI<aG.get(O)){A.push(aG.createField(aJ));}});return new ae.ArrayList(A);},addField:function(aG){var A=this;if(A.get(t).size()<A.get(O)){var aH=A.createField(aG);if(aH){A._updateFields(A.get(t).add(aH));}return aH;}return null;},removeField:function(aG){var A=this;A._updateFields(A.get(t).remove(aG));},_updateFields:function(aG){var A=this;A.set(t,aG);},_setFields:function(aG){var A=this;if(I(aG)){return aG;}else{return A.createFields(aG);}},createField:function(A){return A;}});ae.FieldSupport=S;var at=ae.Component.create({NAME:F,ATTRS:{availableFields:{setter:"_setAvailableFields",validator:d},canvas:{valueFn:function(){return ae.Node.create(this.CANVAS_TEMPLATE);}},dropContainer:{valueFn:function(){return ae.Node.create(this.DROP_CONTAINER_TEMPLATE);}},dropConfig:{value:null,setter:"_setDropConfig",validator:B},availableFieldsDragConfig:{value:null,setter:"_setAvailableFieldsDragConfig",validator:B},fieldsContainer:{valueFn:function(){return ae.Node.create(this.FIELDS_CONTAINER_TEMPLATE);}},propertyList:{setter:"_setPropertyList",validator:B,value:null},strings:{value:{addNode:"Add node",cancel:"Cancel",nodeSettings:"Node settings",propertyName:"Property Name",save:"Save",value:"Value"}},tabView:{setter:"_setTabView",validator:B,value:null,writeOnce:true},toolbar:{setter:"_setToolbar",validator:B,value:null},toolbarContainer:{valueFn:function(){return ae.Node.create(this.TOOLBAR_CONTAINER_TEMPLATE);}}},HTML_PARSER:{dropContainer:g+aF,fieldsContainer:g+f,toolbarContainer:g+av,canvas:g+x},UI_ATTRS:[Q,t],AUGMENTS:[ae.FieldSupport],prototype:{DROP_CONTAINER_TEMPLATE:'<div class="'+aF+'"></div>',TOOLBAR_CONTAINER_TEMPLATE:'<div class="'+av+'"></div>',FIELDS_CONTAINER_TEMPLATE:'<ul class="'+f+'"></ul>',CANVAS_TEMPLATE:'<div tabindex="1" class="'+x+'"></div>',fieldsNode:null,propertyList:null,settingsNode:null,tabView:null,toolbar:null,initializer:function(){var A=this;A.publish({cancel:{defaultFn:A._defCancelFn}});A.after({render:A._afterRender});A.after(A._afterUiSetHeight,A,"_uiSetHeight");A.canvas=A.get(ab);A.dropContainer=A.get(Y);A.fieldsContainer=A.get(n);A.toolbarContainer=A.get(j);},isAvailableFieldsDrag:function(aH){var A=this;var aG=A.availableFieldsDrag;return(aH===aG.dd);},plotFields:function(){var aG=this;var A=aG.get(t);A.each(function(aH){aG.plotField(aH);});},renderUI:function(){var A=this;A._renderTabs();A._renderCanvas();A._uiSetAvailableFields(A.get(Q));},syncUI:function(){var A=this;var aG=A.get(u);A._setupDrop();A._setupAvailableFieldsDrag();aG.addClass(af);},_afterActiveTabChange:function(aH){var A=this;var aG=aH.newVal.get(P);if(A.get(ay)&&(aG===A.settingsNode)){A._renderSettings();}},_afterRender:function(aG){var A=this;A.plotFields();},_afterUiSetHeight:function(aG){var A=this;A.dropContainer.setStyle(ao,L(aG)?aG+A.DEF_UNIT:aG);},_defCancelFn:function(aG){var A=this;A.tabView.selectTab(0);},_handleCancelEvent:function(){var A=this;A.fire(Z);},_handleSaveEvent:function(){var A=this;A.fire(am);},_renderCanvas:function(){var A=this;
var aG=A.get(u);var aH=A.canvas;aH.appendChild(A.dropContainer);aG.appendChild(aH);},_renderPropertyList:function(){var A=this;if(!A.propertyList){A.propertyList=new ae.PropertyList(A.get(ad)).render(A.settingsNode);A.propertyList.get(s).unselectable();}},_renderSettings:function(){var A=this;A._renderPropertyList();A._renderToolbar();},_renderTabs:function(){var A=this;if(!A.tabView){var aG=new ae.TabView(A.get(G));A.tabView=aG;A.fieldsNode=aG.getTab(0).get(P);A.settingsNode=aG.getTab(1).get(P);}},_renderToolbar:function(){var A=this;if(!A.toolbar){A.toolbar=new ae.Toolbar(A.get(K)).render(A.settingsNode);}},_setupDrop:function(){var A=this;A.drop=new ae.DD.Drop(A.get(al));},_setupAvailableFieldsDrag:function(){var A=this;A.availableFieldsDrag=new ae.DD.Delegate(A.get(aA));},_setAvailableFields:function(aH){var aG=this;var A=[];aE.each(aH,function(aJ,aI){A.push(D(aJ)?aJ:new ae.AvailableField(aJ));});return A;},_setDropConfig:function(aG){var A=this;return ae.merge({bubbleTargets:A,groups:[Q],node:A.dropContainer},aG||{});},_setAvailableFieldsDragConfig:function(aG){var A=this;return ae.merge({bubbleTargets:A,container:A.get(s),dragConfig:{groups:[Q],plugins:[{cfg:{moveOnEnd:false},fn:ae.Plugin.DDProxy}]},nodes:g+ah},aG||{});},_setPropertyList:function(aG){var A=this;return ae.merge({bubbleTargets:A,width:250,scroll:{height:400,width:aD}},aG);},_setTabView:function(aJ){var aG=this;var aI=aG.get(s);var aK=aI.one(g+aB);var aH={after:{activeTabChange:ae.bind(aG._afterActiveTabChange,aG)},boundingBox:aI.one(g+m),contentBox:aI.one(g+X),bubbleTargets:aG,contentNode:aI.one(g+aw),cssClass:m,listNode:aK,render:aG.get(u)};if(!aK){var A=aG.getStrings();aH.items=[{cssClass:ai,label:A[k]},{cssClass:J,label:A[y]}];}return ae.merge(aH,aJ);},_setToolbar:function(aH){var aG=this;var A=aG.getStrings();return ae.merge({activeState:false,bubbleTargets:aG,children:[{handler:ae.bind(aG._handleSaveEvent,aG),label:A[am],icon:aa},{handler:ae.bind(aG._handleCancelEvent,aG),label:A[Z]}]},aH);},_uiSetAvailableFields:function(aI){var A=this;var aH=A.fieldsNode;if(aH){var aG=ae.getDoc().invoke(E);aE.each(aI,function(aJ){aG.appendChild(aJ.get(r));});aH.setContent(A.fieldsContainer.setContent(aG));}},_uiSetFields:function(aG){var A=this;if(A.get(ay)){A.plotFields();}}}});ae.DiagramBuilderBase=at;},"@VERSION@",{requires:["aui-tabs","aui-property-list","collection","dd"],skinnable:true});AUI.add("aui-diagram-builder-impl",function(am){var aa=am.Lang,c=aa.isArray,F=aa.isObject,aM=aa.isString,aH=aa.isBoolean,aU=am.Array,U=function(A){return(A instanceof am.DiagramBuilderBase);},aI=function(A){return(A instanceof am.DiagramNode);},ai=function(A){return(A instanceof am.Anchor);},ar=function(A,aX){var aW=c(aX)?aX:aX.getXY();var aY=c(A)?A:A.getXY();return aU.map(aY,function(a0,aZ){return Math.max(0,a0-aW[aZ]);});},Y="activeElement",ap="addAnchor",aP="addAnchorMessage",j="addNode",au="anchor",an="anchors",ah="anchorsDragConfig",Q="availableField",W="boolean",p="boundingBox",aQ="builder",ae="cancel",af="canvas",aB="click",aN="closeEvent",C="closeMessage",ak="content",K="controls",az="controlsToolbar",ay="data",ag="dblclick",T="delete",ax="deleteConnectorsMessage",n="deleteNodesMessage",aE="description",D="diagram",aj="diagram-builder",at="diagramNode",y="diagram-node",aF="dragNode",M="editing",z="editEvent",I="editMessage",a="esc",aG="field",r="fields",aq="fieldsDragConfig",V="graphic",q="hover",aA="id",N="keydown",al="link",ac="max",u="maxSources",s="mouseenter",X="mouseleave",m="name",o="node",aw="p1",av="p2",d="parentNode",l="pencil",ad="records",k="recordset",h="region",aR="rendered",G="required",aK="selected",H="shuffle",O="source",aJ="sources",aL="string",i="target",J="targets",L="tmpConnector",e="type",aO="wrapper",w="xy",aT="-",g=".",P="",f="#",E="_",v=am.getClassName,R=v(D,aQ,au,o,ac,J),ao=v(D,aQ,au,q),aD=v(D,aQ,au,o),B=v(D,aQ,au,o,aO),t=v(D,aQ,K),Z=v(D,o),b=v(D,o,ak),aC=v(D,o,M),aS=v(D,o,aK);var ab=function(){var aW="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",A="<br/>";am.all(".aui-diagram-node").each(function(a2){var aX=P,aZ=am.Widget.getByNode(a2),aY=aZ.get("name"),a1=aZ.get("boundingBox"),a0=a1.one(".log")||am.Node.create("<div class=log />").appendTo(a1);aX+=aY+A;aZ.get(r).each(function(a3){aX+=aW+"a: "+a3.get("id")+A;a3.get("targets").each(function(a4){var a5=a4.get(at);a4.get("node").setContent(a4.get("id"));aX+=aW+aW+"t: "+a5.get("name")+" (s: "+a4.get("id")+")"+A;});a3.get("sources").each(function(a5){var a4=a5.get(at);a5.get("node").setContent(a5.get("id"));aX+=aW+aW+"s: "+a4.get("name")+" (t: "+a5.get("id")+")"+A;});});a0.setContent(aX);});};var x=am.Component.create({NAME:aj,ATTRS:{fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:F},graphic:{valueFn:function(){return new am.Graphic();},validator:F},strings:{value:{addNode:"Add node",cancel:"Cancel",deleteConnectorsMessage:"Are you sure you want to delete the selected connector(s)?",nodeSettings:"Node settings",propertyName:"Property Name",save:"Save",value:"Value"}},tmpConnector:{setter:"_setTmpConnector",value:{},validator:F}},EXTENDS:am.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editNode:null,initializer:function(){var A=this;A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});A.handlerKeyDown=am.getDoc().on(N,am.bind(A._afterKeyEvent,A));A.dropContainer.delegate(aB,am.bind(A._onNodeClick,A),g+Z);A.dropContainer.delegate(ag,am.bind(A._onNodeEdit,A),g+Z);A.dropContainer.delegate(s,am.bind(A._onMouseenterAnchors,A),g+aD);A.dropContainer.delegate(X,am.bind(A._onMouseleaveAnchors,A),g+aD);},renderUI:function(){var A=this;am.DiagramBuilder.superclass.renderUI.apply(this,arguments);A._renderGraphic();},syncUI:function(){var A=this;am.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.tmpConnector=new am.Connector(A.get(L));},connect:function(aX,aZ){var aW=this;if(aM(aX)){aX=am.Widget.getByNode(f+am.DiagramNode.buildNodeId(aX));}if(aM(aZ)){aZ=am.Widget.getByNode(f+am.DiagramNode.buildNodeId(aZ));
}if(aX&&aZ){var aY=aX.findAvailableAnchor();var A=aZ.findAvailableAnchor();if(aY&&A){aY.connect(A);}}return aW;},connectAll:function(aW){var A=this;aU.each(aW,function(aX){if(aX.hasOwnProperty(O)&&aX.hasOwnProperty(i)){A.connect(aX.source,aX.target);}});return A;},createField:function(aW){var A=this;if(!aI(aW)){aW.builder=A;aW=new (A.getFieldClass(aW.type||o))(aW);}aW.set(aQ,A);return aW;},deleteConnectors:function(aW){var A=this;aU.each(aW,function(aX){var aY=aX.get(au);if(aY){var aZ=aY.findConnectorTarget(aX);if(aZ){aY.disconnect(aZ);}}});},eachConnetor:function(aX){var A=this;var aW=false;A.get(r).some(function(aY){aY.get(r).some(function(aZ){am.some(aZ.connectors,function(a0){aW=aX.call(A,a0,aZ,aY);return aW;});return aW;});return aW;});},getSelectedConnectors:function(){var A=this;var aW=[];A.eachConnetor(function(aX){if(aX.get(aK)){aW.push(aX);}});return aW;},getFieldClass:function(aX){var A=this;var aW=am.DiagramBuilder.types[aX];if(aW){return aW;}else{am.log("The field type: ["+aX+"] couldn't be found.");return null;}},isFieldsDrag:function(aX){var A=this;var aW=A.fieldsDrag;return(aX===aW.dd);},plotField:function(aW){var A=this;if(!aW.get(aR)){aW.render(A.dropContainer);}},unselectConnectors:function(){var A=this;aU.each(A.getSelectedConnectors(),function(aW){aW.set(aK,false);});},unselectFields:function(){var A=this;var aW=A.selectedNode;if(aW){aW.set(aK,false);}A.selectedNode=null;},select:function(aW){var A=this;A.unselectFields();A.selectedNode=aW.set(aK,true).focus();},startEditingNode:function(aW){var A=this;if(aW){A.stopEditingNode();A.tabView.selectTab(am.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(k,aW.getProperties());aW.get(p).addClass(aC);A.editNode=aW;}},stopEditingNode:function(aX){var A=this;var aW=aX||A.editNode;if(aW){A.tabView.selectTab(am.DiagramBuilder.FIELDS_TAB);aW.get(p).removeClass(aC);A.editNode=null;}},_afterKeyEvent:function(aW){var A=this;if(aW.hasModifier()||am.getDoc().get(Y).test(":input,td")){return;}if(aW.isKey(a)){A._onEscKey(aW);}else{if(aW.isKey(T)){A._onDeleteKey(aW);}}},_onCancel:function(aW){var A=this;A.stopEditingNode();},_onDrag:function(aX){var A=this;var aW=aX.target;if(A.isFieldsDrag(aW)){var aY=am.Widget.getByNode(aW.get(aF));aY.get(r).each(function(aZ){aZ.alignConnectors();});}},_onDragEnd:function(aX){var A=this;var aW=aX.target;if(A.isFieldsDrag(aW)){var aY=am.Widget.getByNode(aW.get(aF));aY.set(w,aY.getLeftTop());}},_onDropHit:function(aX){var A=this;var aW=aX.drag;if(A.isAvailableFieldsDrag(aW)){var aZ=aW.get(o).getData(Q);var aY=A.addField({xy:ar(aW.lastXY,A.dropContainer),type:aZ.get(e),fields:[{}]});A.select(aY);}},_onDeleteKey:function(aY){var aW=this;var A=aW.getStrings();var aX=aW.getSelectedConnectors();if(aX.length&&confirm(A[ax])){aW.deleteConnectors(aX);}var aZ=aW.selectedNode;if(aZ){if(!aZ.get(G)){aZ.close();}}aY.halt();},_onEscKey:function(aW){var A=this;A.unselectConnectors();A.unselectFields();A.stopEditingNode();aW.halt();},_onMouseenterAnchors:function(aW){var A=this;aW.currentTarget.addClass(ao);},_onMouseleaveAnchors:function(aW){var A=this;aW.currentTarget.removeClass(ao);},_onNodeClick:function(aW){var A=this;var aX=am.Widget.getByNode(aW.currentTarget);A.select(aX);},_onNodeEdit:function(aW){var A=this;if(!aW.target.ancestor(g+b,true)){return;}var aX=am.Widget.getByNode(aW.currentTarget);if(aX){A.startEditingNode(aX);}},_onSave:function(aX){var A=this;var aW=A.editNode;var aY=A.propertyList.get(k);if(aW){aU.each(aY.get(ad),function(aZ){var a0=aZ.get(ay);aW.set(a0.attributeName,a0.value);});A.stopEditingNode(aW);}},_renderGraphic:function(){var A=this;A.get(V).render(A.get(af));},_setTmpConnector:function(aX){var A=this;var aW=A.get(af).getXY();return am.merge({p1:aW,p2:aW,lazyDraw:true,graphic:A.get(V)},aX);},_setFieldsDragConfig:function(aX){var A=this;var aW=A.dropContainer;return am.merge({bubbleTargets:A,container:aW,dragConfig:{plugins:[{cfg:{constrain:aW},fn:am.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:am.Plugin.DDWinScroll}]},nodes:g+Z},aX||{});},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new am.DD.Delegate(A.get(aq));}}});am.DiagramBuilder=x;am.DiagramBuilder.types={};var S=am.Component.create({NAME:y,EXTENDS:am.Overlay,AUGMENTS:[am.FieldSupport]});var aV=am.Component.create({NAME:y,UI_ATTRS:[r,m,G,aK],ATTRS:{anchorsDragConfig:{value:null,setter:"_setAnchorsDragConfig",validator:F},builder:{validator:U},required:{value:false,validator:aH},description:{value:P,validator:aM},height:{value:90},name:{valueFn:function(){var A=this;return A.get(e)+(++am.Env._uidx);},validator:aM},selected:{value:false,validator:aH},strings:{value:{addAnchorMessage:"Add Anchor",closeMessage:"Close",deleteNodesMessage:"Are you sure you want to delete the selected node(s)?",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},type:{value:o,validator:aM},controlsToolbar:{validator:F,valueFn:"_valueControlsToolbar"},width:{value:90},zIndex:{value:100},tabIndex:{value:1}},EXTENDS:S,buildNodeId:function(A){return at+E+aG+E+A;},prototype:{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+B+'"></div>',CONTROLS_TEMPLATE:'<div class="'+t+'"></div>',initializer:function(){var A=this;A._renderNodes();A._setupAnchorsDrag();A.after({render:A._afterRender});A.on({"drag:drag":A._onAnchorDrag,"drag:end":A._onAnchorDragEnd,"drag:start":A._onAnchorDragStart,"drop:hit":A._onAnchorDropHit});A.get(p).addClass(Z+aT+A.get(e));A.set("bodyContent",A.get(m));},alignAnchors:function(){var aW=this;var a0=aW.get(r);var aY=aW.get(p).get(h),aZ=Math.floor(360/a0.size()),aX=aY.width/2,A=aY.height/2,a2=aY.left+aY.width/2,a1=aY.top+aY.height/2;a0.each(function(a6,a5){var a4=a6.get(o);var a7=a4.get(h);var a3=aW._getEllipseXY(aX,A,a2,a1,a5*aZ);a4.setXY([a3[0]-a7.width/2,a3[1]-a7.height/2]);a6.alignConnectors();});return aW;},close:function(){var aW=this;var A=aW.getStrings();if(confirm(A[n])){aW.get(r).each(function(aX){aX.destroy();});aW.destroy();}return aW;},createField:function(aX){var A=this;if(!ai(aX)){var aW=A.get(aQ);aX.diagramNode=A;
aX=new am.Anchor(aX);}return aX;},findAvailableAnchor:function(){var A=this;var aW=null;A.get(r).some(function(aX){if(!aX.hasConnection()){aW=aX;return true;}});if(!aW){aW=A.addField({});}return aW;},getConnectionNode:function(){var A=this;return new am.DiagramNode({xy:[100,100]});},getLeftTop:function(){var A=this;return ar(A.get(p),A._getContainer());},getProperties:function(){var A=this;var aW=A.getPropertyModel();aU.each(aW,function(aZ){var aY=A.get(aZ.attributeName),aX=aa.type(aY);if(aX===W||aX===aL){aY=String(aY);}aZ.value=aY;});return aW;},getPropertyModel:function(){var aW=this;var A=aW.getStrings();return[{attributeName:aE,editor:new am.TextAreaCellEditor(),name:A[aE]},{attributeName:m,editor:new am.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[m]},{attributeName:e,editor:false,name:A[e]}];},syncDragTargets:function(){var A=this;A.anchorsDrag.syncTargets();},syncDropTargets:function(aW){var A=this;A.get(r).each(function(aY){var aX=am.DD.DDM.getDrop(aY.get(o));if(aX){if(aY.get(aJ).size()===aY.get(u)){aX.removeFromGroup(an);}else{aX.addToGroup(an);}}});},_afterRender:function(aW){var A=this;A.alignAnchors();A._renderControls();},_getContainer:function(){var A=this;return(A.get(aQ).dropContainer||A.get(p).get(d));},_getEllipseXY:function(aW,A,aZ,aY,a0){var aX=a0*Math.PI/180;return[aZ+aW*Math.cos(aX),aY-A*Math.sin(aX)];},_handleAddAnchorEvent:function(aW){var A=this;A.addField({});},_handleAddNodeEvent:function(aX){var A=this;var aW=A.get(aQ);var aY=A.findAvailableAnchor();if(aY){var aZ=A.getConnectionNode();aW.addField(aZ);aY.connect(aZ.addField({}));}},_handleEditEvent:function(aW){var A=this;A.get(aQ).startEditingNode(A);},_handleCloseEvent:function(aW){var A=this;if(!A.get(G)){A.close();}},_onAnchorDrag:function(aX){var A=this;var aW=A.get(aQ);aW.tmpConnector.set(av,aX.target.get(aF).getCenterXY());},_onAnchorDragEnd:function(aX){var A=this;var aW=A.get(aQ).tmpConnector.shape;aW.clear();aW.end();},_onAnchorDragStart:function(aX){var A=this;var aW=A.get(aQ);aW.tmpConnector.set(aw,aX.target.get(o).getCenterXY());},_onAnchorDropHit:function(aW){var A=this;var aX=am.Anchor.getAnchorByNode(aW.drag.get(o));var aY=am.Anchor.getAnchorByNode(aW.drop.get(o));aX.connect(aY);ab();},_renderControls:function(){var A=this;var aW=A.get(p);A.controlsNode=am.Node.create(A.CONTROLS_TEMPLATE).appendTo(aW);},_renderNodes:function(){var A=this;var aW=A.get(p);A.anchorWrapper=am.Node.create(A.ANCHOR_WRAPPER_TEMPLATE).appendTo(aW);},_renderControlsToolbar:function(aW){var A=this;A.controlsToolbar=new am.Toolbar(A.get(az)).render(A.controlsNode);A._uiSetRequired(A.get(G));},_setAnchorsDragConfig:function(aX){var A=this;var aW=A.get(aQ);return am.merge({bubbleTargets:A,container:A.anchorWrapper,dragConfig:{groups:[an],plugins:[{cfg:{constrain:(aW?aW.get(af):null)},fn:am.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:am.Plugin.DDWinScroll},{cfg:{moveOnEnd:false},fn:am.Plugin.DDProxy}]},nodes:g+aD,target:true},aX||{});},_setupAnchorsDrag:function(){var A=this;A.anchorsDrag=new am.DD.Delegate(A.get(ah));A.anchorsDrag.dd.addInvalid(g+R);},_uiSetFields:function(aW){var A=this;if(A.get(aR)){A.alignAnchors();A.syncDragTargets();A.syncDropTargets();}},_uiSetName:function(aX){var A=this;var aW=A.get(p);aW.set(aA,am.DiagramNode.buildNodeId(aX));},_uiSetRequired:function(aY){var aX=this;var aW=aX.getStrings();var A=aX.controlsToolbar;if(A){if(aY){A.remove(aN);}else{A.add({handler:am.bind(aX._handleCloseEvent,aX),icon:ae,id:aN,title:aW[C]});}}},_uiSetSelected:function(aW){var A=this;A.get(p).toggleClass(aS,aW);if(aW&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(aX){var A=this;var aW=A._getContainer().getXY();this._posNode.setXY([aX[0]+aW[0],aX[1]+aW[1]]);},_valueControlsToolbar:function(aX){var aW=this;var A=aW.getStrings();return{activeState:false,children:[{handler:am.bind(aW._handleEditEvent,aW),icon:l,id:z,title:A[I]},{handler:am.bind(aW._handleAddAnchorEvent,aW),icon:al,id:ap,title:A[aP]},{handler:am.bind(aW._handleAddNodeEvent,aW),icon:H,id:j},{handler:am.bind(aW._handleCloseEvent,aW),icon:ae,id:aN,title:A[C]}]};}}});am.DiagramNode=aV;am.DiagramBuilder.types[o]=am.DiagramNode;},"@VERSION@",{requires:["aui-diagram-builder-base","overlay"],skinnable:true});AUI.add("aui-diagram-builder-connector",function(o){var X=o.Lang,y=X.isArray,D=X.isBoolean,W=X.isNumber,L=X.isObject,l=X.isString,M=o.Array,c=function(A){return(A instanceof o.Anchor);},O=function(A){return(A instanceof o.ArrayList);},t=function(A){return(A instanceof o.DiagramNode);},N=function(A){return(A instanceof o.Graphic);},J="anchor",P="arrowPoints",Q="boundingBox",Y="builder",E="color",u="connector",a="dataAnchor",H="diagram",z="diagramNode",G="fill",F="graphic",w="id",S="lazyDraw",T="max",n="maxSources",m="maxTargets",I="mousedown",f="mouseenter",p="mouseleave",V="node",s="p1",r="p2",g="path",C="selected",x="shape",K="shapeHover",q="shapeSelected",k="sources",h="stroke",i="targets",U="wrapper",v=".",j="#",B=o.getClassName,b=B(H,Y,J,V,T,i),e=B(H,Y,J,V,T,k),d=B(H,Y,J,V,U),R=B(H,Y,J,V);o.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(ae,Z,ag,A,af,ac){var ah=this;ae.moveTo(Z,ag);ae.lineTo(A,af);var aa=Math.atan2(af-ag,A-Z),ad=(A+Z)/2,ab=(af+ag)/2;ah.drawPolygon(ae,ah.translatePoints(ah.rotatePoints(ac||ah.ARROW_POINTS,aa),ad,ab));},drawPolygon:function(Z,aa){var A=this;Z.moveTo(aa[0][0],aa[0][1]);M.each(aa,function(ac,ab){if(ab>0){Z.lineTo(aa[ab][0],aa[ab][1]);}});Z.lineTo(aa[0][0],aa[0][1]);},translatePoints:function(aa,Z,ac){var A=this;var ab=[];M.each(aa,function(ae,ad){ab.push([aa[ad][0]+Z,aa[ad][1]+ac]);});return ab;},rotatePoints:function(Z,ab){var A=this;var aa=[];M.each(Z,function(ad,ac){aa.push(A.rotatePoint(ab,Z[ac][0],Z[ac][1]));});return aa;},rotatePoint:function(Z,A,aa){return[(A*Math.cos(Z))-(aa*Math.sin(Z)),(A*Math.sin(Z))+(aa*Math.cos(Z))];}};o.Connector=o.Base.create("line",o.Base,[],{shape:null,initializer:function(aa){var A=this;var Z=A.get(S);A.after({p1Change:A.draw,p2Change:A.draw,selectedChange:A._afterSelectedChange});
A._initShapes();if(!Z){A.draw();}A._uiSetSelected(A.get(C),!Z);},destroy:function(){var A=this;A.get(F).removeShape(A.shape);},draw:function(){var A=this;var Z=A.shape;var ab=A.getCoordinate(A.get(s));var aa=A.getCoordinate(A.get(r));Z.clear();o.PolygonUtil.drawLineArrow(Z,ab[0],ab[1],aa[0],aa[1],A.get(P));Z.end();},getCoordinate:function(aa){var A=this;var Z=A.get(F).getXY();return[aa[0]-Z[0],aa[1]-Z[1]];},_afterSelectedChange:function(Z){var A=this;A._uiSetSelected(Z.newVal);},_initShapes:function(){var A=this;var Z=A.shape=A.get(F).getShape(A.get(x));Z.on(I,o.bind(A._onShapeMouseDown,A));Z.on(f,o.bind(A._onShapeMouseEnter,A));Z.on(p,o.bind(A._onShapeMouseLeave,A));},_onShapeMouseDown:function(Z){var A=this;A.set(C,!A.get(C));},_onShapeMouseEnter:function(Z){var A=this;if(!A.get(C)){A._updateShape(A.get(K));}},_onShapeMouseLeave:function(Z){var A=this;if(!A.get(C)){A._updateShape(A.get(x));}},_setShape:function(Z){var A=this;return o.merge({type:g,stroke:{color:A.get(E),weight:2},fill:{color:A.get(E)}},Z);},_updateShape:function(ab,Z){var A=this;var aa=A.shape;if(ab.hasOwnProperty(G)){aa.set(G,ab[G]);}if(ab.hasOwnProperty(h)){aa.set(h,ab[h]);}if(Z!==false){A.draw();}},_uiSetSelected:function(aa,Z){var A=this;A._updateShape(aa?A.get(q):A.get(x),Z);}},{ATTRS:{anchor:{},color:{value:"#666",validator:l},lazyDraw:{value:false,validator:D},graphic:{validator:N},shapeHover:{value:{fill:{color:"red"},stroke:{color:"red",weight:2}}},selected:{value:false,validator:D},shape:{value:null,setter:"_setShape"},shapeSelected:{value:{fill:{color:"#000"},stroke:{color:"#000",weight:6}}},arrowPoints:{value:o.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:y},p2:{value:[0,0],validator:y}}});o.Anchor=o.Base.create("anchor",o.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+d+'"></div>',NODE_TEMPLATE:'<div class="'+R+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(m));},addSource:function(Z){var A=this;if(A.get(k).size()<A.get(n)){A.set(k,A.get(k).remove(Z).add(Z));}return A;},addTarget:function(Z){var A=this;if(A.get(i).size()<A.get(m)){A.set(i,A.get(i).remove(Z).add(Z));}return A;},alignConnectors:function(){var A=this;A.get(i).each(function(Z){var aa=A.getConnector(Z);if(aa){aa.set(s,A.getCenterXY());aa.set(r,Z.getCenterXY());}});A.get(k).each(function(Z){var aa=Z.getConnector(A);if(aa){aa.set(s,Z.getCenterXY());aa.set(r,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(V).remove();},connect:function(Z){var A=this;if(t(Z)){Z=Z.findAvailableAnchor();}A.addTarget(Z);Z.addSource(A);if(!A.isConnected(Z)){var aa=Z.get(u);aa.anchor=A;aa.p1=A.getCenterXY();aa.p2=Z.getCenterXY();A.connectors[Z.get(w)]=new o.Connector(aa);}setTimeout(function(){Z.get(z).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(i).each(o.bind(A.connect,A));return A;},disconnect:function(Z){var A=this;A.getConnector(Z).destroy();A.removeTarget(Z);Z.removeSource(A);setTimeout(function(){Z.get(z).syncDropTargets();},50);},disconnectTargets:function(){var A=this;A.get(i).each(function(Z){A.disconnect(Z);});return A;},disconnectSources:function(){var A=this;A.get(k).each(function(Z){Z.disconnect(A);});return A;},findConnectorTarget:function(Z){var A=this;var aa=null;o.some(A.connectors,function(ac,ab){if(ac===Z){aa=o.Anchor.getAnchorByNode(j+ab);return true;}});return aa;},getCenterXY:function(){var A=this;return A.get(V).getCenterXY();},getConnector:function(Z){var A=this;return A.connectors[Z.get(w)];},hasConnection:function(){var A=this;return((A.get(i).size()>0)||(A.get(k).size()>0));},isConnected:function(Z){var A=this;return A.connectors.hasOwnProperty(Z.get(w));},removeSource:function(Z){var A=this;A.set(k,A.get(k).remove(Z));return A;},removeTarget:function(Z){var A=this;A.set(i,A.get(i).remove(Z));delete A.connectors[Z.get(w)];return A;},_afterSourcesChange:function(Z){var A=this;A._uiSetSources(Z.newVal);},_afterTargetsChange:function(Z){var A=this;Z.prevVal.each(function(aa){aa.removeSource(A);});Z.newVal.each(function(aa){aa.addSource(A);});A._uiSetTargets(Z.newVal);},_renderNode:function(){var A=this;var aa=A.get(z);var Z=aa.get(Q);A.wrapper=Z.one(v+d)||o.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(Z).appendChild(A.get(V));},_setConnector:function(Z){var A=this;return o.merge({graphic:A.get(z).get(Y).get(F)},Z);},_setSources:function(Z){var A=this;return A._setAnchors(Z);},_setTargets:function(Z){var A=this;Z=A._setAnchors(Z,true);Z.each(function(aa){aa.addSource(A);});return Z;},_setAnchors:function(ab,aa){var A=this;if(!O(ab)){var Z=[];o.Array.some(ab,function(ad,ac){if(ac>=A.get(ad?m:n)){return true;}Z.push(c(ad)?ad:new o.Anchor(ad));});ab=new o.ArrayList(Z);}return ab;},_setMaxSources:function(Z){var A=this;A._uiSetMaxSources(A.get(n));return Z;},_setMaxTargets:function(Z){var A=this;A._uiSetMaxTargets(A.get(m));return Z;},_setNode:function(Z){var A=this;var aa=A.get(w);return o.one(Z).set(w,aa).setData(a,A);},_uiSetSources:function(Z){var A=this;A._uiSetMaxSources(A.get(n));},_uiSetMaxSources:function(aa){var A=this;var Z=A.get(V);Z.toggleClass(e,(A.get(k).size()===aa));},_uiSetMaxTargets:function(aa){var A=this;var Z=A.get(V);Z.toggleClass(b,(A.get(i).size()===aa));},_uiSetTargets:function(Z){var A=this;A._uiSetMaxTargets(A.get(m));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:L},id:{readOnly:true,valueFn:function(){return o.guid();}},maxSources:{setter:"_setMaxSources",value:1,validator:W},maxTargets:{setter:"_setMaxTargets",value:1,validator:W},node:{setter:"_setNode",valueFn:function(){var A=this;return o.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return y(A)||O(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return y(A)||O(A);}}},getAnchorByNode:function(A){return c(A)?A:o.one(A).getData(a);
}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});AUI.add("aui-diagram-builder",function(a){},"@VERSION@",{use:["aui-diagram-builder-base","aui-diagram-builder-impl","aui-diagram-builder-connector"],skinnable:true});