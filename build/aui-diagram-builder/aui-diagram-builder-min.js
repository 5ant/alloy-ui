AUI.add("aui-diagram-builder-base",function(ae){var T=ae.Lang,d=T.isArray,aq=T.isBoolean,L=T.isNumber,B=T.isObject,au=T.isString,I=function(A){return(A instanceof ae.ArrayList);},R=function(A){return(A instanceof ae.Node);},D=function(A){return(A instanceof ae.AvailableField);},aE=ae.Array,O="maxFields",V="add",k="addNode",aD="auto",M="availableField",Q="availableFields",aA="availableFieldsDragConfig",an="base",s="boundingBox",ax="builder",Z="cancel",ar="clearfix",a="container",ac="content",u="contentBox",ab="canvas",P="contentNode",E="createDocumentFragment",z="diagram",F="diagram-builder-base",aa="disk",o="draggable",az="drop",al="dropConfig",Y="dropContainer",ap="field",t="fields",n="fieldsContainer",ao="height",p="helper",W="icon",v="iconClass",ak="id",ag="label",aj="list",r="node",y="nodeSettings",ad="propertyList",ay="rendered",am="save",q="settings",N="tab",b="tabs",e="tabview",G="tabView",K="toolbar",j="toolbarContainer",w=ae.getClassName,aC=" ",g=".",H="$",h="#",aF=w(z,ax,an,az,a),x=w(z,ax,an,ab),C=w(z,ax,an,ap),f=w(z,ax,an,t,a),ah=w(z,ax,an,ap,o),c=w(z,ax,an,ap,W),U=w(z,ax,an,ap,ag),m=w(z,ax,an,b,a),X=w(z,ax,an,b,a,ac),ai=w(z,ax,an,N,V),J=w(z,ax,an,N,q),av=w(z,ax,an,K,a),af=w(p,ar),l=w(W),aw=w(e,ac),aB=w(e,aj);var i=ae.Component.create({NAME:M,ATTRS:{draggable:{value:true,validator:aq},label:{validator:au},iconClass:{validator:au},id:{value:ae.guid(),setter:"_setId",validator:au},node:{valueFn:function(aG){var A=this;if(!R(aG)){aG=ae.Node.create(ae.Lang.sub(A.FIELD_ITEM_TEMPLATE,{iconClass:A.get(v)}));aG.setData(M,A);}return aG;},validator:R,writeOnce:true},type:{value:r,validator:au}},EXTENDS:ae.Base,buildNodeId:function(A){return Q+H+ap+H+A;},getAvailableFieldByNode:function(A){return ae.one(A).getData(M);},getAvailableFieldById:function(A){return ae.AvailableField.getAvailableFieldByNode(h+ae.AvailableField.buildNodeId(A));},prototype:{FIELD_ITEM_TEMPLATE:'<li class="'+C+'">'+'<span class="'+[l,c].join(aC)+' {iconClass}"></span>'+'<span class="'+U+'"></span>'+"</li>",initializer:function(){var A=this;var aG=A.get(r);A.after({draggableChange:A._afterDraggableChange,idChange:A._afterIdChange,labelChange:A._afterLabelChange});A.labelNode=aG.one(g+U);A._uiSetDraggable(A.get(o));A._uiSetId(A.get(ak));A._uiSetLabel(A.get(ag));},_afterDraggableChange:function(aG){var A=this;A._uiSetDraggable(aG.newVal);},_afterIdChange:function(aG){var A=this;A._uiSetId(aG.newVal);},_afterLabelChange:function(aG){var A=this;A._uiSetLabel(aG.newVal);},_setId:function(A){return ae.AvailableField.buildNodeId(A);},_uiSetDraggable:function(aG){var A=this;A.get(r).toggleClass(ah,aG);},_uiSetLabel:function(aG){var A=this;A.labelNode.setContent(aG);},_uiSetId:function(aG){var A=this;A.get(r).set(ak,aG);}}});ae.AvailableField=i;var S=function(){};S.ATTRS={fields:{value:[],setter:"_setFields",validator:function(A){return d(A)||I(A);}},maxFields:{value:Infinity,validator:L}};ae.mix(S.prototype,{createFields:function(aH){var aG=this;var A=[];aE.each(aH,function(aJ,aI){if(aI<aG.get(O)){A.push(aG.createField(aJ));}});return new ae.ArrayList(A);},addField:function(aG){var A=this;if(A.get(t).size()<A.get(O)){var aH=A.createField(aG);if(aH){A._updateFields(A.get(t).add(aH));}return aH;}return null;},removeField:function(aG){var A=this;A._updateFields(A.get(t).remove(aG));},_updateFields:function(aG){var A=this;A.set(t,aG);},_setFields:function(aG){var A=this;if(I(aG)){return aG;}else{return A.createFields(aG);}},createField:function(A){return A;}});ae.FieldSupport=S;var at=ae.Component.create({NAME:F,ATTRS:{availableFields:{setter:"_setAvailableFields",validator:d},canvas:{valueFn:function(){return ae.Node.create(this.CANVAS_TEMPLATE);}},dropContainer:{valueFn:function(){return ae.Node.create(this.DROP_CONTAINER_TEMPLATE);}},dropConfig:{value:null,setter:"_setDropConfig",validator:B},availableFieldsDragConfig:{value:null,setter:"_setAvailableFieldsDragConfig",validator:B},fieldsContainer:{valueFn:function(){return ae.Node.create(this.FIELDS_CONTAINER_TEMPLATE);}},propertyList:{setter:"_setPropertyList",validator:B,value:null},strings:{value:{addNode:"Add node",cancel:"Cancel",nodeSettings:"Node settings",propertyName:"Property Name",save:"Save",value:"Value"}},tabView:{setter:"_setTabView",validator:B,value:null,writeOnce:true},toolbar:{setter:"_setToolbar",validator:B,value:null},toolbarContainer:{valueFn:function(){return ae.Node.create(this.TOOLBAR_CONTAINER_TEMPLATE);}}},HTML_PARSER:{dropContainer:g+aF,fieldsContainer:g+f,toolbarContainer:g+av,canvas:g+x},UI_ATTRS:[Q,t],AUGMENTS:[ae.FieldSupport],prototype:{DROP_CONTAINER_TEMPLATE:'<div class="'+aF+'"></div>',TOOLBAR_CONTAINER_TEMPLATE:'<div class="'+av+'"></div>',FIELDS_CONTAINER_TEMPLATE:'<ul class="'+f+'"></ul>',CANVAS_TEMPLATE:'<div tabindex="1" class="'+x+'"></div>',fieldsNode:null,propertyList:null,settingsNode:null,tabView:null,toolbar:null,initializer:function(){var A=this;A.publish({cancel:{defaultFn:A._defCancelFn}});A.after({render:A._afterRender});A.after(A._afterUiSetHeight,A,"_uiSetHeight");A.canvas=A.get(ab);A.dropContainer=A.get(Y);A.fieldsContainer=A.get(n);A.toolbarContainer=A.get(j);},isAvailableFieldsDrag:function(aH){var A=this;var aG=A.availableFieldsDrag;return(aH===aG.dd);},plotFields:function(){var aG=this;var A=aG.get(t);A.each(function(aH){aG.plotField(aH);});},renderUI:function(){var A=this;A._renderTabs();A._renderCanvas();A._uiSetAvailableFields(A.get(Q));},syncUI:function(){var A=this;var aG=A.get(u);A._setupDrop();A._setupAvailableFieldsDrag();aG.addClass(af);},_afterActiveTabChange:function(aH){var A=this;var aG=aH.newVal.get(P);if(A.get(ay)&&(aG===A.settingsNode)){A._renderSettings();}},_afterRender:function(aG){var A=this;A.plotFields();},_afterUiSetHeight:function(aG){var A=this;A.dropContainer.setStyle(ao,L(aG)?aG+A.DEF_UNIT:aG);},_defCancelFn:function(aG){var A=this;A.tabView.selectTab(0);},_handleCancelEvent:function(){var A=this;A.fire(Z);},_handleSaveEvent:function(){var A=this;A.fire(am);},_renderCanvas:function(){var A=this;
var aG=A.get(u);var aH=A.canvas;aH.appendChild(A.dropContainer);aG.appendChild(aH);},_renderPropertyList:function(){var A=this;if(!A.propertyList){A.propertyList=new ae.PropertyList(A.get(ad)).render(A.settingsNode);A.propertyList.get(s).unselectable();}},_renderSettings:function(){var A=this;A._renderPropertyList();A._renderToolbar();},_renderTabs:function(){var A=this;if(!A.tabView){var aG=new ae.TabView(A.get(G));A.tabView=aG;A.fieldsNode=aG.getTab(0).get(P);A.settingsNode=aG.getTab(1).get(P);}},_renderToolbar:function(){var A=this;if(!A.toolbar){A.toolbar=new ae.Toolbar(A.get(K)).render(A.settingsNode);}},_setupDrop:function(){var A=this;A.drop=new ae.DD.Drop(A.get(al));},_setupAvailableFieldsDrag:function(){var A=this;A.availableFieldsDrag=new ae.DD.Delegate(A.get(aA));},_setAvailableFields:function(aH){var aG=this;var A=[];aE.each(aH,function(aJ,aI){A.push(D(aJ)?aJ:new ae.AvailableField(aJ));});return A;},_setDropConfig:function(aG){var A=this;return ae.merge({bubbleTargets:A,groups:[Q],node:A.dropContainer},aG||{});},_setAvailableFieldsDragConfig:function(aG){var A=this;return ae.merge({bubbleTargets:A,container:A.get(s),dragConfig:{groups:[Q],plugins:[{cfg:{moveOnEnd:false},fn:ae.Plugin.DDProxy}]},nodes:g+ah},aG||{});},_setPropertyList:function(aG){var A=this;return ae.merge({bubbleTargets:A,width:250,scroll:{height:400,width:aD}},aG);},_setTabView:function(aJ){var aG=this;var aI=aG.get(s);var aK=aI.one(g+aB);var aH={after:{activeTabChange:ae.bind(aG._afterActiveTabChange,aG)},boundingBox:aI.one(g+m),contentBox:aI.one(g+X),bubbleTargets:aG,contentNode:aI.one(g+aw),cssClass:m,listNode:aK,render:aG.get(u)};if(!aK){var A=aG.getStrings();aH.items=[{cssClass:ai,label:A[k]},{cssClass:J,label:A[y]}];}return ae.merge(aH,aJ);},_setToolbar:function(aH){var aG=this;var A=aG.getStrings();return ae.merge({activeState:false,bubbleTargets:aG,children:[{handler:ae.bind(aG._handleSaveEvent,aG),label:A[am],icon:aa},{handler:ae.bind(aG._handleCancelEvent,aG),label:A[Z]}]},aH);},_uiSetAvailableFields:function(aI){var A=this;var aH=A.fieldsNode;if(aH){var aG=ae.getDoc().invoke(E);aE.each(aI,function(aJ){aG.appendChild(aJ.get(r));});aH.setContent(A.fieldsContainer.setContent(aG));}},_uiSetFields:function(aG){var A=this;if(A.get(ay)){A.plotFields();}}}});ae.DiagramBuilderBase=at;},"@VERSION@",{requires:["aui-tabs","aui-property-list","collection","dd"],skinnable:true});AUI.add("aui-diagram-builder-impl",function(ak){var Y=ak.Lang,c=Y.isArray,E=Y.isObject,aK=Y.isString,aF=Y.isBoolean,aS=ak.Array,T=function(A){return(A instanceof ak.DiagramBuilderBase);},aG=function(A){return(A instanceof ak.DiagramNode);},ag=function(A){return(A instanceof ak.Anchor);},aq=function(A,aV){var aU=c(aV)?aV:aV.getXY();var aW=c(A)?A:A.getXY();return aS.map(aW,function(aY,aX){return Math.max(0,aY-aU[aX]);});},ao="addAnchor",aN="addAnchorMessage",j="addNode",at="anchor",al="anchors",af="anchorsDragConfig",P="availableField",V="boolean",o="boundingBox",aO="builder",ac="cancel",ad="canvas",az="click",aL="closeEvent",B="closeMessage",ai="content",J="controls",ax="controlsToolbar",aw="data",ae="dblclick",S="delete",am="deleteMessage",aC="description",C="diagram",ah="diagram-builder",ar="diagramNode",x="diagram-node",aD="dragNode",L="editing",y="editEvent",H="editMessage",a="esc",aE="field",q="fields",ap="fieldsDragConfig",U="graphic",p="hover",ay="id",M="keydown",aj="link",aa="max",t="maxSources",r="mouseenter",W="mouseleave",m="name",n="node",av="p1",au="p2",d="parentNode",l="pencil",ab="records",k="recordset",h="region",aP="rendered",F="required",aH="selected",G="shuffle",N="source",aI="sources",aJ="string",i="target",I="targets",K="tmpConnector",e="type",aM="wrapper",v="xy",aR="-",g=".",O="",f="#",D="_",u=ak.getClassName,Q=u(C,aO,at,n,aa,I),an=u(C,aO,at,p),aB=u(C,aO,at,n),z=u(C,aO,at,n,aM),s=u(C,aO,J),X=u(C,n),b=u(C,n,ai),aA=u(C,n,L),aQ=u(C,n,aH);var Z=function(){var aU="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",A="<br/>";ak.all(".aui-diagram-node").each(function(a0){var aV=O,aX=ak.Widget.getByNode(a0),aW=aX.get("name"),aZ=aX.get("boundingBox"),aY=aZ.one(".log")||ak.Node.create("<div class=log />").appendTo(aZ);aV+=aW+A;aX.get(q).each(function(a1){aV+=aU+"a: "+a1.get("id")+A;a1.get("targets").each(function(a2){var a3=a2.get(ar);a2.get("node").setContent(a2.get("id"));aV+=aU+aU+"t: "+a3.get("name")+" (s: "+a2.get("id")+")"+A;});a1.get("sources").each(function(a3){var a2=a3.get(ar);a3.get("node").setContent(a3.get("id"));aV+=aU+aU+"s: "+a2.get("name")+" (t: "+a3.get("id")+")"+A;});});aY.setContent(aV);});};var w=ak.Component.create({NAME:ah,ATTRS:{fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:E},graphic:{valueFn:function(){return new ak.Graphic();},validator:E},tmpConnector:{setter:"_setTmpConnector",value:{},validator:E}},EXTENDS:ak.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editNode:null,initializer:function(){var A=this;A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});A.handlerKeyDown=ak.getDoc().on(M,ak.bind(A._afterKeyEvent,A));A.dropContainer.delegate(az,ak.bind(A._onNodeClick,A),g+X);A.dropContainer.delegate(ae,ak.bind(A._onNodeEdit,A),g+X);A.dropContainer.delegate(r,ak.bind(A._onMouseenterAnchors,A),g+aB);A.dropContainer.delegate(W,ak.bind(A._onMouseleaveAnchors,A),g+aB);},renderUI:function(){var A=this;ak.DiagramBuilder.superclass.renderUI.apply(this,arguments);A._renderGraphic();},syncUI:function(){var A=this;ak.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.tmpConnector=new ak.Connector(A.get(K));},connect:function(aV,aX){var aU=this;if(aK(aV)){aV=ak.Widget.getByNode(f+ak.DiagramNode.buildNodeId(aV));}if(aK(aX)){aX=ak.Widget.getByNode(f+ak.DiagramNode.buildNodeId(aX));}if(aV&&aX){var aW=aV.findAvailableAnchor();var A=aX.findAvailableAnchor();if(aW&&A){aW.connect(A);}}return aU;},connectAll:function(aU){var A=this;aS.each(aU,function(aV){if(aV.hasOwnProperty(N)&&aV.hasOwnProperty(i)){A.connect(aV.source,aV.target);
}});return A;},createField:function(aU){var A=this;if(!aG(aU)){aU.builder=A;aU=new (A.getFieldClass(aU.type||n))(aU);}aU.set(aO,A);return aU;},getFieldClass:function(aV){var A=this;var aU=ak.DiagramBuilder.types[aV];if(aU){return aU;}else{ak.log("The field type: ["+aV+"] couldn't be found.");return null;}},isFieldsDrag:function(aV){var A=this;var aU=A.fieldsDrag;return(aV===aU.dd);},plotField:function(aU){var A=this;if(!aU.get(aP)){aU.render(A.dropContainer);}},unselectAll:function(){var A=this;var aU=A.selectedNode;if(aU){aU.set(aH,false);}A.selectedNode=null;},select:function(aU){var A=this;A.unselectAll();A.selectedNode=aU.set(aH,true).focus();},startEditingNode:function(aU){var A=this;if(aU){A.stopEditingNode();A.tabView.selectTab(ak.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(k,aU.getProperties());aU.get(o).addClass(aA);A.editNode=aU;}},stopEditingNode:function(aV){var A=this;var aU=aV||A.editNode;if(aU){A.tabView.selectTab(ak.DiagramBuilder.FIELDS_TAB);aU.get(o).removeClass(aA);A.editNode=null;}},_afterKeyEvent:function(aU){var A=this;if(!A.selectedNode||aU.hasModifier()||!aU.isKeyInSet(a,S)){return;}if(aU.isKey(a)){A._onEscKey(aU);}else{if(aU.isKey(S)){A._onDeleteKey(aU);}}aU.halt();},_onCancel:function(aU){var A=this;A.stopEditingNode();},_onDrag:function(aV){var A=this;var aU=aV.target;if(A.isFieldsDrag(aU)){var aW=ak.Widget.getByNode(aU.get(aD));aW.get(q).each(function(aX){aX.alignConnectors();});}},_onDragEnd:function(aV){var A=this;var aU=aV.target;if(A.isFieldsDrag(aU)){var aW=ak.Widget.getByNode(aU.get(aD));aW.set(v,aW.getLeftTop());}},_onDropHit:function(aV){var A=this;var aU=aV.drag;if(A.isAvailableFieldsDrag(aU)){var aX=aU.get(n).getData(P);var aW=A.addField({xy:aq(aU.lastXY,A.dropContainer),type:aX.get(e),fields:[{}]});A.select(aW);}},_onDeleteKey:function(aU){var A=this;var aV=A.selectedNode;if(!aV.get(F)){aV.close();}},_onEscKey:function(aU){var A=this;A.unselectAll();A.stopEditingNode();},_onMouseenterAnchors:function(aU){var A=this;aU.currentTarget.addClass(an);},_onMouseleaveAnchors:function(aU){var A=this;aU.currentTarget.removeClass(an);},_onNodeClick:function(aU){var A=this;var aV=ak.Widget.getByNode(aU.currentTarget);A.select(aV);},_onNodeEdit:function(aU){var A=this;if(!aU.target.ancestor(g+b,true)){return;}var aV=ak.Widget.getByNode(aU.currentTarget);if(aV){A.startEditingNode(aV);}},_onSave:function(aV){var A=this;var aU=A.editNode;var aW=A.propertyList.get(k);if(aU){aS.each(aW.get(ab),function(aX){var aY=aX.get(aw);aU.set(aY.attributeName,aY.value);});A.stopEditingNode(aU);}},_renderGraphic:function(){var A=this;A.get(U).render(A.get(ad));},_setTmpConnector:function(aU){var A=this;return ak.merge({lazyDraw:true,graphic:A.get(U)},aU);},_setFieldsDragConfig:function(aV){var A=this;var aU=A.dropContainer;return ak.merge({bubbleTargets:A,container:aU,dragConfig:{plugins:[{cfg:{constrain:aU},fn:ak.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:ak.Plugin.DDWinScroll}]},nodes:g+X},aV||{});},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new ak.DD.Delegate(A.get(ap));}}});ak.DiagramBuilder=w;ak.DiagramBuilder.types={};var R=ak.Component.create({NAME:x,EXTENDS:ak.Overlay,AUGMENTS:[ak.FieldSupport]});var aT=ak.Component.create({NAME:x,UI_ATTRS:[q,m,F,aH],ATTRS:{anchorsDragConfig:{value:null,setter:"_setAnchorsDragConfig",validator:E},builder:{setter:"_setBuilder",validator:T},required:{value:false,validator:aF},description:{value:O,validator:aK},height:{value:90},name:{valueFn:function(){var A=this;return A.get(e)+(++ak.Env._uidx);},validator:aK},selected:{value:false,validator:aF},strings:{value:{addAnchorMessage:"Add Anchor",closeMessage:"Close",deleteMessage:"Are you sure you want to delete?",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},type:{value:n,validator:aK},controlsToolbar:{validator:E,valueFn:"_valueControlsToolbar"},width:{value:90},zIndex:{value:100},tabIndex:{value:1}},EXTENDS:R,buildNodeId:function(A){return ar+D+aE+D+A;},prototype:{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+z+'"></div>',CONTROLS_TEMPLATE:'<div class="'+s+'"></div>',initializer:function(){var A=this;A._renderNodes();A._setupAnchorsDrag();A.after({render:A._afterRender});A.on({"drag:drag":A._onAnchorDrag,"drag:end":A._onAnchorDragEnd,"drag:start":A._onAnchorDragStart,"drop:hit":A._onAnchorDropHit});A.get(o).addClass(X+aR+A.get(e));A.set("bodyContent",A.get(m));},alignAnchors:function(){var aU=this;var aY=aU.get(q);var aW=aU.get(o).get(h),aX=Math.floor(360/aY.size()),aV=aW.width/2,A=aW.height/2,a0=aW.left+aW.width/2,aZ=aW.top+aW.height/2;aY.each(function(a4,a3){var a2=a4.get(n);var a5=a2.get(h);var a1=aU._getEllipseXY(aV,A,a0,aZ,a3*aX);a2.setXY([a1[0]-a5.width/2,a1[1]-a5.height/2]);a4.alignConnectors();});return aU;},close:function(){var aU=this;var A=aU.getStrings();if(confirm(A[am])){aU.get(q).each(function(aV){aV.destroy();});aU.destroy();}Z();return aU;},createField:function(aV){var A=this;if(!ag(aV)){var aU=A.get(aO);aV.diagramNode=A;aV.graphic=(aU?aU.get(U):null);aV=new ak.Anchor(aV);}return aV;},findAvailableAnchor:function(){var A=this;var aU=null;A.get(q).some(function(aV){if(!aV.hasConnection()){aU=aV;return true;}});if(!aU){aU=A.addField({});}return aU;},getConnectionNode:function(){var A=this;return new ak.DiagramNode({xy:[100,100]});},getLeftTop:function(){var A=this;return aq(A.get(o),A._getContainer());},getProperties:function(){var A=this;var aU=A.getPropertyModel();aS.each(aU,function(aX){var aW=A.get(aX.attributeName),aV=Y.type(aW);if(aV===V||aV===aJ){aW=String(aW);}aX.value=aW;});return aU;},getPropertyModel:function(){var aU=this;var A=aU.getStrings();return[{attributeName:aC,editor:new ak.TextAreaCellEditor(),name:A[aC]},{attributeName:m,editor:new ak.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[m]},{attributeName:e,editor:false,name:A[e]}];},syncDragTargets:function(){var A=this;A.anchorsDrag.syncTargets();},syncDropTargets:function(aU){var A=this;A.get(q).each(function(aW){var aV=ak.DD.DDM.getDrop(aW.get(n));if(aV){if(aW.get(aI).size()===aW.get(t)){aV.removeFromGroup(al);
}else{aV.addToGroup(al);}}});},_afterRender:function(aU){var A=this;A.alignAnchors();A._renderControls();},_getContainer:function(){var A=this;return(A.get(aO).dropContainer||A.get(o).get(d));},_getEllipseXY:function(aU,A,aX,aW,aY){var aV=aY*Math.PI/180;return[aX+aU*Math.cos(aV),aW-A*Math.sin(aV)];},_handleAddAnchorEvent:function(aU){var A=this;A.addField({});},_handleAddNodeEvent:function(aV){var A=this;var aU=A.get(aO);var aW=A.findAvailableAnchor();if(aW){var aX=A.getConnectionNode();aU.addField(aX);aW.connect(aX.addField({}));}},_handleEditEvent:function(aU){var A=this;A.get(aO).startEditingNode(A);},_handleCloseEvent:function(aU){var A=this;if(!A.get(F)){A.close();}},_onAnchorDrag:function(aV){var A=this;var aU=A.get(aO);aU.tmpConnector.set(au,aV.target.get(aD).getCenterXY());},_onAnchorDragEnd:function(aV){var A=this;var aU=A.get(aO).tmpConnector.shape;aU.clear();aU.end();},_onAnchorDragStart:function(aV){var A=this;var aU=A.get(aO);aU.tmpConnector.set(av,aV.target.get(n).getCenterXY());},_onAnchorDropHit:function(aU){var A=this;var aV=ak.Anchor.getAnchorByNode(aU.drag.get(n));var aW=ak.Anchor.getAnchorByNode(aU.drop.get(n));aV.connect(aW);Z();},_renderControls:function(){var A=this;var aU=A.get(o);A.controlsNode=ak.Node.create(A.CONTROLS_TEMPLATE).appendTo(aU);},_renderNodes:function(){var A=this;var aU=A.get(o);A.anchorWrapper=ak.Node.create(A.ANCHOR_WRAPPER_TEMPLATE).appendTo(aU);},_renderControlsToolbar:function(aU){var A=this;A.controlsToolbar=new ak.Toolbar(A.get(ax)).render(A.controlsNode);A._uiSetRequired(A.get(F));},_setBuilder:function(aU){var A=this;A.get(q).each(function(aV){aV.set(U,aU.get(U));});return aU;},_setAnchorsDragConfig:function(aV){var A=this;var aU=A.get(aO);return ak.merge({bubbleTargets:A,container:A.anchorWrapper,dragConfig:{groups:[al],plugins:[{cfg:{constrain:(aU?aU.get(ad):null)},fn:ak.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:ak.Plugin.DDWinScroll},{cfg:{moveOnEnd:false},fn:ak.Plugin.DDProxy}]},nodes:g+aB,target:true},aV||{});},_setupAnchorsDrag:function(){var A=this;A.anchorsDrag=new ak.DD.Delegate(A.get(af));A.anchorsDrag.dd.addInvalid(g+Q);},_uiSetFields:function(aU){var A=this;if(A.get(aP)){A.alignAnchors();A.syncDragTargets();A.syncDropTargets();}},_uiSetName:function(aV){var A=this;var aU=A.get(o);aU.set(ay,ak.DiagramNode.buildNodeId(aV));},_uiSetRequired:function(aW){var aV=this;var aU=aV.getStrings();var A=aV.controlsToolbar;if(A){if(aW){A.remove(aL);}else{A.add({handler:ak.bind(aV._handleCloseEvent,aV),icon:ac,id:aL,title:aU[B]});}}},_uiSetSelected:function(aU){var A=this;A.get(o).toggleClass(aQ,aU);if(aU&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(aV){var A=this;var aU=A._getContainer().getXY();this._posNode.setXY([aV[0]+aU[0],aV[1]+aU[1]]);},_valueControlsToolbar:function(aV){var aU=this;var A=aU.getStrings();return{activeState:false,children:[{handler:ak.bind(aU._handleEditEvent,aU),icon:l,id:y,title:A[H]},{handler:ak.bind(aU._handleAddAnchorEvent,aU),icon:aj,id:ao,title:A[aN]},{handler:ak.bind(aU._handleAddNodeEvent,aU),icon:G,id:j},{handler:ak.bind(aU._handleCloseEvent,aU),icon:ac,id:aL,title:A[B]}]};}}});ak.DiagramNode=aT;ak.DiagramBuilder.types[n]=ak.DiagramNode;},"@VERSION@",{requires:["aui-diagram-builder-base","overlay"],skinnable:true});AUI.add("aui-diagram-builder-connector",function(l){var O=l.Lang,t=O.isArray,w=O.isBoolean,N=O.isNumber,C=O.isObject,i=O.isString,D=l.Array,c=function(A){return(A instanceof l.Anchor);},F=function(A){return(A instanceof l.ArrayList);},o=function(A){return(A instanceof l.DiagramNode);},E=function(A){return(A instanceof l.Graphic);},B="anchor",G="arrowPoints",H="boundingBox",P="builder",x="color",p="connector",a="dataAnchor",z="diagram",u="diagramNode",y="graphic",r="id",J="lazyDraw",K="max",k="maxSources",j="maxTargets",L="node",n="p1",m="p2",f="path",s="shape",h="sources",g="targets",M="wrapper",q=".",v=l.getClassName,b=v(z,P,B,L,K,g),e=v(z,P,B,L,K,h),d=v(z,P,B,L,M),I=v(z,P,B,L);l.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(V,Q,X,A,W,T){var Y=this;V.moveTo(Q,X);V.lineTo(A,W);var R=Math.atan2(W-X,A-Q),U=(A+Q)/2,S=(W+X)/2;Y.drawPolygon(V,Y.translatePoints(Y.rotatePoints(T||Y.ARROW_POINTS,R),U,S));},drawPolygon:function(Q,R){var A=this;Q.moveTo(R[0][0],R[0][1]);D.each(R,function(T,S){if(S>0){Q.lineTo(R[S][0],R[S][1]);}});Q.lineTo(R[0][0],R[0][1]);Q.end();},translatePoints:function(R,Q,T){var A=this;var S=[];D.each(R,function(V,U){S.push([R[U][0]+Q,R[U][1]+T]);});return S;},rotatePoints:function(Q,S){var A=this;var R=[];D.each(Q,function(U,T){R.push(A.rotatePoint(S,Q[T][0],Q[T][1]));});return R;},rotatePoint:function(Q,A,R){return[(A*Math.cos(Q))-(R*Math.sin(Q)),(A*Math.sin(Q))+(R*Math.cos(Q))];}};l.Connector=l.Base.create("line",l.Base,[],{shape:null,initializer:function(Q){var A=this;A.after({p1Change:A.draw,p2Change:A.draw});A._initShapes();if(!A.get(J)){A.draw();}},destroy:function(){var A=this;A.get(y).removeShape(A.shape);},draw:function(){var A=this;var Q=A.shape;var S=A.getCoordinate(A.get(n));var R=A.getCoordinate(A.get(m));Q.clear();l.PolygonUtil.drawLineArrow(Q,S[0],S[1],R[0],R[1],A.get(G));},getCoordinate:function(R){var A=this;var Q=A.get(y).getXY();return[R[0]-Q[0],R[1]-Q[1]];},_initShapes:function(){var A=this;A.shape=A.get(y).getShape(A.get(s));},_setShape:function(Q){var A=this;return l.merge({type:f,stroke:{color:A.get(x),weight:2},fill:{color:A.get(x)}},Q);}},{ATTRS:{color:{value:"#666",validator:i},lazyDraw:{value:false,validator:w},graphic:{validator:E},shape:{value:null,setter:"_setShape"},arrowPoints:{value:l.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:t},p2:{value:[0,0],validator:t}}});l.Anchor=l.Base.create("anchor",l.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+d+'"></div>',NODE_TEMPLATE:'<div class="'+I+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(j));
},addSource:function(Q){var A=this;if(A.get(h).size()<A.get(k)){A.set(h,A.get(h).remove(Q).add(Q));}return A;},addTarget:function(Q){var A=this;if(A.get(g).size()<A.get(j)){A.set(g,A.get(g).remove(Q).add(Q));}return A;},alignConnectors:function(){var A=this;A.get(g).each(function(Q){var R=A.getConnector(Q);if(R){R.set(n,A.getCenterXY());R.set(m,Q.getCenterXY());}});A.get(h).each(function(Q){var R=Q.getConnector(A);if(R){R.set(n,Q.getCenterXY());R.set(m,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(L).remove();},connect:function(Q){var A=this;if(o(Q)){Q=Q.findAvailableAnchor();}A.addTarget(Q);Q.addSource(A);if(!A.isConnected(Q)){var R=Q.get(p);R.p1=A.getCenterXY();R.p2=Q.getCenterXY();A.connectors[Q.get(r)]=new l.Connector(R);}setTimeout(function(){Q.get(u).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(g).each(l.bind(A.connect,A));return A;},disconnect:function(Q){var A=this;A.getConnector(Q).destroy();A.removeTarget(Q);Q.removeSource(A);setTimeout(function(){Q.get(u).syncDropTargets();},50);},disconnectTargets:function(){var A=this;A.get(g).each(function(Q){A.disconnect(Q);});return A;},disconnectSources:function(){var A=this;A.get(h).each(function(Q){Q.disconnect(A);});return A;},getCenterXY:function(){var A=this;return A.get(L).getCenterXY();},getConnector:function(Q){var A=this;return A.connectors[Q.get(r)];},hasConnection:function(){var A=this;return((A.get(g).size()>0)||(A.get(h).size()>0));},isConnected:function(Q){var A=this;return A.connectors.hasOwnProperty(Q.get(r));},removeSource:function(Q){var A=this;A.set(h,A.get(h).remove(Q));return A;},removeTarget:function(Q){var A=this;A.set(g,A.get(g).remove(Q));return A;},_afterSourcesChange:function(Q){var A=this;A._uiSetSources(Q.newVal);},_afterTargetsChange:function(Q){var A=this;Q.prevVal.each(function(R){R.removeSource(A);});Q.newVal.each(function(R){R.addSource(A);});A._uiSetTargets(Q.newVal);},_renderNode:function(){var A=this;var R=A.get(u);var Q=R.get(H);A.wrapper=Q.one(q+d)||l.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(Q).appendChild(A.get(L));},_setConnector:function(Q){var A=this;return l.merge({graphic:A.get(y)},Q);},_setSources:function(Q){var A=this;return A._setAnchors(Q);},_setTargets:function(Q){var A=this;Q=A._setAnchors(Q,true);Q.each(function(R){R.addSource(A);});return Q;},_setAnchors:function(S,R){var A=this;if(!F(S)){var Q=[];l.Array.some(S,function(U,T){if(T>=A.get(U?j:k)){return true;}Q.push(c(U)?U:new l.Anchor(U));});S=new l.ArrayList(Q);}return S;},_setMaxSources:function(Q){var A=this;A._uiSetMaxSources(A.get(k));return Q;},_setMaxTargets:function(Q){var A=this;A._uiSetMaxTargets(A.get(j));return Q;},_setNode:function(Q){var A=this;var R=A.get(r);return l.one(Q).set(r,R).setData(a,A);},_uiSetSources:function(Q){var A=this;A._uiSetMaxSources(A.get(k));},_uiSetMaxSources:function(R){var A=this;var Q=A.get(L);Q.toggleClass(e,(A.get(h).size()===R));},_uiSetMaxTargets:function(R){var A=this;var Q=A.get(L);Q.toggleClass(b,(A.get(g).size()===R));},_uiSetTargets:function(Q){var A=this;A._uiSetMaxTargets(A.get(j));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:C},graphic:{validator:E},id:{readOnly:true,valueFn:function(){return l.guid();}},maxSources:{setter:"_setMaxSources",value:1,validator:N},maxTargets:{setter:"_setMaxTargets",value:1,validator:N},node:{setter:"_setNode",valueFn:function(){var A=this;return l.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return t(A)||F(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return t(A)||F(A);}}},getAnchorByNode:function(A){return c(A)?A:l.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});AUI.add("aui-diagram-builder",function(a){},"@VERSION@",{use:["aui-diagram-builder-base","aui-diagram-builder-impl","aui-diagram-builder-connector"],skinnable:true});