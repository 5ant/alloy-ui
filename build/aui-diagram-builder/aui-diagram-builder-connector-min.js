AUI.add("aui-diagram-builder-connector",function(p){var aa=p.Lang,C=aa.isArray,G=aa.isBoolean,Z=aa.isNumber,O=aa.isObject,m=aa.isString,u=p.Array,d=function(A){return(A instanceof p.Anchor);},R=function(A){return(A instanceof p.ArrayList);},v=function(A){return(A instanceof p.DiagramNode);},Q=function(A){return(A instanceof p.Graphic);},M="anchor",S="arrowPoints",T="boundingBox",ab="builder",P="click",I="color",x="connector",a="dataAnchor",b="description",L="diagram",D="diagramNode",K="fill",J="graphic",z="id",V="lazyDraw",W="max",o="maxSources",n="maxTargets",g="mouseenter",q="mouseleave",H="name",Y="node",t="p1",s="p2",h="path",F="selected",B="shape",N="shapeHover",r="shapeSelected",l="sources",i="stroke",j="targets",X="wrapper",y=".",w="",k="#",E=p.getClassName,c=E(L,ab,M,Y,W,j),f=E(L,ab,M,Y,W,l),e=E(L,ab,M,Y,X),U=E(L,ab,M,Y);p.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(ah,ac,aj,A,ai,af){var ak=this;ah.moveTo(ac,aj);ah.lineTo(A,ai);var ad=Math.atan2(ai-aj,A-ac),ag=(A+ac)/2,ae=(ai+aj)/2;A=A-15*Math.cos(ad);ai=ai-15*Math.sin(ad);ak.drawPolygon(ah,ak.translatePoints(ak.rotatePoints(af||ak.ARROW_POINTS,ad),A,ai));},drawPolygon:function(ac,ad){var A=this;ac.moveTo(ad[0][0],ad[0][1]);u.each(ad,function(af,ae){if(ae>0){ac.lineTo(ad[ae][0],ad[ae][1]);}});ac.lineTo(ad[0][0],ad[0][1]);},translatePoints:function(ad,ac,af){var A=this;var ae=[];u.each(ad,function(ah,ag){ae.push([ad[ag][0]+ac,ad[ag][1]+af]);});return ae;},rotatePoints:function(ac,ae){var A=this;var ad=[];u.each(ac,function(ag,af){ad.push(A.rotatePoint(ae,ac[af][0],ac[af][1]));});return ad;},rotatePoint:function(ac,A,ad){return[(A*Math.cos(ac))-(ad*Math.sin(ac)),(A*Math.sin(ac))+(ad*Math.cos(ac))];}};p.Connector=p.Base.create("line",p.Base,[],{SERIALIZABLE_ATTRS:[I,b,V,H,r,N,t,s],shape:null,initializer:function(ad){var A=this;var ac=A.get(V);A.after({p1Change:A.draw,p2Change:A.draw,selectedChange:A._afterSelectedChange});A._initShapes();if(!ac){A.draw();}A._uiSetSelected(A.get(F),!ac);},destroy:function(){var A=this;A.get(J).removeShape(A.shape);},draw:function(){var A=this;var ac=A.shape;var ae=A.getCoordinate(A.get(t));var ad=A.getCoordinate(A.get(s));ac.clear();p.PolygonUtil.drawLineArrow(ac,ae[0],ae[1],ad[0],ad[1],A.get(S));ac.end();},getCoordinate:function(ad){var A=this;var ac=A.get(J).getXY();return[ad[0]-ac[0],ad[1]-ac[1]];},getProperties:function(){var A=this;var ac=A.getPropertyModel();u.each(ac,function(ad){ad.value=A.get(ad.attributeName);});return ac;},getPropertyModel:function(){var ac=this;var ad=ac.get(M);var A=ad?ad.get(D).getStrings():{};return[{attributeName:b,editor:new p.TextAreaCellEditor(),name:A[b]},{attributeName:H,editor:new p.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[H]}];},toJSON:function(){var A=this;var ac={};u.each(A.SERIALIZABLE_ATTRS,function(ad){ac[ad]=A.get(ad);});return ac;},_afterSelectedChange:function(ac){var A=this;A._uiSetSelected(ac.newVal);},_initShapes:function(){var A=this;var ac=A.shape=A.get(J).addShape(A.get(B));ac.on(P,p.bind(A._onShapeClick,A));ac.on(g,p.bind(A._onShapeMouseEnter,A));ac.on(q,p.bind(A._onShapeMouseLeave,A));},_onShapeClick:function(af){var A=this;var ad=A.get(M);var ae=A.get(F);if(ad){var ac=ad.getBuilder();if(af.hasModifier()){ac.closeEditProperties();}else{ac.unselectConnectors();if(ae){ac.closeEditProperties();}else{ac.editConnector(A);}}}A.set(F,!ae);},_onShapeMouseEnter:function(ac){var A=this;if(!A.get(F)){A._updateShape(A.get(N));}},_onShapeMouseLeave:function(ac){var A=this;if(!A.get(F)){A._updateShape(A.get(B));}},_setShape:function(ac){var A=this;return p.merge({type:h,stroke:{color:A.get(I),weight:3},fill:{color:A.get(I)}},ac);},_updateShape:function(ae,ac){var A=this;var ad=A.shape;if(ae.hasOwnProperty(K)){ad.set(K,ae[K]);}if(ae.hasOwnProperty(i)){ad.set(i,ae[i]);}if(ac!==false){A.draw();}},_uiSetSelected:function(ad,ac){var A=this;A._updateShape(ad?A.get(r):A.get(B),ac);}},{ATTRS:{anchor:{},color:{value:"#27aae1",validator:m},description:{value:w,validator:m},lazyDraw:{value:false,validator:G},name:{valueFn:function(){var A=this;return x+(++p.Env._uidx);},validator:m},graphic:{validator:Q},shapeHover:{value:{fill:{color:"#666"},stroke:{color:"#666",weight:5}}},selected:{value:false,validator:G},shape:{value:null,setter:"_setShape"},shapeSelected:{value:{fill:{color:"#000"},stroke:{color:"#000",weight:5}}},arrowPoints:{value:p.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:C},p2:{value:[0,0],validator:C}}});p.Anchor=p.Base.create("anchor",p.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+e+'"></div>',NODE_TEMPLATE:'<div class="'+U+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(n));},addSource:function(ac){var A=this;if(A.get(l).size()<A.get(o)){A.set(l,A.get(l).remove(ac).add(ac));}return A;},addTarget:function(ac){var A=this;if(A.get(j).size()<A.get(n)){A.set(j,A.get(j).remove(ac).add(ac));}return A;},alignConnectors:function(){var A=this;A.get(j).each(function(ac){var ad=A.getConnector(ac);if(ad){ad.set(t,A.getCenterXY());ad.set(s,ac.getCenterXY());}});A.get(l).each(function(ac){var ad=ac.getConnector(A);if(ad){ad.set(t,ac.getCenterXY());ad.set(s,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(Y).remove();},connect:function(ad,ac){var A=this;if(v(ad)){ad=ad.findAvailableAnchor();}A.addTarget(ad);ad.addSource(A);if(!A.isConnected(ad)){var ae=p.merge(ad.get(x),ac);ae.anchor=A;ae.p1=A.getCenterXY();ae.p2=ad.getCenterXY();A.connectors[ad.get(z)]=new p.Connector(ae);}setTimeout(function(){ad.get(D).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(j).each(p.bind(A.connect,A));return A;},disconnect:function(ac){var A=this;A.getConnector(ac).destroy();A.removeTarget(ac);ac.removeSource(A);setTimeout(function(){ac.get(D).syncDropTargets();
},50);},disconnectTargets:function(){var A=this;A.get(j).each(function(ac){A.disconnect(ac);});return A;},disconnectSources:function(){var A=this;A.get(l).each(function(ac){ac.disconnect(A);});return A;},findConnectorTarget:function(ac){var A=this;var ad=null;p.some(A.connectors,function(af,ae){if(af===ac){ad=p.Anchor.getAnchorByNode(k+ae);return true;}});return ad;},getBuilder:function(){var A=this;return A.get(D).get(ab);},getCenterXY:function(){var A=this;return A.get(Y).getCenterXY();},getConnector:function(ac){var A=this;return A.connectors[ac.get(z)];},hasConnection:function(){var A=this;return((A.get(j).size()>0)||(A.get(l).size()>0));},isConnected:function(ac){var A=this;return A.connectors.hasOwnProperty(ac.get(z));},removeSource:function(ac){var A=this;A.set(l,A.get(l).remove(ac));return A;},removeTarget:function(ac){var A=this;A.set(j,A.get(j).remove(ac));delete A.connectors[ac.get(z)];return A;},_afterSourcesChange:function(ac){var A=this;A._uiSetSources(ac.newVal);},_afterTargetsChange:function(ac){var A=this;ac.prevVal.each(function(ad){ad.removeSource(A);});ac.newVal.each(function(ad){ad.addSource(A);});A._uiSetTargets(ac.newVal);},_renderNode:function(){var A=this;var ad=A.get(D);var ac=ad.get(T);A.wrapper=ac.one(y+e)||p.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(ac).appendChild(A.get(Y));},_setConnector:function(ac){var A=this;return p.merge({graphic:A.getBuilder().get(J)},ac);},_setSources:function(ac){var A=this;return A._setAnchors(ac);},_setTargets:function(ac){var A=this;ac=A._setAnchors(ac,true);ac.each(function(ad){ad.addSource(A);});return ac;},_setAnchors:function(ae,ad){var A=this;if(!R(ae)){var ac=[];p.Array.some(ae,function(ag,af){if(af>=A.get(ag?n:o)){return true;}ac.push(d(ag)?ag:new p.Anchor(ag));});ae=new p.ArrayList(ac);}return ae;},_setMaxSources:function(ac){var A=this;A._uiSetMaxSources(A.get(o));return ac;},_setMaxTargets:function(ac){var A=this;A._uiSetMaxTargets(A.get(n));return ac;},_setNode:function(ac){var A=this;var ad=A.get(z);return p.one(ac).set(z,ad).setData(a,A);},_uiSetSources:function(ac){var A=this;A._uiSetMaxSources(A.get(o));},_uiSetMaxSources:function(ad){var A=this;var ac=A.get(Y);ac.toggleClass(f,(A.get(l).size()===ad));},_uiSetMaxTargets:function(ad){var A=this;var ac=A.get(Y);ac.toggleClass(c,(A.get(j).size()===ad));},_uiSetTargets:function(ac){var A=this;A._uiSetMaxTargets(A.get(n));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:O},id:{readOnly:true,valueFn:function(){return p.guid();}},maxSources:{setter:"_setMaxSources",value:1,validator:Z},maxTargets:{setter:"_setMaxTargets",value:1,validator:Z},node:{setter:"_setNode",valueFn:function(){var A=this;return p.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return C(A)||R(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return C(A)||R(A);}}},getAnchorByNode:function(A){return d(A)?A:p.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});