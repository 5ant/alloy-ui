AUI.add("aui-diagram-builder-connector",function(l){var O=l.Lang,t=O.isArray,w=O.isBoolean,N=O.isNumber,C=O.isObject,i=O.isString,D=l.Array,c=function(A){return(A instanceof l.Anchor);},F=function(A){return(A instanceof l.ArrayList);},o=function(A){return(A instanceof l.DiagramNode);},E=function(A){return(A instanceof l.Graphic);},B="anchor",G="arrowPoints",H="boundingBox",P="builder",x="color",p="connector",a="dataAnchor",z="diagram",u="diagramNode",y="graphic",r="id",J="lazyDraw",K="max",k="maxSources",j="maxTargets",L="node",n="p1",m="p2",f="path",s="shape",h="sources",g="targets",M="wrapper",q=".",v=l.getClassName,b=v(z,P,B,L,K,g),e=v(z,P,B,L,K,h),d=v(z,P,B,L,M),I=v(z,P,B,L);l.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(V,Q,X,A,W,T){var Y=this;V.moveTo(Q,X);V.lineTo(A,W);var R=Math.atan2(W-X,A-Q),U=(A+Q)/2,S=(W+X)/2;Y.drawPolygon(V,Y.translatePoints(Y.rotatePoints(T||Y.ARROW_POINTS,R),U,S));},drawPolygon:function(Q,R){var A=this;Q.moveTo(R[0][0],R[0][1]);D.each(R,function(T,S){if(S>0){Q.lineTo(R[S][0],R[S][1]);}});Q.lineTo(R[0][0],R[0][1]);Q.end();},translatePoints:function(R,Q,T){var A=this;var S=[];D.each(R,function(V,U){S.push([R[U][0]+Q,R[U][1]+T]);});return S;},rotatePoints:function(Q,S){var A=this;var R=[];D.each(Q,function(U,T){R.push(A.rotatePoint(S,Q[T][0],Q[T][1]));});return R;},rotatePoint:function(Q,A,R){return[(A*Math.cos(Q))-(R*Math.sin(Q)),(A*Math.sin(Q))+(R*Math.cos(Q))];}};l.Connector=l.Base.create("line",l.Base,[],{shape:null,initializer:function(Q){var A=this;A.after({p1Change:A.draw,p2Change:A.draw});A._initShapes();if(!A.get(J)){A.draw();}},destroy:function(){var A=this;A.get(y).removeShape(A.shape);},draw:function(){var A=this;var Q=A.shape;var S=A.getCoordinate(A.get(n));var R=A.getCoordinate(A.get(m));Q.clear();l.PolygonUtil.drawLineArrow(Q,S[0],S[1],R[0],R[1],A.get(G));},getCoordinate:function(R){var A=this;var Q=A.get(y).getXY();return[R[0]-Q[0],R[1]-Q[1]];},_initShapes:function(){var A=this;A.shape=A.get(y).getShape(A.get(s));},_setShape:function(Q){var A=this;return l.merge({type:f,stroke:{color:A.get(x),weight:2},fill:{color:A.get(x)}},Q);}},{ATTRS:{color:{value:"#666",validator:i},lazyDraw:{value:false,validator:w},graphic:{validator:E},shape:{value:null,setter:"_setShape"},arrowPoints:{value:l.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:t},p2:{value:[0,0],validator:t}}});l.Anchor=l.Base.create("anchor",l.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+d+'"></div>',NODE_TEMPLATE:'<div class="'+I+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(j));},addSource:function(Q){var A=this;if(A.get(h).size()<A.get(k)){A.set(h,A.get(h).remove(Q).add(Q));}return A;},addTarget:function(Q){var A=this;if(A.get(g).size()<A.get(j)){A.set(g,A.get(g).remove(Q).add(Q));}return A;},alignConnectors:function(){var A=this;A.get(g).each(function(Q){var R=A.getConnector(Q);if(R){R.set(n,A.getCenterXY());R.set(m,Q.getCenterXY());}});A.get(h).each(function(Q){var R=Q.getConnector(A);if(R){R.set(n,Q.getCenterXY());R.set(m,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(L).remove();},connect:function(Q){var A=this;if(o(Q)){Q=Q.findAvailableAnchor();}A.addTarget(Q);Q.addSource(A);if(!A.isConnected(Q)){var R=Q.get(p);R.p1=A.getCenterXY();R.p2=Q.getCenterXY();A.connectors[Q.get(r)]=new l.Connector(R);}setTimeout(function(){Q.get(u).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(g).each(l.bind(A.connect,A));return A;},disconnect:function(Q){var A=this;A.getConnector(Q).destroy();A.removeTarget(Q);Q.removeSource(A);setTimeout(function(){Q.get(u).syncDropTargets();},50);},disconnectTargets:function(){var A=this;A.get(g).each(function(Q){A.disconnect(Q);});return A;},disconnectSources:function(){var A=this;A.get(h).each(function(Q){Q.disconnect(A);});return A;},getCenterXY:function(){var A=this;return A.get(L).getCenterXY();},getConnector:function(Q){var A=this;return A.connectors[Q.get(r)];},hasConnection:function(){var A=this;return((A.get(g).size()>0)||(A.get(h).size()>0));},isConnected:function(Q){var A=this;return A.connectors.hasOwnProperty(Q.get(r));},removeSource:function(Q){var A=this;A.set(h,A.get(h).remove(Q));return A;},removeTarget:function(Q){var A=this;A.set(g,A.get(g).remove(Q));return A;},_afterSourcesChange:function(Q){var A=this;A._uiSetSources(Q.newVal);},_afterTargetsChange:function(Q){var A=this;Q.prevVal.each(function(R){R.removeSource(A);});Q.newVal.each(function(R){R.addSource(A);});A._uiSetTargets(Q.newVal);},_renderNode:function(){var A=this;var R=A.get(u);var Q=R.get(H);A.wrapper=Q.one(q+d)||l.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(Q).appendChild(A.get(L));},_setConnector:function(Q){var A=this;return l.merge({graphic:A.get(y)},Q);},_setSources:function(Q){var A=this;return A._setAnchors(Q);},_setTargets:function(Q){var A=this;Q=A._setAnchors(Q,true);Q.each(function(R){R.addSource(A);});return Q;},_setAnchors:function(S,R){var A=this;if(!F(S)){var Q=[];l.Array.some(S,function(U,T){if(T>=A.get(U?j:k)){return true;}Q.push(c(U)?U:new l.Anchor(U));});S=new l.ArrayList(Q);}return S;},_setMaxSources:function(Q){var A=this;A._uiSetMaxSources(A.get(k));return Q;},_setMaxTargets:function(Q){var A=this;A._uiSetMaxTargets(A.get(j));return Q;},_setNode:function(Q){var A=this;var R=A.get(r);return l.one(Q).set(r,R).setData(a,A);},_uiSetSources:function(Q){var A=this;A._uiSetMaxSources(A.get(k));},_uiSetMaxSources:function(R){var A=this;var Q=A.get(L);Q.toggleClass(e,(A.get(h).size()===R));},_uiSetMaxTargets:function(R){var A=this;var Q=A.get(L);Q.toggleClass(b,(A.get(g).size()===R));},_uiSetTargets:function(Q){var A=this;A._uiSetMaxTargets(A.get(j));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:C},graphic:{validator:E},id:{readOnly:true,valueFn:function(){return l.guid();
}},maxSources:{setter:"_setMaxSources",value:1,validator:N},maxTargets:{setter:"_setMaxTargets",value:1,validator:N},node:{setter:"_setNode",valueFn:function(){var A=this;return l.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return t(A)||F(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return t(A)||F(A);}}},getAnchorByNode:function(A){return c(A)?A:l.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});