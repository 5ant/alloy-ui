AUI.add("aui-diagram-builder-connector",function(m){var Q=m.Lang,u=Q.isArray,y=Q.isBoolean,P=Q.isNumber,D=Q.isObject,j=Q.isString,G=m.Array,d=function(A){return(A instanceof m.Anchor);},H=function(A){return(A instanceof m.ArrayList);},p=function(A){return(A instanceof m.DiagramNode);},C="anchor",I="arrowPoints",F="body",J="boundingBox",R="builder",z="color",q="connector",a="dataAnchor",B="diagram",v="diagramNode",x="height",s="id",L="lazyDraw",M="max",l="maxSources",k="maxTargets",O="node",o="p1",n="p2",g="path",t="shape",i="sources",h="targets",E="viewport",c="width",N="wrapper",r=".",w=m.getClassName,b=w(B,R,C,O,M,h),f=w(B,R,C,O,M,i),e=w(B,R,C,O,N),K=w(B,R,C,O);m.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(X,S,Z,A,Y,V){var aa=this;X.moveTo(S,Z);X.lineTo(A,Y);var T=Math.atan2(Y-Z,A-S),W=(A+S)/2,U=(Y+Z)/2;aa.drawPolygon(X,aa.translatePoints(aa.rotatePoints(V||aa.ARROW_POINTS,T),W,U));},drawPolygon:function(S,T){var A=this;S.moveTo(T[0][0],T[0][1]);G.each(T,function(V,U){if(U>0){S.lineTo(T[U][0],T[U][1]);}});S.lineTo(T[0][0],T[0][1]);S.end();},translatePoints:function(T,S,V){var A=this;var U=[];G.each(T,function(X,W){U.push([T[W][0]+S,T[W][1]+V]);});return U;},rotatePoints:function(S,U){var A=this;var T=[];G.each(S,function(W,V){T.push(A.rotatePoint(U,S[V][0],S[V][1]));});return T;},rotatePoint:function(S,A,T){return[(A*Math.cos(S))-(T*Math.sin(S)),(A*Math.sin(S))+(T*Math.cos(S))];}};m.Connector=m.Base.create("line",m.Base,[],{graphics:null,shape:null,initializer:function(S){var A=this;A.after({p1Change:A.draw,p2Change:A.draw});A._initGraphics();A._initShapes();if(!A.get(L)){A.draw();}},destroy:function(){var A=this;A.graphics.destroy();},draw:function(){var A=this;var S=A.shape;var U=A.getCoordinate(A.get(o));var T=A.getCoordinate(A.get(n));S.clear();m.PolygonUtil.drawLineArrow(S,U[0],U[1],T[0],T[1],A.get(I));},getCoordinate:function(T){var A=this;var S=A.get(E).getXY();return[T[0]-S[0],T[1]-S[1]];},_initGraphics:function(){var A=this;var S=new m.Graphic({width:A.get(c),height:A.get(x),render:A.get(E)});A.graphics=S;},_initShapes:function(){var A=this;A.shape=A.graphics.getShape(A.get(t));},_setShape:function(S){var A=this;return m.merge({type:g,stroke:{color:A.get(z),weight:2},fill:{color:A.get(z)}},S);}},{ATTRS:{color:{value:"#666",validator:j},lazyDraw:{value:false,validator:y},viewport:{setter:m.one,value:F},shape:{value:null,setter:"_setShape"},arrowPoints:{value:m.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:u},p2:{value:[0,0],validator:u}}});m.Anchor=m.Base.create("anchor",m.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+e+'"></div>',NODE_TEMPLATE:'<div class="'+K+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(k));},addSource:function(S){var A=this;if(A.get(i).size()<A.get(l)){A.set(i,A.get(i).remove(S).add(S));}return A;},addTarget:function(S){var A=this;if(A.get(h).size()<A.get(k)){A.set(h,A.get(h).remove(S).add(S));}return A;},alignConnectors:function(){var A=this;A.get(h).each(function(S){var T=A.getConnector(S);if(T){T.set(o,A.getCenterXY());T.set(n,S.getCenterXY());}});A.get(i).each(function(S){var T=S.getConnector(A);if(T){T.set(o,S.getCenterXY());T.set(n,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(O).remove();},connect:function(S){var A=this;if(p(S)){S=S.findAvailableAnchor();}A.addTarget(S);S.addSource(A);if(!A.isConnected(S)){var T=S.get(q);T.p1=A.getCenterXY();T.p2=S.getCenterXY();A.connectors[S.get(s)]=new m.Connector(T);}setTimeout(function(){S.get(v).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(h).each(m.bind(A.connect,A));return A;},disconnect:function(S){var A=this;A.getConnector(S).destroy();A.removeTarget(S);S.removeSource(A);setTimeout(function(){S.get(v).syncDropTargets();},50);},disconnectTargets:function(){var A=this;A.get(h).each(function(S){A.disconnect(S);});return A;},disconnectSources:function(){var A=this;A.get(i).each(function(S){S.disconnect(A);});return A;},getCenterXY:function(){var A=this;return A.get(O).getCenterXY();},getConnector:function(S){var A=this;return A.connectors[S.get(s)];},hasConnection:function(){var A=this;return((A.get(h).size()>0)||(A.get(i).size()>0));},isConnected:function(S){var A=this;return A.connectors.hasOwnProperty(S.get(s));},removeSource:function(S){var A=this;A.set(i,A.get(i).remove(S));return A;},removeTarget:function(S){var A=this;A.set(h,A.get(h).remove(S));return A;},_afterSourcesChange:function(S){var A=this;A._uiSetSources(S.newVal);},_afterTargetsChange:function(S){var A=this;S.prevVal.each(function(T){T.removeSource(A);});S.newVal.each(function(T){T.addSource(A);});A._uiSetTargets(S.newVal);},_renderNode:function(){var A=this;var T=A.get(v);var S=T.get(J);A.wrapper=S.one(r+e)||m.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(S).appendChild(A.get(O));},_setConnector:function(S){var A=this;return m.merge({viewport:A.get(E)},S);},_setSources:function(S){var A=this;return A._setAnchors(S);},_setTargets:function(S){var A=this;S=A._setAnchors(S,true);S.each(function(T){T.addSource(A);});return S;},_setAnchors:function(U,T){var A=this;if(!H(U)){var S=[];m.Array.some(U,function(W,V){if(V>=A.get(W?k:l)){return true;}S.push(d(W)?W:new m.Anchor(W));});U=new m.ArrayList(S);}return U;},_setMaxSources:function(S){var A=this;A._uiSetMaxSources(A.get(l));return S;},_setMaxTargets:function(S){var A=this;A._uiSetMaxTargets(A.get(k));return S;},_setNode:function(S){var A=this;var T=A.get(s);return m.one(S).set(s,T).setData(a,A);},_uiSetSources:function(S){var A=this;A._uiSetMaxSources(A.get(l));},_uiSetMaxSources:function(T){var A=this;var S=A.get(O);S.toggleClass(f,(A.get(i).size()===T));},_uiSetMaxTargets:function(T){var A=this;var S=A.get(O);S.toggleClass(b,(A.get(h).size()===T));},_uiSetTargets:function(S){var A=this;
A._uiSetMaxTargets(A.get(k));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:D},id:{readOnly:true,valueFn:function(){return m.guid();}},maxSources:{setter:"_setMaxSources",value:1,validator:P},maxTargets:{setter:"_setMaxTargets",value:1,validator:P},node:{setter:"_setNode",valueFn:function(){var A=this;return m.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return u(A)||H(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return u(A)||H(A);}},viewport:{setter:m.one,value:F}},getAnchorByNode:function(A){return d(A)?A:m.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});