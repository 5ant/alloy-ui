AUI.add("aui-diagram-builder-connector",function(o){var Z=o.Lang,B=Z.isArray,F=Z.isBoolean,Y=Z.isNumber,N=Z.isObject,l=Z.isString,t=o.Array,c=function(A){return(A instanceof o.Anchor);},Q=function(A){return(A instanceof o.ArrayList);},u=function(A){return(A instanceof o.DiagramNode);},P=function(A){return(A instanceof o.Graphic);},L="anchor",R="arrowPoints",S="boundingBox",aa="builder",O="click",H="color",w="connector",a="dataAnchor",K="diagram",C="diagramNode",J="fill",I="graphic",y="id",U="lazyDraw",V="max",n="maxSources",m="maxTargets",f="mouseenter",p="mouseleave",G="name",X="node",s="p1",r="p2",g="path",E="selected",z="shape",M="shapeHover",q="shapeSelected",k="sources",h="stroke",i="targets",W="wrapper",x=".",v="",j="#",D=o.getClassName,b=D(K,aa,L,X,V,i),e=D(K,aa,L,X,V,k),d=D(K,aa,L,X,W),T=D(K,aa,L,X);o.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(ag,ab,ai,A,ah,ae){var aj=this;ag.moveTo(ab,ai);ag.lineTo(A,ah);var ac=Math.atan2(ah-ai,A-ab),af=(A+ab)/2,ad=(ah+ai)/2;A=A-15*Math.cos(ac);ah=ah-15*Math.sin(ac);aj.drawPolygon(ag,aj.translatePoints(aj.rotatePoints(ae||aj.ARROW_POINTS,ac),A,ah));},drawPolygon:function(ab,ac){var A=this;ab.moveTo(ac[0][0],ac[0][1]);t.each(ac,function(ae,ad){if(ad>0){ab.lineTo(ac[ad][0],ac[ad][1]);}});ab.lineTo(ac[0][0],ac[0][1]);},translatePoints:function(ac,ab,ae){var A=this;var ad=[];t.each(ac,function(ag,af){ad.push([ac[af][0]+ab,ac[af][1]+ae]);});return ad;},rotatePoints:function(ab,ad){var A=this;var ac=[];t.each(ab,function(af,ae){ac.push(A.rotatePoint(ad,ab[ae][0],ab[ae][1]));});return ac;},rotatePoint:function(ab,A,ac){return[(A*Math.cos(ab))-(ac*Math.sin(ab)),(A*Math.sin(ab))+(ac*Math.cos(ab))];}};o.Connector=o.Base.create("line",o.Base,[],{SERIALIZABLE_ATTRS:[H,U,G,q,M,s,r],shape:null,initializer:function(ac){var A=this;var ab=A.get(U);A.after({p1Change:A.draw,p2Change:A.draw,selectedChange:A._afterSelectedChange});A._initShapes();if(!ab){A.draw();}A._uiSetSelected(A.get(E),!ab);},destroy:function(){var A=this;A.get(I).removeShape(A.shape);},draw:function(){var A=this;var ab=A.shape;var ad=A.getCoordinate(A.get(s));var ac=A.getCoordinate(A.get(r));ab.clear();o.PolygonUtil.drawLineArrow(ab,ad[0],ad[1],ac[0],ac[1],A.get(R));ab.end();},getCoordinate:function(ac){var A=this;var ab=A.get(I).getXY();return[ac[0]-ab[0],ac[1]-ab[1]];},getProperties:function(){var A=this;var ab=A.getPropertyModel();t.each(ab,function(ac){ac.value=A.get(ac.attributeName);});return ab;},getPropertyModel:function(){var ab=this;var ac=ab.get(L);var A=ac?ac.get(C).getStrings():{};return[{attributeName:G,editor:new o.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[G]}];},toJSON:function(){var A=this;var ab={};t.each(A.SERIALIZABLE_ATTRS,function(ac){ab[ac]=A.get(ac);});return ab;},_afterSelectedChange:function(ab){var A=this;A._uiSetSelected(ab.newVal);},_initShapes:function(){var A=this;var ab=A.shape=A.get(I).addShape(A.get(z));ab.on(O,o.bind(A._onShapeClick,A));ab.on(f,o.bind(A._onShapeMouseEnter,A));ab.on(p,o.bind(A._onShapeMouseLeave,A));},_onShapeClick:function(ae){var A=this;var ac=A.get(L);var ad=A.get(E);if(ac){var ab=ac.getBuilder();if(ae.hasModifier()){ab.closeEditProperties();}else{ab.unselectConnectors();if(ad){ab.closeEditProperties();}else{ab.editConnector(A);}}}A.set(E,!ad);},_onShapeMouseEnter:function(ab){var A=this;if(!A.get(E)){A._updateShape(A.get(M));}},_onShapeMouseLeave:function(ab){var A=this;if(!A.get(E)){A._updateShape(A.get(z));}},_setShape:function(ab){var A=this;return o.merge({type:g,stroke:{color:A.get(H),weight:3},fill:{color:A.get(H)}},ab);},_updateShape:function(ad,ab){var A=this;var ac=A.shape;if(ad.hasOwnProperty(J)){ac.set(J,ad[J]);}if(ad.hasOwnProperty(h)){ac.set(h,ad[h]);}if(ab!==false){A.draw();}},_uiSetSelected:function(ac,ab){var A=this;A._updateShape(ac?A.get(q):A.get(z),ab);}},{ATTRS:{anchor:{},color:{value:"#27aae1",validator:l},lazyDraw:{value:false,validator:F},name:{valueFn:function(){var A=this;return w+(++o.Env._uidx);},validator:l},graphic:{validator:P},shapeHover:{value:{fill:{color:"#666"},stroke:{color:"#666",weight:5}}},selected:{value:false,validator:F},shape:{value:null,setter:"_setShape"},shapeSelected:{value:{fill:{color:"#000"},stroke:{color:"#000",weight:5}}},arrowPoints:{value:o.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:B},p2:{value:[0,0],validator:B}}});o.Anchor=o.Base.create("anchor",o.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+d+'"></div>',NODE_TEMPLATE:'<div class="'+T+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(m));},addSource:function(ab){var A=this;if(A.get(k).size()<A.get(n)){A.set(k,A.get(k).remove(ab).add(ab));}return A;},addTarget:function(ab){var A=this;if(A.get(i).size()<A.get(m)){A.set(i,A.get(i).remove(ab).add(ab));}return A;},alignConnectors:function(){var A=this;A.get(i).each(function(ab){var ac=A.getConnector(ab);if(ac){ac.set(s,A.getCenterXY());ac.set(r,ab.getCenterXY());}});A.get(k).each(function(ab){var ac=ab.getConnector(A);if(ac){ac.set(s,ab.getCenterXY());ac.set(r,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(X).remove();},connect:function(ac,ab){var A=this;if(u(ac)){ac=ac.findAvailableAnchor();}A.addTarget(ac);ac.addSource(A);if(!A.isConnected(ac)){var ad=o.merge(ac.get(w),ab);ad.anchor=A;ad.p1=A.getCenterXY();ad.p2=ac.getCenterXY();A.connectors[ac.get(y)]=new o.Connector(ad);}setTimeout(function(){ac.get(C).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(i).each(o.bind(A.connect,A));return A;},disconnect:function(ab){var A=this;A.getConnector(ab).destroy();A.removeTarget(ab);ab.removeSource(A);setTimeout(function(){ab.get(C).syncDropTargets();},50);},disconnectTargets:function(){var A=this;A.get(i).each(function(ab){A.disconnect(ab);});return A;},disconnectSources:function(){var A=this;
A.get(k).each(function(ab){ab.disconnect(A);});return A;},findConnectorTarget:function(ab){var A=this;var ac=null;o.some(A.connectors,function(ae,ad){if(ae===ab){ac=o.Anchor.getAnchorByNode(j+ad);return true;}});return ac;},getBuilder:function(){var A=this;return A.get(C).get(aa);},getCenterXY:function(){var A=this;return A.get(X).getCenterXY();},getConnector:function(ab){var A=this;return A.connectors[ab.get(y)];},hasConnection:function(){var A=this;return((A.get(i).size()>0)||(A.get(k).size()>0));},isConnected:function(ab){var A=this;return A.connectors.hasOwnProperty(ab.get(y));},removeSource:function(ab){var A=this;A.set(k,A.get(k).remove(ab));return A;},removeTarget:function(ab){var A=this;A.set(i,A.get(i).remove(ab));delete A.connectors[ab.get(y)];return A;},_afterSourcesChange:function(ab){var A=this;A._uiSetSources(ab.newVal);},_afterTargetsChange:function(ab){var A=this;ab.prevVal.each(function(ac){ac.removeSource(A);});ab.newVal.each(function(ac){ac.addSource(A);});A._uiSetTargets(ab.newVal);},_renderNode:function(){var A=this;var ac=A.get(C);var ab=ac.get(S);A.wrapper=ab.one(x+d)||o.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(ab).appendChild(A.get(X));},_setConnector:function(ab){var A=this;return o.merge({graphic:A.getBuilder().get(I)},ab);},_setSources:function(ab){var A=this;return A._setAnchors(ab);},_setTargets:function(ab){var A=this;ab=A._setAnchors(ab,true);ab.each(function(ac){ac.addSource(A);});return ab;},_setAnchors:function(ad,ac){var A=this;if(!Q(ad)){var ab=[];o.Array.some(ad,function(af,ae){if(ae>=A.get(af?m:n)){return true;}ab.push(c(af)?af:new o.Anchor(af));});ad=new o.ArrayList(ab);}return ad;},_setMaxSources:function(ab){var A=this;A._uiSetMaxSources(A.get(n));return ab;},_setMaxTargets:function(ab){var A=this;A._uiSetMaxTargets(A.get(m));return ab;},_setNode:function(ab){var A=this;var ac=A.get(y);return o.one(ab).set(y,ac).setData(a,A);},_uiSetSources:function(ab){var A=this;A._uiSetMaxSources(A.get(n));},_uiSetMaxSources:function(ac){var A=this;var ab=A.get(X);ab.toggleClass(e,(A.get(k).size()===ac));},_uiSetMaxTargets:function(ac){var A=this;var ab=A.get(X);ab.toggleClass(b,(A.get(i).size()===ac));},_uiSetTargets:function(ab){var A=this;A._uiSetMaxTargets(A.get(m));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:N},id:{readOnly:true,valueFn:function(){return o.guid();}},maxSources:{setter:"_setMaxSources",value:1,validator:Y},maxTargets:{setter:"_setMaxTargets",value:1,validator:Y},node:{setter:"_setNode",valueFn:function(){var A=this;return o.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return B(A)||Q(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return B(A)||Q(A);}}},getAnchorByNode:function(A){return c(A)?A:o.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});