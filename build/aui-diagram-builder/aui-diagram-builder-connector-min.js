AUI.add("aui-diagram-builder-connector",function(k){var M=k.Lang,r=M.isArray,v=M.isBoolean,L=M.isNumber,z=M.isObject,h=M.isString,D=k.Array,b=function(A){return(A instanceof k.Anchor);},E=function(A){return(A instanceof k.ArrayList);},y="anchor",F="arrowPoints",C="body",G="boundingBox",N="builder",w="color",n="connector",a="dataAnchor",x="diagram",s="diagramNode",u="height",p="id",I="lazyDraw",j="maxSources",i="maxTargets",J="node",m="p1",l="p2",e="path",q="shape",g="sources",f="targets",B="viewport",c="width",K="wrapper",o=".",t=k.getClassName,d=t(x,N,y,J,K),H=t(x,N,y,J);k.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(T,O,V,A,U,R){var W=this;T.moveTo(O,V);T.lineTo(A,U);var P=Math.atan2(U-V,A-O),S=(A+O)/2,Q=(U+V)/2;W.drawPolygon(T,W.translatePoints(W.rotatePoints(R||W.ARROW_POINTS,P),S,Q));},drawPolygon:function(O,P){var A=this;O.moveTo(P[0][0],P[0][1]);D.each(P,function(R,Q){if(Q>0){O.lineTo(P[Q][0],P[Q][1]);}});O.lineTo(P[0][0],P[0][1]);O.end();},translatePoints:function(P,O,R){var A=this;var Q=[];D.each(P,function(T,S){Q.push([P[S][0]+O,P[S][1]+R]);});return Q;},rotatePoints:function(O,Q){var A=this;var P=[];D.each(O,function(S,R){P.push(A.rotatePoint(Q,O[R][0],O[R][1]));});return P;},rotatePoint:function(O,A,P){return[(A*Math.cos(O))-(P*Math.sin(O)),(A*Math.sin(O))+(P*Math.cos(O))];}};k.Connector=k.Base.create("line",k.Base,[],{graphics:null,shape:null,initializer:function(O){var A=this;A.after({p1Change:A.draw,p2Change:A.draw});A._initGraphics();A._initShapes();if(!A.get(I)){A.draw();}},destroy:function(){var A=this;A.graphics.destroy();},draw:function(){var A=this;var O=A.shape;var Q=A.getCoordinate(A.get(m));var P=A.getCoordinate(A.get(l));O.clear();k.PolygonUtil.drawLineArrow(O,Q[0],Q[1],P[0],P[1],A.get(F));},getCoordinate:function(P){var A=this;var O=A.get(B).getXY();return[P[0]-O[0],P[1]-O[1]];},_initGraphics:function(){var A=this;var O=new k.Graphic({width:A.get(c),height:A.get(u),render:A.get(B)});A.graphics=O;},_initShapes:function(){var A=this;A.shape=A.graphics.getShape(A.get(q));},_setShape:function(O){var A=this;return k.merge({type:e,stroke:{color:A.get(w),weight:2},fill:{color:A.get(w)}},O);}},{ATTRS:{color:{value:"#666",validator:h},lazyDraw:{value:false,validator:v},viewport:{setter:k.one,value:C},shape:{value:null,setter:"_setShape"},arrowPoints:{value:k.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:r},p2:{value:[0,0],validator:r}}});k.Anchor=k.Base.create("anchor",k.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+d+'"></div>',NODE_TEMPLATE:'<div class="'+H+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({targetsChange:A._afterTargetsChange});},addSource:function(O){var A=this;return A.updateSources(A.get(g).remove(O).add(O));},addTarget:function(O){var A=this;return A.updateTargets(A.get(f).remove(O).add(O));},alignConnectors:function(){var A=this;A.get(f).each(function(O){var P=A.getConnector(O);if(P){P.set(m,A.getCenterXY());P.set(l,O.getCenterXY());}});A.get(g).each(function(O){var P=O.getConnector(A);if(P){P.set(m,O.getCenterXY());P.set(l,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(J).remove();},connect:function(O){var A=this;A.addTarget(O);if(!A.isConnected(O)){var P=O.get(n);P.p1=A.getCenterXY();P.p2=O.getCenterXY();A.connectors[O.get(p)]=new k.Connector(P);}return A;},connectTargets:function(){var A=this;A.get(f).each(k.bind(A.connect,A));return A;},disconnect:function(O){var A=this;A.getConnector(O).destroy();A.removeTarget(O);O.removeSource(A);},disconnectTargets:function(){var A=this;A.get(f).each(function(O){A.disconnect(O);});return A;},disconnectSources:function(){var A=this;A.get(g).each(function(O){O.disconnect(A);});return A;},getCenterXY:function(){var A=this;return A.get(J).getCenterXY();},getConnector:function(O){var A=this;return A.connectors[O.get(p)];},isConnected:function(O){var A=this;return A.connectors.hasOwnProperty(O.get(p));},updateSources:function(O){var A=this;A.set(g,O);return A;},updateTargets:function(O){var A=this;A.set(f,O);return A;},removeSource:function(O){var A=this;return A.updateSources(A.get(g).remove(O));},removeTarget:function(O){var A=this;return A.updateTargets(A.get(f).remove(O));},_afterActiveChange:function(O){var A=this;A._uiSetActive(O.newVal);},_afterTargetsChange:function(O){var A=this;O.prevVal.each(function(P){P.removeSource(A);});O.newVal.each(function(P){P.addSource(A);});},_renderNode:function(){var A=this;var P=A.get(s);var O=P.get(G);A.wrapper=O.one(o+d)||k.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(O).appendChild(A.get(J));},_setConnector:function(O){var A=this;return k.merge({viewport:A.get(B)},O);},_setSources:function(O){var A=this;return A._setAnchors(O);},_setTargets:function(O){var A=this;O=A._setAnchors(O);O.each(function(P){P.addSource(A);});return O;},_setAnchors:function(P){var A=this;if(!E(P)){var O=[];k.Array.each(P,function(Q){if(h(Q)){Q=k.Anchor.getAnchorByNode(Q);}O.push(b(Q)?Q:new k.Anchor(Q));});P=new k.ArrayList(O);}return P;},_setNode:function(O){var A=this;var P=A.get(p);return k.one(O).set(p,P).setData(a,A);}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:z},id:{readOnly:true,valueFn:function(){return k.guid();}},maxSources:{value:Infinity,validator:L},maxTargets:{value:Infinity,validator:L},node:{setter:"_setNode",valueFn:function(){var A=this;return k.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return r(A)||E(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return r(A)||E(A);}},viewport:{setter:k.one,value:C}},getAnchorByNode:function(A){return k.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});