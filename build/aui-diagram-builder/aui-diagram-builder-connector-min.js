AUI.add("aui-diagram-builder-connector",function(o){var X=o.Lang,y=X.isArray,D=X.isBoolean,W=X.isNumber,L=X.isObject,l=X.isString,M=o.Array,c=function(A){return(A instanceof o.Anchor);},O=function(A){return(A instanceof o.ArrayList);},t=function(A){return(A instanceof o.DiagramNode);},N=function(A){return(A instanceof o.Graphic);},J="anchor",P="arrowPoints",Q="boundingBox",Y="builder",E="color",u="connector",a="dataAnchor",H="diagram",z="diagramNode",G="fill",F="graphic",w="id",S="lazyDraw",T="max",n="maxSources",m="maxTargets",I="mousedown",f="mouseenter",p="mouseleave",V="node",s="p1",r="p2",g="path",C="selected",x="shape",K="shapeHover",q="shapeSelected",k="sources",h="stroke",i="targets",U="wrapper",v=".",j="#",B=o.getClassName,b=B(H,Y,J,V,T,i),e=B(H,Y,J,V,T,k),d=B(H,Y,J,V,U),R=B(H,Y,J,V);o.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawLineArrow:function(ae,Z,ag,A,af,ac){var ah=this;ae.moveTo(Z,ag);ae.lineTo(A,af);var aa=Math.atan2(af-ag,A-Z),ad=(A+Z)/2,ab=(af+ag)/2;ah.drawPolygon(ae,ah.translatePoints(ah.rotatePoints(ac||ah.ARROW_POINTS,aa),ad,ab));},drawPolygon:function(Z,aa){var A=this;Z.moveTo(aa[0][0],aa[0][1]);M.each(aa,function(ac,ab){if(ab>0){Z.lineTo(aa[ab][0],aa[ab][1]);}});Z.lineTo(aa[0][0],aa[0][1]);},translatePoints:function(aa,Z,ac){var A=this;var ab=[];M.each(aa,function(ae,ad){ab.push([aa[ad][0]+Z,aa[ad][1]+ac]);});return ab;},rotatePoints:function(Z,ab){var A=this;var aa=[];M.each(Z,function(ad,ac){aa.push(A.rotatePoint(ab,Z[ac][0],Z[ac][1]));});return aa;},rotatePoint:function(Z,A,aa){return[(A*Math.cos(Z))-(aa*Math.sin(Z)),(A*Math.sin(Z))+(aa*Math.cos(Z))];}};o.Connector=o.Base.create("line",o.Base,[],{shape:null,initializer:function(aa){var A=this;var Z=A.get(S);A.after({p1Change:A.draw,p2Change:A.draw,selectedChange:A._afterSelectedChange});A._initShapes();if(!Z){A.draw();}A._uiSetSelected(A.get(C),!Z);},destroy:function(){var A=this;A.get(F).removeShape(A.shape);},draw:function(){var A=this;var Z=A.shape;var ab=A.getCoordinate(A.get(s));var aa=A.getCoordinate(A.get(r));Z.clear();o.PolygonUtil.drawLineArrow(Z,ab[0],ab[1],aa[0],aa[1],A.get(P));Z.end();},getCoordinate:function(aa){var A=this;var Z=A.get(F).getXY();return[aa[0]-Z[0],aa[1]-Z[1]];},_afterSelectedChange:function(Z){var A=this;A._uiSetSelected(Z.newVal);},_initShapes:function(){var A=this;var Z=A.shape=A.get(F).getShape(A.get(x));Z.on(I,o.bind(A._onShapeMouseDown,A));Z.on(f,o.bind(A._onShapeMouseEnter,A));Z.on(p,o.bind(A._onShapeMouseLeave,A));},_onShapeMouseDown:function(Z){var A=this;A.set(C,!A.get(C));},_onShapeMouseEnter:function(Z){var A=this;if(!A.get(C)){A._updateShape(A.get(K));}},_onShapeMouseLeave:function(Z){var A=this;if(!A.get(C)){A._updateShape(A.get(x));}},_setShape:function(Z){var A=this;return o.merge({type:g,stroke:{color:A.get(E),weight:2},fill:{color:A.get(E)}},Z);},_updateShape:function(ab,Z){var A=this;var aa=A.shape;if(ab.hasOwnProperty(G)){aa.set(G,ab[G]);}if(ab.hasOwnProperty(h)){aa.set(h,ab[h]);}if(Z!==false){A.draw();}},_uiSetSelected:function(aa,Z){var A=this;A._updateShape(aa?A.get(q):A.get(x),Z);}},{ATTRS:{anchor:{},color:{value:"#666",validator:l},lazyDraw:{value:false,validator:D},graphic:{validator:N},shapeHover:{value:{fill:{color:"red"},stroke:{color:"red",weight:2}}},selected:{value:false,validator:D},shape:{value:null,setter:"_setShape"},shapeSelected:{value:{fill:{color:"#000"},stroke:{color:"#000",weight:6}}},arrowPoints:{value:o.PolygonUtil.ARROW_POINTS},p1:{value:[0,0],validator:y},p2:{value:[0,0],validator:y}}});o.Anchor=o.Base.create("anchor",o.Base,[],{ANCHOR_WRAPPER_TEMPLATE:'<div class="'+d+'"></div>',NODE_TEMPLATE:'<div class="'+R+'"></div>',connectors:null,initializer:function(){var A=this;A.connectors={};A._renderNode();A.connectTargets();A.after({sourcesChange:A._afterSourcesChange,targetsChange:A._afterTargetsChange});A._uiSetMaxTargets(A.get(m));},addSource:function(Z){var A=this;if(A.get(k).size()<A.get(n)){A.set(k,A.get(k).remove(Z).add(Z));}return A;},addTarget:function(Z){var A=this;if(A.get(i).size()<A.get(m)){A.set(i,A.get(i).remove(Z).add(Z));}return A;},alignConnectors:function(){var A=this;A.get(i).each(function(Z){var aa=A.getConnector(Z);if(aa){aa.set(s,A.getCenterXY());aa.set(r,Z.getCenterXY());}});A.get(k).each(function(Z){var aa=Z.getConnector(A);if(aa){aa.set(s,Z.getCenterXY());aa.set(r,A.getCenterXY());}});return A;},destroy:function(){var A=this;A.disconnectTargets();A.disconnectSources();A.get(V).remove();},connect:function(Z){var A=this;if(t(Z)){Z=Z.findAvailableAnchor();}A.addTarget(Z);Z.addSource(A);if(!A.isConnected(Z)){var aa=Z.get(u);aa.anchor=A;aa.p1=A.getCenterXY();aa.p2=Z.getCenterXY();A.connectors[Z.get(w)]=new o.Connector(aa);}setTimeout(function(){Z.get(z).syncDropTargets();},50);return A;},connectTargets:function(){var A=this;A.get(i).each(o.bind(A.connect,A));return A;},disconnect:function(Z){var A=this;A.getConnector(Z).destroy();A.removeTarget(Z);Z.removeSource(A);setTimeout(function(){Z.get(z).syncDropTargets();},50);},disconnectTargets:function(){var A=this;A.get(i).each(function(Z){A.disconnect(Z);});return A;},disconnectSources:function(){var A=this;A.get(k).each(function(Z){Z.disconnect(A);});return A;},findConnectorTarget:function(Z){var A=this;var aa=null;o.some(A.connectors,function(ac,ab){if(ac===Z){aa=o.Anchor.getAnchorByNode(j+ab);return true;}});return aa;},getCenterXY:function(){var A=this;return A.get(V).getCenterXY();},getConnector:function(Z){var A=this;return A.connectors[Z.get(w)];},hasConnection:function(){var A=this;return((A.get(i).size()>0)||(A.get(k).size()>0));},isConnected:function(Z){var A=this;return A.connectors.hasOwnProperty(Z.get(w));},removeSource:function(Z){var A=this;A.set(k,A.get(k).remove(Z));return A;},removeTarget:function(Z){var A=this;A.set(i,A.get(i).remove(Z));delete A.connectors[Z.get(w)];return A;},_afterSourcesChange:function(Z){var A=this;A._uiSetSources(Z.newVal);},_afterTargetsChange:function(Z){var A=this;Z.prevVal.each(function(aa){aa.removeSource(A);});
Z.newVal.each(function(aa){aa.addSource(A);});A._uiSetTargets(Z.newVal);},_renderNode:function(){var A=this;var aa=A.get(z);var Z=aa.get(Q);A.wrapper=Z.one(v+d)||o.Node.create(A.ANCHOR_WRAPPER_TEMPLATE);A.wrapper.appendTo(Z).appendChild(A.get(V));},_setConnector:function(Z){var A=this;return o.merge({graphic:A.get(z).get(Y).get(F)},Z);},_setSources:function(Z){var A=this;return A._setAnchors(Z);},_setTargets:function(Z){var A=this;Z=A._setAnchors(Z,true);Z.each(function(aa){aa.addSource(A);});return Z;},_setAnchors:function(ab,aa){var A=this;if(!O(ab)){var Z=[];o.Array.some(ab,function(ad,ac){if(ac>=A.get(ad?m:n)){return true;}Z.push(c(ad)?ad:new o.Anchor(ad));});ab=new o.ArrayList(Z);}return ab;},_setMaxSources:function(Z){var A=this;A._uiSetMaxSources(A.get(n));return Z;},_setMaxTargets:function(Z){var A=this;A._uiSetMaxTargets(A.get(m));return Z;},_setNode:function(Z){var A=this;var aa=A.get(w);return o.one(Z).set(w,aa).setData(a,A);},_uiSetSources:function(Z){var A=this;A._uiSetMaxSources(A.get(n));},_uiSetMaxSources:function(aa){var A=this;var Z=A.get(V);Z.toggleClass(e,(A.get(k).size()===aa));},_uiSetMaxTargets:function(aa){var A=this;var Z=A.get(V);Z.toggleClass(b,(A.get(i).size()===aa));},_uiSetTargets:function(Z){var A=this;A._uiSetMaxTargets(A.get(m));}},{ATTRS:{diagramNode:{},connector:{setter:"_setConnector",value:{},validator:L},id:{readOnly:true,valueFn:function(){return o.guid();}},maxSources:{setter:"_setMaxSources",value:1,validator:W},maxTargets:{setter:"_setMaxTargets",value:1,validator:W},node:{setter:"_setNode",valueFn:function(){var A=this;return o.Node.create(A.NODE_TEMPLATE);}},sources:{value:[],setter:"_setSources",validator:function(A){return y(A)||O(A);}},targets:{value:[],setter:"_setTargets",validator:function(A){return y(A)||O(A);}}},getAnchorByNode:function(A){return c(A)?A:o.one(A).getData(a);}});},"@VERSION@",{requires:["aui-base","arraylist-add","arraylist-filter","json","graphics","dd"],skinnable:true});