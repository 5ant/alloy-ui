AUI.add("aui-image-cropper",function(b){var h=b.Lang,a=h.isBoolean,i=h.isNumber,g=h.toInt,c=b.ClassNameManager.getClassName,k="image-cropper",f=c(k,"crop"),e=c(k,"crop","outline"),d=c(k,"overlay");CSS_OVERLAY_HOVER=c(k,"crop","hover");var j=b.Component.create({NAME:k,ATTRS:{cropHeight:{value:100,validator:i},cropWidth:{value:100,validator:i},minWidth:{value:undefined},minHeight:{value:undefined},movable:{value:true,validator:a},preserveRatio:{value:false,validator:a},region:{getter:"_getCropRegion",value:{}},resizable:{value:true,validator:a},x:{value:0,setter:Math.round,validator:i},y:{value:0,setter:Math.round,validator:i}},UI_ATTRS:["cropHeight","cropWidth","minWidth","minHeight","movable","resizable","x","y"],prototype:{renderUI:function(){var l=this;var m=l.get("boundingBox");var n=l.get("srcNode");l.cropNode=b.Node.create('<div class="'+f+'"></div>');l.cropNode.append(b.Node.create('<div class="'+e+'"></div>'));l.overlay=b.Node.create('<div class="'+d+'"></div>');b.all([l.cropNode,l.overlay]).appendTo(m);l._boundingBox=m;l._renderDrag();l._renderResize();},bindUI:function(){var l=this;l._fireCropEventTask=b.debounce(l._fireCropEvent,10,l);l.publish("crop",{defaultFn:l._defCropFn});l.on(["drag:start","resize:start"],b.debounce(l._syncRegion,25));l.after(["drag:drag","resize:resize"],l._fireCropEvent,l);l.after(["xChange","yChange","cropWidthChange","cropHeightChange"],function(m){l._fireCropEventTask(m);l._syncCropNodeUI();});l.cropNode.hover(b.bind(l._hoverOverlay,l),b.bind(l._unHoverOverlay,l));},syncUI:function(){var l=this;l._uiSetPreserveRatio(l.get("preserveRatio"));l._syncImageUI();l._syncCropNodeUI();},destructor:function(){var l=this;l._destroyDrag();l._destroyResize();},_constrainValues:function(){var n=this;var r=n.get("srcNode");var o=n.get("cropHeight");var q=n.get("cropWidth");var m=n.get("x");var s=n.get("y");var p=r.width();var l=r.height();s=Math.max(s,0);if(s+o>l){s=Math.max(l-o,0);}n.set("y",s);if(s+o>l){o=Math.max(l-s,0);}n.set("cropHeight",o);m=Math.max(m,0);if(m+q>p){m=Math.max(p-q,0);}n.set("x",m);if(m+q>p){q=Math.max(p-m,0);}n.set("cropWidth",q);},_defCropFn:function(n){var l=this;var m=n.cropType;if(m=="drag:drag"){l._syncXY();}else{if(m=="resize:resize"){l._syncCropSize();}}},_destroyDrag:function(m){var l=this;if(l.drag){l.drag.destroy();delete l.drag;}},_destroyResize:function(m){var l=this;if(l.resize){l.resize.destroy();delete l.resize;}},_fireCropEvent:function(m){var l=this;l.fire("crop",{cropType:m.type});},_getConstraintRegion:function(q){var l=this;var r=!q?l._origRegion:null;if(!r){var s=l.get("srcNode");var n=l.cropNode;var m=s.getXY();var p=m[0];var o=m[1];r={bottom:o+s.height()+n.getBorderWidth("b"),left:p-n.getBorderWidth("l"),right:p+s.width()+n.getBorderWidth("r"),top:o-n.getBorderWidth("t")};if(!l._origRegion){l._origRegion=r;}}return r;},_getCropRegion:function(){var l=this;return{height:l.get("cropHeight"),width:l.get("cropWidth"),x:l.get("x"),y:l.get("y")};},_hoverOverlay:function(){var l=this;if(!l._isDragging()&&!l._isResizing()){l._boundingBox.addClass(CSS_OVERLAY_HOVER);}},_isDragging:function(){var l=this;var m=l.drag;return m&&m.get("dragging");},_isResizing:function(){var l=this;var m=l.resize;return m&&m.get("resizing");},_renderDrag:function(){var l=this;var m=new b.DD.Drag({node:l.cropNode}).plug(b.Plugin.DDConstrained,{constrain:l._getConstraintRegion()});m.addTarget(l);l.drag=m;},_renderResize:function(){var l=this;var m=new b.Resize({node:l.cropNode}).plug(b.Plugin.ResizeConstrained,{constrain:l._getConstraintRegion(),preserveRatio:l.get("preserveRatio"),minHeight:l.get("minHeight"),minWidth:l.get("minWidth")});m.addTarget(l);l.resize=m;},_syncCropNodeUI:function(){var l=this;l.cropNode.setStyle("backgroundPosition",(-l.get("x"))+"px "+(-l.get("y"))+"px");},_syncCropSize:function(n){var l=this;var m=l.cropNode;l.set("cropHeight",m.height());l.set("cropWidth",m.width());},_syncImageUI:function(){var l=this;var q=l.get("srcNode");var o=l.overlay;l.cropNode.setStyle("backgroundImage","url("+q.attr("src")+")");l._constrainValues();l._syncXY();var p=l._getConstraintRegion();var n=l.drag;var m=l.resize;if(n){n.con.set("constrain",p);}if(m){m.con.set("constrain",p);}},_syncRegion:function(p){var l=this;var q=l._getConstraintRegion(true);var o=l._origRegion;if(q.bottom!=o.bottom||q.left!=o.left||q.right!=o.right||q.top!=o.top){var n=l.drag;var m=l.resize;if(n){n.con.set("constrain",q);}if(m){m.con.set("constrain",q);}l._origRegion=q;}},_syncXY:function(n){var l=this;var m=l.cropNode;l.set("x",g(m.getStyle("left"))+m.getBorderWidth("l"));l.set("y",g(m.getStyle("top"))+m.getBorderWidth("t"));},_uiSetCropHeight:function(m){var l=this;l.cropNode.height(m);},_uiSetCropWidth:function(m){var l=this;l.cropNode.width(m);},_uiSetMinHeight:function(n){var l=this;var m=l.resize;if(m){m.con.set("minHeight",n);}},_uiSetMinWidth:function(n){var l=this;var m=l.resize;if(m){m.con.set("minWidth",n);}},_uiSetMovable:function(m){var l=this;l.drag.set("lock",!m);},_uiSetPreserveRatio:function(n){var l=this;var m=l.resize;if(m){m.con.set("preserveRatio",n);}},_uiSetResizable:function(m){var l=this;if(m){if(l._stopResizeHandle){l._stopResizeHandle.detach();}}else{if(!l._stopResizeHandle){l._stopResizeHandle=l.resize.on("resize:resize",function(n){n.halt();});}}},_uiSetX:function(n){var l=this;var o=l.get("srcNode");var m=l.cropNode;m.setStyle("left",n-m.getBorderWidth("l"));},_uiSetY:function(n){var l=this;var o=l.get("srcNode");var m=l.cropNode;m.setStyle("top",n-m.getBorderWidth("t"));},_unHoverOverlay:function(){var l=this;if(!l._isDragging()&&!l._isResizing()){l._boundingBox.removeClass(CSS_OVERLAY_HOVER);}}}});b.ImageCropper=j;},"@VERSION@",{requires:["widget","aui-base","aui-debounce","aui-resize","dd-constrain"],skinnable:true});