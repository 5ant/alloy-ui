/*
Copyright (c) 2010, Yahoo! Inc. All rights reserved.
Code licensed under the BSD License:
http://developer.yahoo.com/yui/license.html
version: 3.2.0
build: nightly
*/
YUI.add("dd-drag",function(b){var d=b.DD.DDM,q="node",f="dragging",p="dragNode",j="offsetHeight",c="offsetWidth",g="drag:mouseDown",k="drag:afterMouseDown",e="drag:removeHandle",l="drag:addHandle",m="drag:removeInvalid",r="drag:addInvalid",i="drag:start",h="drag:end",o="drag:drag",n="drag:align",a=function(t){this._lazyAddAttrs=false;a.superclass.constructor.apply(this,arguments);var s=d._regDrag(this);if(!s){b.error("Failed to register node, already in use: "+t.node);}};a.NAME="drag";a.START_EVENT="mousedown";a.ATTRS={node:{setter:function(s){var t=b.one(s);if(!t){b.error("DD.Drag: Invalid Node Given: "+s);}else{t=t.item(0);}return t;}},dragNode:{setter:function(s){var t=b.one(s);if(!t){b.error("DD.Drag: Invalid dragNode Given: "+s);}return t;}},offsetNode:{value:true},startCentered:{value:false},clickPixelThresh:{value:d.get("clickPixelThresh")},clickTimeThresh:{value:d.get("clickTimeThresh")},lock:{value:false,setter:function(s){if(s){this.get(q).addClass(d.CSS_PREFIX+"-locked");}else{this.get(q).removeClass(d.CSS_PREFIX+"-locked");}return s;}},data:{value:false},move:{value:true},useShim:{value:true},activeHandle:{value:false},primaryButtonOnly:{value:true},dragging:{value:false},parent:{value:false},target:{value:false,setter:function(s){this._handleTarget(s);return s;}},dragMode:{value:null,setter:function(s){return d._setDragMode(s);}},groups:{value:["default"],getter:function(){if(!this._groups){this._groups={};}var s=[];b.each(this._groups,function(u,t){s[s.length]=t;});return s;},setter:function(s){this._groups={};b.each(s,function(u,t){this._groups[u]=true;},this);return s;}},handles:{value:null,setter:function(s){if(s){this._handles={};b.each(s,function(u,t){var w=u;if(u instanceof b.Node||u instanceof b.NodeList){w=u._yuid;}this._handles[w]=u;},this);}else{this._handles=null;}return s;}},bubbles:{setter:function(s){this.addTarget(s);return s;}},haltDown:{value:true}};b.extend(a,b.Base,{_bubbleTargets:b.DD.DDM,addToGroup:function(s){this._groups[s]=true;d._activateTargets();return this;},removeFromGroup:function(s){delete this._groups[s];d._activateTargets();return this;},target:null,_handleTarget:function(s){if(b.DD.Drop){if(s===false){if(this.target){d._unregTarget(this.target);this.target=null;}return false;}else{if(!b.Lang.isObject(s)){s={};}s.bubbleTargets=("bubbleTargets" in s)?s.bubbleTargets:b.Object.values(this._yuievt.targets);s.node=this.get(q);s.groups=s.groups||this.get("groups");this.target=new b.DD.Drop(s);}}else{return false;}},_groups:null,_createEvents:function(){this.publish(g,{defaultFn:this._defMouseDownFn,queuable:false,emitFacade:true,bubbles:true,prefix:"drag"});this.publish(n,{defaultFn:this._defAlignFn,queuable:false,emitFacade:true,bubbles:true,prefix:"drag"});this.publish(o,{defaultFn:this._defDragFn,queuable:false,emitFacade:true,bubbles:true,prefix:"drag"});this.publish(h,{defaultFn:this._defEndFn,preventedFn:this._prevEndFn,queuable:false,emitFacade:true,bubbles:true,prefix:"drag"});var s=[k,e,l,m,r,i,"drag:drophit","drag:dropmiss","drag:over","drag:enter","drag:exit"];b.each(s,function(u,t){this.publish(u,{type:u,emitFacade:true,bubbles:true,preventable:false,queuable:false,prefix:"drag"});},this);},_ev_md:null,_startTime:null,_endTime:null,_handles:null,_invalids:null,_invalidsDefault:{"textarea":true,"input":true,"a":true,"button":true,"select":true},_dragThreshMet:null,_fromTimeout:null,_clickTimeout:null,deltaXY:null,startXY:null,nodeXY:null,lastXY:null,actXY:null,realXY:null,mouseXY:null,region:null,_handleMouseUp:function(s){this.fire("drag:mouseup");this._fixIEMouseUp();if(d.activeDrag){d._end();}},_fixDragStart:function(s){s.preventDefault();},_ieSelectFix:function(){return false;},_ieSelectBack:null,_fixIEMouseDown:function(){if(b.UA.ie){this._ieSelectBack=b.config.doc.body.onselectstart;b.config.doc.body.onselectstart=this._ieSelectFix;}},_fixIEMouseUp:function(){if(b.UA.ie){b.config.doc.body.onselectstart=this._ieSelectBack;}},_handleMouseDownEvent:function(s){this.fire(g,{ev:s});},_defMouseDownFn:function(t){var s=t.ev;this._dragThreshMet=false;this._ev_md=s;if(this.get("primaryButtonOnly")&&s.button>1){return false;}if(this.validClick(s)){this._fixIEMouseDown();if(this.get("haltDown")){s.halt();}else{s.preventDefault();}this._setStartPosition([s.pageX,s.pageY]);d.activeDrag=this;this._clickTimeout=b.later(this.get("clickTimeThresh"),this,this._timeoutCheck);}this.fire(k,{ev:s});},validClick:function(w){var v=false,z=false,s=w.target,u=null,t=null,x=null,y=false;if(this._handles){b.each(this._handles,function(A,B){if(A instanceof b.Node||A instanceof b.NodeList){if(!v){x=A;if(x instanceof b.Node){x=new b.NodeList(A._node);}x.each(function(C){if(C.contains(s)){v=true;}});}}else{if(b.Lang.isString(B)){if(s.test(B+", "+B+" *")&&!u){u=B;v=true;}}}});}else{z=this.get(q);if(z.contains(s)||z.compareTo(s)){v=true;}}if(v){if(this._invalids){b.each(this._invalids,function(A,B){if(b.Lang.isString(B)){if(s.test(B+", "+B+" *")){v=false;}}});}}if(v){if(u){t=w.currentTarget.all(u);y=false;t.each(function(B,A){if((B.contains(s)||B.compareTo(s))&&!y){y=true;this.set("activeHandle",B);}},this);}else{this.set("activeHandle",this.get(q));}}return v;},_setStartPosition:function(s){this.startXY=s;this.nodeXY=this.lastXY=this.realXY=this.get(q).getXY();if(this.get("offsetNode")){this.deltaXY=[(this.startXY[0]-this.nodeXY[0]),(this.startXY[1]-this.nodeXY[1])];}else{this.deltaXY=[0,0];}},_timeoutCheck:function(){if(!this.get("lock")&&!this._dragThreshMet&&this._ev_md){this._fromTimeout=this._dragThreshMet=true;this.start();this._alignNode([this._ev_md.pageX,this._ev_md.pageY],true);}},removeHandle:function(t){var s=t;if(t instanceof b.Node||t instanceof b.NodeList){s=t._yuid;}if(this._handles[s]){delete this._handles[s];this.fire(e,{handle:t});}return this;},addHandle:function(t){if(!this._handles){this._handles={};}var s=t;if(t instanceof b.Node||t instanceof b.NodeList){s=t._yuid;}this._handles[s]=t;this.fire(l,{handle:t});return this;},removeInvalid:function(s){if(this._invalids[s]){this._invalids[s]=null;
delete this._invalids[s];this.fire(m,{handle:s});}return this;},addInvalid:function(s){if(b.Lang.isString(s)){this._invalids[s]=true;this.fire(r,{handle:s});}return this;},initializer:function(s){this.get(q).dd=this;if(!this.get(q).get("id")){var t=b.stamp(this.get(q));this.get(q).set("id",t);}this.actXY=[];this._invalids=b.clone(this._invalidsDefault,true);this._createEvents();if(!this.get(p)){this.set(p,this.get(q));}this.on("initializedChange",b.bind(this._prep,this));this.set("groups",this.get("groups"));},_prep:function(){this._dragThreshMet=false;var s=this.get(q);s.addClass(d.CSS_PREFIX+"-draggable");s.on(a.START_EVENT,b.bind(this._handleMouseDownEvent,this));s.on("mouseup",b.bind(this._handleMouseUp,this));s.on("dragstart",b.bind(this._fixDragStart,this));},_unprep:function(){var s=this.get(q);s.removeClass(d.CSS_PREFIX+"-draggable");s.detachAll();},start:function(){if(!this.get("lock")&&!this.get(f)){var t=this.get(q),s,u,v;this._startTime=(new Date()).getTime();d._start();t.addClass(d.CSS_PREFIX+"-dragging");this.fire(i,{pageX:this.nodeXY[0],pageY:this.nodeXY[1],startTime:this._startTime});t=this.get(p);v=this.nodeXY;s=t.get(c);u=t.get(j);if(this.get("startCentered")){this._setStartPosition([v[0]+(s/2),v[1]+(u/2)]);}this.region={"0":v[0],"1":v[1],area:0,top:v[1],right:v[0]+s,bottom:v[1]+u,left:v[0]};this.set(f,true);}return this;},end:function(){this._endTime=(new Date()).getTime();if(this._clickTimeout){this._clickTimeout.cancel();}this._dragThreshMet=this._fromTimeout=false;this._ev_md=null;if(!this.get("lock")&&this.get(f)){this.fire(h,{pageX:this.lastXY[0],pageY:this.lastXY[1],startTime:this._startTime,endTime:this._endTime});}this.get(q).removeClass(d.CSS_PREFIX+"-dragging");this.set(f,false);this.deltaXY=[0,0];return this;},_defEndFn:function(s){this._fixIEMouseUp();},_prevEndFn:function(s){this._fixIEMouseUp();this.get(p).setXY(this.nodeXY);},_align:function(s){this.fire(n,{pageX:s[0],pageY:s[1]});},_defAlignFn:function(s){this.actXY=[s.pageX-this.deltaXY[0],s.pageY-this.deltaXY[1]];},_alignNode:function(s){this._align(s);this._moveNode();},_moveNode:function(u){var s=[],t=[],w=this.nodeXY,v=this.actXY;s[0]=(v[0]-this.lastXY[0]);s[1]=(v[1]-this.lastXY[1]);t[0]=(v[0]-this.nodeXY[0]);t[1]=(v[1]-this.nodeXY[1]);this.region={"0":v[0],"1":v[1],area:0,top:v[1],right:v[0]+this.get(p).get(c),bottom:v[1]+this.get(p).get(j),left:v[0]};this.fire(o,{pageX:v[0],pageY:v[1],scroll:u,info:{start:w,xy:v,delta:s,offset:t}});this.lastXY=v;},_defDragFn:function(s){if(this.get("move")){if(s.scroll){s.scroll.node.set("scrollTop",s.scroll.top);s.scroll.node.set("scrollLeft",s.scroll.left);}this.get(p).setXY([s.pageX,s.pageY]);this.realXY=[s.pageX,s.pageY];}},_move:function(u){if(this.get("lock")){return false;}else{this.mouseXY=[u.pageX,u.pageY];if(!this._dragThreshMet){var t=Math.abs(this.startXY[0]-u.pageX),s=Math.abs(this.startXY[1]-u.pageY);if(t>this.get("clickPixelThresh")||s>this.get("clickPixelThresh")){this._dragThreshMet=true;this.start();this._alignNode([u.pageX,u.pageY]);}}else{if(this._clickTimeout){this._clickTimeout.cancel();}this._alignNode([u.pageX,u.pageY]);}}},stopDrag:function(){if(this.get(f)){d._end();}return this;},destructor:function(){this._unprep();this.detachAll();if(this.target){this.target.destroy();}d._unregDrag(this);}});b.namespace("DD");b.DD.Drag=a;},"3.2.0",{requires:["dd-ddm-base"],skinnable:false});