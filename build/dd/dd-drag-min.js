/*
Copyright (c) 2010, Yahoo! Inc. All rights reserved.
Code licensed under the BSD License:
http://developer.yahoo.com/yui/license.html
version: 3.2.0
build: nightly
*/
YUI.add("dd-drag",function(B){var D=B.DD.DDM,Q="node",F="dragging",P="dragNode",J="offsetHeight",C="offsetWidth",G="drag:mouseDown",K="drag:afterMouseDown",E="drag:removeHandle",L="drag:addHandle",M="drag:removeInvalid",R="drag:addInvalid",I="drag:start",H="drag:end",O="drag:drag",N="drag:align",A=function(T){this._lazyAddAttrs=false;A.superclass.constructor.apply(this,arguments);var S=D._regDrag(this);if(!S){B.error("Failed to register node, already in use: "+T.node);}};A.NAME="drag";A.START_EVENT="mousedown";A.ATTRS={node:{setter:function(S){var T=B.one(S);if(!T){B.error("DD.Drag: Invalid Node Given: "+S);}else{T=T.item(0);}return T;}},dragNode:{setter:function(S){var T=B.one(S);if(!T){B.error("DD.Drag: Invalid dragNode Given: "+S);}return T;}},offsetNode:{value:true},startCentered:{value:false},clickPixelThresh:{value:D.get("clickPixelThresh")},clickTimeThresh:{value:D.get("clickTimeThresh")},lock:{value:false,setter:function(S){if(S){this.get(Q).addClass(D.CSS_PREFIX+"-locked");}else{this.get(Q).removeClass(D.CSS_PREFIX+"-locked");}return S;}},data:{value:false},move:{value:true},useShim:{value:true},activeHandle:{value:false},primaryButtonOnly:{value:true},dragging:{value:false},parent:{value:false},target:{value:false,setter:function(S){this._handleTarget(S);return S;}},dragMode:{value:null,setter:function(S){return D._setDragMode(S);}},groups:{value:["default"],getter:function(){if(!this._groups){this._groups={};}var S=[];B.each(this._groups,function(U,T){S[S.length]=T;});return S;},setter:function(S){this._groups={};B.each(S,function(U,T){this._groups[U]=true;},this);return S;}},handles:{value:null,setter:function(S){if(S){this._handles={};B.each(S,function(U,T){var V=U;if(U instanceof B.Node||U instanceof B.NodeList){V=U._yuid;}this._handles[V]=U;},this);}else{this._handles=null;}return S;}},bubbles:{setter:function(S){this.addTarget(S);return S;}},haltDown:{value:true}};B.extend(A,B.Base,{_bubbleTargets:B.DD.DDM,addToGroup:function(S){this._groups[S]=true;D._activateTargets();return this;},removeFromGroup:function(S){delete this._groups[S];D._activateTargets();return this;},target:null,_handleTarget:function(S){if(B.DD.Drop){if(S===false){if(this.target){D._unregTarget(this.target);this.target=null;}return false;}else{if(!B.Lang.isObject(S)){S={};}S.bubbleTargets=("bubbleTargets" in S)?S.bubbleTargets:B.Object.values(this._yuievt.targets);S.node=this.get(Q);S.groups=S.groups||this.get("groups");this.target=new B.DD.Drop(S);}}else{return false;}},_groups:null,_createEvents:function(){this.publish(G,{defaultFn:this._defMouseDownFn,queuable:false,emitFacade:true,bubbles:true,prefix:"drag"});this.publish(N,{defaultFn:this._defAlignFn,queuable:false,emitFacade:true,bubbles:true,prefix:"drag"});this.publish(O,{defaultFn:this._defDragFn,queuable:false,emitFacade:true,bubbles:true,prefix:"drag"});this.publish(H,{defaultFn:this._defEndFn,preventedFn:this._prevEndFn,queuable:false,emitFacade:true,bubbles:true,prefix:"drag"});var S=[K,E,L,M,R,I,"drag:drophit","drag:dropmiss","drag:over","drag:enter","drag:exit"];B.each(S,function(U,T){this.publish(U,{type:U,emitFacade:true,bubbles:true,preventable:false,queuable:false,prefix:"drag"});},this);},_ev_md:null,_startTime:null,_endTime:null,_handles:null,_invalids:null,_invalidsDefault:{"textarea":true,"input":true,"a":true,"button":true,"select":true},_dragThreshMet:null,_fromTimeout:null,_clickTimeout:null,deltaXY:null,startXY:null,nodeXY:null,lastXY:null,actXY:null,realXY:null,mouseXY:null,region:null,_handleMouseUp:function(S){this._fixIEMouseUp();if(D.activeDrag){D._end();}},_fixDragStart:function(S){S.preventDefault();},_ieSelectFix:function(){return false;},_ieSelectBack:null,_fixIEMouseDown:function(){if(B.UA.ie){this._ieSelectBack=B.config.doc.body.onselectstart;B.config.doc.body.onselectstart=this._ieSelectFix;}},_fixIEMouseUp:function(){if(B.UA.ie){B.config.doc.body.onselectstart=this._ieSelectBack;}},_handleMouseDownEvent:function(S){this.fire(G,{ev:S});},_defMouseDownFn:function(T){var S=T.ev;this._dragThreshMet=false;this._ev_md=S;if(this.get("primaryButtonOnly")&&S.button>1){return false;}if(this.validClick(S)){this._fixIEMouseDown();if(this.get("haltDown")){S.halt();}else{S.preventDefault();}this._setStartPosition([S.pageX,S.pageY]);D.activeDrag=this;this._clickTimeout=B.later(this.get("clickTimeThresh"),this,this._timeoutCheck);}this.fire(K,{ev:S});},validClick:function(W){var V=false,Z=false,S=W.target,U=null,T=null,X=null,Y=false;if(this._handles){B.each(this._handles,function(a,b){if(a instanceof B.Node||a instanceof B.NodeList){if(!V){X=a;if(X instanceof B.Node){X=new B.NodeList(a._node);}X.each(function(c){if(c.contains(S)){V=true;}});}}else{if(B.Lang.isString(b)){if(S.test(b+", "+b+" *")&&!U){U=b;V=true;}}}});}else{Z=this.get(Q);if(Z.contains(S)||Z.compareTo(S)){V=true;}}if(V){if(this._invalids){B.each(this._invalids,function(a,b){if(B.Lang.isString(b)){if(S.test(b+", "+b+" *")){V=false;}}});}}if(V){if(U){T=W.currentTarget.all(U);Y=false;T.each(function(b,a){if((b.contains(S)||b.compareTo(S))&&!Y){Y=true;this.set("activeHandle",b);}},this);}else{this.set("activeHandle",this.get(Q));}}return V;},_setStartPosition:function(S){this.startXY=S;this.nodeXY=this.lastXY=this.realXY=this.get(Q).getXY();if(this.get("offsetNode")){this.deltaXY=[(this.startXY[0]-this.nodeXY[0]),(this.startXY[1]-this.nodeXY[1])];}else{this.deltaXY=[0,0];}},_timeoutCheck:function(){if(!this.get("lock")&&!this._dragThreshMet&&this._ev_md){this._fromTimeout=this._dragThreshMet=true;this.start();this._alignNode([this._ev_md.pageX,this._ev_md.pageY],true);}},removeHandle:function(T){var S=T;if(T instanceof B.Node||T instanceof B.NodeList){S=T._yuid;}if(this._handles[S]){delete this._handles[S];this.fire(E,{handle:T});}return this;},addHandle:function(T){if(!this._handles){this._handles={};}var S=T;if(T instanceof B.Node||T instanceof B.NodeList){S=T._yuid;}this._handles[S]=T;this.fire(L,{handle:T});return this;},removeInvalid:function(S){if(this._invalids[S]){this._invalids[S]=null;
delete this._invalids[S];this.fire(M,{handle:S});}return this;},addInvalid:function(S){if(B.Lang.isString(S)){this._invalids[S]=true;this.fire(R,{handle:S});}return this;},initializer:function(S){this.get(Q).dd=this;if(!this.get(Q).get("id")){var T=B.stamp(this.get(Q));this.get(Q).set("id",T);}this.actXY=[];this._invalids=B.clone(this._invalidsDefault,true);this._createEvents();if(!this.get(P)){this.set(P,this.get(Q));}this.on("initializedChange",B.bind(this._prep,this));this.set("groups",this.get("groups"));},_prep:function(){this._dragThreshMet=false;var S=this.get(Q);S.addClass(D.CSS_PREFIX+"-draggable");S.addClass(D.CSS_PREFIX+"-draggable");S.on(A.START_EVENT,B.bind(this._handleMouseDownEvent,this));S.on("mouseup",B.bind(this._handleMouseUp,this));S.on("dragstart",B.bind(this._fixDragStart,this));},_unprep:function(){var S=this.get(Q);S.removeClass(D.CSS_PREFIX+"-draggable");S.detachAll();},start:function(){if(!this.get("lock")&&!this.get(F)){var T=this.get(Q),S,U,V;this._startTime=(new Date()).getTime();D._start();T.addClass(D.CSS_PREFIX+"-dragging");this.fire(I,{pageX:this.nodeXY[0],pageY:this.nodeXY[1],startTime:this._startTime});T=this.get(P);V=this.nodeXY;S=T.get(C);U=T.get(J);if(this.get("startCentered")){this._setStartPosition([V[0]+(S/2),V[1]+(U/2)]);}this.region={"0":V[0],"1":V[1],area:0,top:V[1],right:V[0]+S,bottom:V[1]+U,left:V[0]};this.set(F,true);}return this;},end:function(){this._endTime=(new Date()).getTime();if(this._clickTimeout){this._clickTimeout.cancel();}this._dragThreshMet=this._fromTimeout=false;this._ev_md=null;if(!this.get("lock")&&this.get(F)){this.fire(H,{pageX:this.lastXY[0],pageY:this.lastXY[1],startTime:this._startTime,endTime:this._endTime});}this.get(Q).removeClass(D.CSS_PREFIX+"-dragging");this.set(F,false);this.deltaXY=[0,0];return this;},_defEndFn:function(S){this._fixIEMouseUp();},_prevEndFn:function(S){this._fixIEMouseUp();this.get(P).setXY(this.nodeXY);},_align:function(S){this.fire(N,{pageX:S[0],pageY:S[1]});},_defAlignFn:function(S){this.actXY=[S.pageX-this.deltaXY[0],S.pageY-this.deltaXY[1]];},_alignNode:function(S){this._align(S);this._moveNode();},_moveNode:function(U){var S=[],T=[],W=this.nodeXY,V=this.actXY;S[0]=(V[0]-this.lastXY[0]);S[1]=(V[1]-this.lastXY[1]);T[0]=(V[0]-this.nodeXY[0]);T[1]=(V[1]-this.nodeXY[1]);this.region={"0":V[0],"1":V[1],area:0,top:V[1],right:V[0]+this.get(P).get(C),bottom:V[1]+this.get(P).get(J),left:V[0]};this.fire(O,{pageX:V[0],pageY:V[1],scroll:U,info:{start:W,xy:V,delta:S,offset:T}});this.lastXY=V;},_defDragFn:function(S){if(this.get("move")){if(S.scroll){S.scroll.node.set("scrollTop",S.scroll.top);S.scroll.node.set("scrollLeft",S.scroll.left);}this.get(P).setXY([S.pageX,S.pageY]);this.realXY=[S.pageX,S.pageY];}},_move:function(U){if(this.get("lock")){return false;}else{this.mouseXY=[U.pageX,U.pageY];if(!this._dragThreshMet){var T=Math.abs(this.startXY[0]-U.pageX),S=Math.abs(this.startXY[1]-U.pageY);if(T>this.get("clickPixelThresh")||S>this.get("clickPixelThresh")){this._dragThreshMet=true;this.start();this._alignNode([U.pageX,U.pageY]);}}else{if(this._clickTimeout){this._clickTimeout.cancel();}this._alignNode([U.pageX,U.pageY]);}}},stopDrag:function(){if(this.get(F)){D._end();}return this;},destructor:function(){this._unprep();this.detachAll();if(this.target){this.target.destroy();}D._unregDrag(this);}});B.namespace("DD");B.DD.Drag=A;},"3.2.0",{requires:["dd-ddm-base"],skinnable:false});