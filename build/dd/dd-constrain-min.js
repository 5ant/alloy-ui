/*
Copyright (c) 2010, Yahoo! Inc. All rights reserved.
Code licensed under the BSD License:
http://developer.yahoo.com/yui/license.html
version: 3.2.0
build: nightly
*/
YUI.add("dd-constrain",function(c){var a="dragNode",q="offsetHeight",g="offsetWidth",o="host",f="tickXArray",p="tickYArray",n=c.DD.DDM,e="top",k="right",m="bottom",d="left",l="view",i=null,j="drag:tickAlignX",h="drag:tickAlignY",b=function(r){this._lazyAddAttrs=false;b.superclass.constructor.apply(this,arguments);};b.NAME="ddConstrained";b.NS="con";b.ATTRS={host:{},stickX:{value:false},stickY:{value:false},tickX:{value:false},tickY:{value:false},tickXArray:{value:false},tickYArray:{value:false},gutter:{value:"0",setter:function(r){return c.DD.DDM.cssSizestoObject(r);}},constrain:{value:l,setter:function(r){var s=c.one(r);if(s){r=s;}return r;}},constrain2region:{setter:function(s){return this.set("constrain",s);}},constrain2node:{setter:function(r){return this.set("constrain",c.one(r));}},constrain2view:{setter:function(r){return this.set("constrain",l);}},cacheRegion:{value:true}};i={_lastTickXFired:null,_lastTickYFired:null,initializer:function(){this._createEvents();this.get(o).on("drag:start",c.bind(this._handleStart,this));this.get(o).after("drag:align",c.bind(this.align,this));this.get(o).after("drag:drag",c.bind(this.drag,this));},_createEvents:function(){var r=this;var s=[j,h];c.each(s,function(u,t){this.publish(u,{type:u,emitFacade:true,bubbles:true,queuable:false,prefix:"drag"});},this);},_handleStart:function(){this.resetCache();},_regionCache:null,_cacheRegion:function(){this._regionCache=this.get("constrain").get("region");},resetCache:function(){this._regionCache=null;},_getConstraint:function(){var r=this.get("constrain"),s=this.get("gutter"),t;if(r){if(r instanceof c.Node){if(!this._regionCache){c.on("resize",c.bind(this._cacheRegion,this),c.config.win);this._cacheRegion();}t=c.clone(this._regionCache);if(!this.get("cacheRegion")){this.resetCache();}}else{if(c.Lang.isObject(r)){t=c.clone(r);}}}if(!r||!t){r=l;}if(r===l){t=this.get(o).get(a).get("viewportRegion");}c.each(s,function(u,v){if((v==k)||(v==m)){t[v]-=u;}else{t[v]+=u;}});return t;},getRegion:function(w){var u={},v=null,s=null,t=this.get(o);u=this._getConstraint();if(w){v=t.get(a).get(q);s=t.get(a).get(g);u[k]=u[k]-s;u[m]=u[m]-v;}return u;},_checkRegion:function(s){var u=s,w=this.getRegion(),v=this.get(o),x=v.get(a).get(q),t=v.get(a).get(g);if(u[1]>(w[m]-x)){s[1]=(w[m]-x);}if(w[e]>u[1]){s[1]=w[e];}if(u[0]>(w[k]-t)){s[0]=(w[k]-t);}if(w[d]>u[0]){s[0]=w[d];}return s;},inRegion:function(t){t=t||this.get(o).get(a).getXY();var r=this._checkRegion([t[0],t[1]]),s=false;if((t[0]===r[0])&&(t[1]===r[1])){s=true;}return s;},align:function(){var u=this.get(o),s=[u.actXY[0],u.actXY[1]],t=this.getRegion(true);if(this.get("stickX")){s[1]=(u.startXY[1]-u.deltaXY[1]);}if(this.get("stickY")){s[0]=(u.startXY[0]-u.deltaXY[0]);}if(t){s=this._checkRegion(s);}s=this._checkTicks(s,t);u.actXY=s;},drag:function(v){var u=this.get(o),s=this.get("tickX"),t=this.get("tickY"),r=[u.actXY[0],u.actXY[1]];if((c.Lang.isNumber(s)||this.get(f))&&(this._lastTickXFired!==r[0])){this._tickAlignX();this._lastTickXFired=r[0];}if((c.Lang.isNumber(t)||this.get(p))&&(this._lastTickYFired!==r[1])){this._tickAlignY();this._lastTickYFired=r[1];}},_checkTicks:function(y,w){var v=this.get(o),x=(v.startXY[0]-v.deltaXY[0]),u=(v.startXY[1]-v.deltaXY[1]),s=this.get("tickX"),t=this.get("tickY");if(s&&!this.get(f)){y[0]=n._calcTicks(y[0],x,s,w[d],w[k]);}if(t&&!this.get(p)){y[1]=n._calcTicks(y[1],u,t,w[e],w[m]);}if(this.get(f)){y[0]=n._calcTickArray(y[0],this.get(f),w[d],w[k]);}if(this.get(p)){y[1]=n._calcTickArray(y[1],this.get(p),w[e],w[m]);}return y;},_tickAlignX:function(){this.fire(j);},_tickAlignY:function(){this.fire(h);}};c.namespace("Plugin");c.extend(b,c.Base,i);c.Plugin.DDConstrained=b;c.mix(n,{_calcTicks:function(y,x,u,w,v){var s=((y-x)/u),t=Math.floor(s),r=Math.ceil(s);if((t!==0)||(r!==0)){if((s>=t)&&(s<=r)){y=(x+(u*t));if(w&&v){if(y<w){y=(x+(u*(t+1)));}if(y>v){y=(x+(u*(t-1)));}}}}return y;},_calcTickArray:function(z,A,y,w){var s=0,v=A.length,t=0,u,r,x;if(!A||(A.length===0)){return z;}else{if(A[0]>=z){return A[0];}else{for(s=0;s<v;s++){t=(s+1);if(A[t]&&A[t]>=z){u=z-A[s];r=A[t]-z;x=(r>u)?A[s]:A[t];if(y&&w){if(x>w){if(A[s]){x=A[s];}else{x=A[v-1];}}}return x;}}return A[A.length-1];}}}});},"3.2.0",{requires:["dd-drag"],skinnable:false});