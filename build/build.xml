<?xml version="1.0" encoding="utf-8"?>

<!--
/*!
 * Alloy JavaScript Library
 * http://alloyui.com/
 *
 * Copyright (c) 2009 Liferay Inc.
 * Licensed under the MIT license.
 * http://alloyui.com/License
 *
 * Nate Cavanaugh (nate.cavanaugh@liferay.com)
 * Eduardo Lundgren (eduardo.lundgren@liferay.com)
 */
-->

<project name="Alloy" default="release" basedir=".">
	<property name="project.dir" value="../"/>
	<property name="build.dir" value="${project.dir}/build/"/>
	<property name="demo.dir" value="${project.dir}/demos/"/>
	<property name="src.dir" value="${project.dir}/src/"/>
	<property name="css.src.dir" value="${src.dir}/css/"/>
	<property name="javascript.src.dir" value="${src.dir}/javascript/"/>

	<property name="alloy.version" value="0.1a"/>
	<property name="alloy.core.files" value="defaults.js, core.js"/>

	<property name="yui3.file" value="yui_3.0.0b1.zip" />
	<property name="yui3.dir" value="${project.dir}/lib/yui/" />

	<property name="release.name" value="alloy" />
	<property name="release.dir" value="${build.dir}/${release.name}/" />
	<property name="yui.compressor.file" value="yuicompressor-2.4.2.jar" />
	<property name="yui.compressor.path" value="${build.dir}/lib/${yui.compressor.file}" />

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${build.dir}/lib/ant-contrib-0.6.jar"/>
		</classpath>
	</taskdef>


	<target name="init-yui" depends="whitespace" description="Create the YUI Library folders.">
		<echo>Initializing YUI Library.</echo>

		<delete dir="${yui3.dir}" />
		<unzip src="${project.dir}/lib/${yui3.file}" dest="${project.dir}/lib/" />

		<antcall target="apply-patches" />
	</target>


	<target name="clean">
		<delete dir="${release.dir}" />
		<delete file="${build.dir}/${release.name}-${alloy.version}.zip" />
	</target>


	<target name="whitespace">
		<echo>Removing trailing spaces of the source files.</echo>

		<replaceregexp match="[\t ]+$" replace="" flags="g" byline="true">
			<fileset dir="${javascript.src.dir}" includes="*.js"/>
		</replaceregexp>
	</target>


	<target name="release" depends="init-release, minify, zip" />


	<target name="init-release" depends="clean, whitespace">
		<echo>Preparing files and folders for release.</echo>

		<copy todir="${release.dir}">
			<fileset dir="${project.dir}">
				<include name="lib/yui/build/**" />
				<include name="lib/patches/**" />
				<include name="src/**" />
				<include name="demos/**" />
				<include name="themes/**" />
			</fileset>
		</copy>

		<copy todir="${release.dir}">
            <filelist dir="${project.dir}/" files="version.txt" />
        </copy>

		<replaceregexp match="@VERSION" replace="${alloy.version}" flags="g" byline="true">
            <fileset dir="${release.dir}/" includes="**/*.js, **/*.css, **/*.txt"/>
        </replaceregexp>
	</target>

	<target name="create-demo">
		<if>
			<available file="${demo.dir}${demo.name}" />
			<then>
				<echo message="${demo.dir}${demo.name} already exists." />
			</then>
			<else>
				<mkdir dir="${demo.dir}${demo.name}" />

				<copy todir="${demo.dir}${demo.name}">
					<fileset dir="${build.dir}/_demo_template">
						<include name="**" />
					</fileset>
				</copy>

				<move todir="${demo.dir}${demo.name}">
					<fileset dir="${demo.dir}${demo.name}">
						<include name="**/_demo_template.*"/>
					</fileset>

					<mapper type="glob" from="_demo_template.*" to="${demo.name}.*"/>
				</move>

				<replace dir="${demo.dir}${demo.name}">
					<replacefilter token="@demo.name@" value="${demo.name}" />
				</replace>

				<move
					file="${demo.dir}${demo.name}/${demo.name}.css"
					tofile="${project.dir}themes/base/css/${demo.name}.css"
					overwrite="no"
				/>
			</else>
		</if>
	</target>

	<target name="concatenate" depends="init-release">
		<echo>Concatenating JavaScript files.</echo>

		<property name="alloy.dest.file" value="${release.dir}/src/javascript/${release.name}.js" />
		<delete file="${alloy.dest.file}"/>

		<concat destfile="${alloy.dest.file}">
	        <filelist dir="${release.dir}/src/javascript/" files="${alloy.core.files}"/>
	        <fileset dir="${release.dir}/src/javascript/" includes="*.js" excludes="${alloy.core.files}"/>
	    </concat>
	</target>


	<target name="zip" depends="minify">
		<echo>Creating Zip file ${release.name}.zip</echo>

		<zip basedir="${release.dir}" destfile="${build.dir}/${release.name}-${alloy.version}.zip" />
	</target>


	<target name="minify" depends="minify-javascript, minify-css" />


	<target name="minify-javascript" depends="concatenate">
		<echo>Minifying JavaScript files.</echo>

		<mkdir dir="${release.dir}/src/javascript/minified/"/>

		<apply executable="java" parallel="false">
			<fileset dir="${release.dir}/src/javascript/" includes="*.js" />
			<arg line="-jar" />
			<arg path="${yui.compressor.path}" />
			<arg value="--charset"/>
            <arg value="UTF-8"/>
			<srcfile/>
			<arg line="-o" />
			<mapper type="glob" from="*.js" to="${release.name}/src/javascript/minified/*-min.js" />
			<targetfile/>
		</apply>
	</target>


	<target name="minify-css" depends="concatenate">
		<echo>Minifying CSS files.</echo>

		<apply executable="java" parallel="false">
			<fileset dir="${release.dir}/themes/" includes="**/*.css" />
			<arg line="-jar" />
			<arg path="${yui.compressor.path}" />
			<arg value="--charset"/>
            <arg value="UTF-8"/>
			<srcfile/>
			<arg line="-o" />
			<mapper type="glob" from="*.css" to="${release.name}/themes/*-min.css" />
			<targetfile/>
		</apply>
	</target>

	<target name="apply-patches">
		<echo>Applying needed patches.</echo>

		<exec executable="patch">
			<arg value="${project.dir}/lib/yui/build/pluginhost/pluginhost.js"/>
			<arg value="${project.dir}/lib/patches/pluginhost.diff"/>
		</exec>

		<!-- Recreating -min.js file after patch -->

		<delete file="${project.dir}/lib/yui/build/pluginhost/pluginhost-min.js" />

		<exec executable="java">
			<arg value="-jar"/>
			<arg value="${yui.compressor.path}"/>
			<arg value="--charset"/>
            <arg value="UTF-8"/>
			<arg value="${project.dir}/lib/yui/build/pluginhost/pluginhost.js"/>
			<arg line="-o" />
			<arg value="${project.dir}/lib/yui/build/pluginhost/pluginhost-min.js"/>
		</exec>
	</target>
</project>