<!DOCTYPE html>

<html>
<head>
	<script src="../../build/aui/aui.js" type="text/javascript"></script>

	<link rel='stylesheet' href='../../build/aui-skin-classic/css/aui-skin-classic-all-min.css' type='text/css' media='screen' />

	<style type="text/css" media="screen">
		body {
			font-size: 12px;
		}

		#wrapper {
			padding: 10px;
		}

		#markupTabs {
			width: 250px;
		}


		.aui-diagram-builder-base-drop-container .aui-diagram-node-editing .aui-diagram-node-content {
			background-color: lightyellow !important;
		}

		.aui-diagram-builder-base-viewport {
			position: relative;
			background-image: url("checker-bg.png");
			outline: 0;

			border-left: 1px solid #CCCCCC;
		    border-right: 1px solid #BBBBBB;

		    border-bottom: 1px solid #BBBBBB;
		    border-top: 1px solid #CCCCCC;
		}

		.aui-diagram-node {
			z-index: 10 !important;
		}

		.aui-diagram-node-content {
			background-color: #D5E1DD;
			border: 2px solid #747E80;
			border-radius: 15px;
		}

		.aui-diagram-builder-connector-wrapper {
			z-index: 1;
		}

		.aui-basecelleditor {
			z-index: 1000 !important;
		}


		.aui-diagram-builder-anchor-node {
			width: 15px;
			height: 15px;
			background: #2B3E42;
			position: absolute;
/*			border: 1px solid #2B3E42;*/
			cursor: pointer;
			border-radius: 12px;
		}

		.aui-diagram-builder-anchor-node-max-targets {
			cursor: auto;
		}

		.aui-diagram-builder-anchor-hover {
			background: green;
		}

		.aui-diagram-builder-anchor-node.yui3-dd-dragging {
			background: yellow;
		}

		.aui-diagram-builder-anchor-node.yui3-dd-drop-active-valid {
			background: green;
		}

		.aui-diagram-builder-anchor-node.yui3-dd-drop-over {
			background: #F7F3E8;
			border: 2px solid #747E80;
			-moz-transform: scale(1.3);
			-moz-transition:-moz-transform 0.4s ease-in-out;
			-moz-transition: background-color 0.4s linear;
			-webkit-transform: scale(1.3);
			-webkit-transition:-moz-transform 0.4s ease-in-out;
			-webkit-transition: background-color 0.4s linear;
		}

		.aui-diagram-node-content {
			padding: 10px;
		}

		.log {
			width: 300px;
			font-size: 10px;
		}

		.aui-diagram-builder-controls {
			display: none;
		}

		.aui-diagram-node-selected .aui-diagram-builder-controls {
			display: block;
			text-align: center;
			padding: 3px;
		}

		.aui-diagram-node-controls-icon {
			display: inline-block;
		    margin-top: -3px;
		    vertical-align: middle;
		}

		.aui-diagram-node-selected {
			border: 1px dotted #666;
		}

		.aui-diagram-node-selected .aui-diagram-node-content {
/*			background-color: lightgreen !important;*/
/*			border-radius: 15px;*/
/*			border: 1px dotted #666;*/
		}

		.aui-diagram-node-focused {
			outline: 0;
		}

		.aui-diagram-node-focused .aui-diagram-node-content {
/*			background-color: lightyellow !important;*/
		}
	</style>
</head>

<body class='yui3-skin-sam'>

<div id="wrapper">
	<h1>Alloy - diagram-builder-base Demo</h1>

	<div id="demo">

		<div id="diagrambuilderBB" class="aui-diagram-builder-base">
			<div id="diagrambuilderCB" class="aui-helper-clearfix aui-diagram-builder-base-content">

				<div class="aui-diagram-builder-base-tabs-container">
					<div class="aui-diagram-builder-base-tabs-container-content">
						<ul class="aui-tabview-list aui-widget-hd">
							<li class="aui-tab aui-state-default aui-state-active aui-tab-active aui-diagram-builder-base-tab-add">
								<span class="aui-tab-content"><a class="aui-tab-label" href="javascript:;">Add node</a></span>
							</li>
							<li class="aui-tab aui-state-default aui-diagram-builder-base-tab-settings">
								<span class="aui-tab-content"><a class="aui-tab-label" href="javascript:;">Node settings</a></span>
							</li>
						</ul>

						<div class="aui-tabview-content aui-widget-bd">
							<div class="aui-tabview-content-item"></div>
							<div class="aui-tabview-content-item aui-helper-hidden"></div>
						</div>
					</div>
				</div>

				<div class="aui-diagram-builder-base-viewport">
					<div class="aui-diagram-builder-base-drop-container"></div>
				</div>

			</div>
		</div>

		<br/>
		<br/>
		<br/>

		<div id="diagramBuilder2"></div>

	</div>
</div>

<script type="text/javascript" charset="utf-8">

AUI().use('aui-diagram-builder', function(A) {

	var Lang = A.Lang,
		isBoolean = Lang.isBoolean,

		AArray = A.Array,

		ACTIONS = 'actions',
		ADD_ANCHOR = 'addAnchor',
		ADD_ANCHOR_MESSAGE = 'addAnchorMessage',
		ADD_NODE = 'addNode',
		ASSIGNMENTS = 'assignments',
		CONDITION = 'condition',
		DIAGRAM_NODE_NAME = 'diagram-node',
		EDIT_EVENT = 'editEvent',
		EDIT_MESSAGE = 'editMessage',
		END = 'end',
		FORK = 'fork',
		INITIAL = 'initial',
		JOIN = 'join',
		LINK = 'link',
		NOTIFICATIONS = 'notifications',
		PENCIL = 'pencil',
		SHUFFLE = 'shuffle',
		START = 'start',
		STATE = 'state',
		TASK = 'task';


	// Liferay Workflow Nodes - MOVE THIS CODE!

	A.DiagramNodeState = A.Component.create({
		NAME: DIAGRAM_NODE_NAME,

		ATTRS: {
			initial: {
				value: false,
				validation: isBoolean
			},

			notifications: {
				// value: {
				// 	name: 'string',
				// 	description: 'string',
				// 	template: 'string',
				// 	'template-type': 'string',
				// 	'notification-type': 'string',
				// 	recipients: {
				// 		address: 'string',
				//
				// 		role: {
				// 			roleId: 1234,
				// 			roleType: 'string',
				// 			name: 'string',
				// 			autoCreate: true
				// 		},
				//
				// 		user: {
				// 			'user-id': 1234,
				// 			'screen-name': 'string',
				// 			'email-address': 'string'
				// 		}
				// 	}
				// }
			},

			actions: {
				// value: {
				// 	name: 'string',
				// 	description: 'string',
				// 	script: 'string',
				// 	'script-language': 'string',
				// 	priority: 0
				// }
			},

			timers:{
			},

			strings: {
				value: {
					actions: 'Actions',
					addAnchorMessage: 'Add Anchor',
					assignments: 'Assignments',
					closeMessage: 'Close',
					deleteMessage: 'Are you sure you want to delete?',
					description: 'Description',
					editMessage: 'Edit',
					initial: 'Initial',
					name: 'Name',
					notifications: 'Notifications',
					type: 'Type'
				}
			},

			type: {
				value: STATE
			}
		},

		EXTENDS: A.DiagramNode,

		prototype: {
			getConnectionNode: function() {
				return new A.DiagramNodeTask({
					xy: [100, 100] // TODO - find best position?
				});
			},

			getPropertyModel: function() {
				var instance = this;
				var strings = instance.getStrings();
				var parentModel = A.DiagramNodeState.superclass.getPropertyModel.apply(this, arguments);

				return AArray(parentModel).concat([
					{
						attributeName: ACTIONS,
						editor: new A.TextAreaCellEditor(),
						name: strings[ACTIONS]
					},

					{
						attributeName: NOTIFICATIONS,
						editor: new A.TextAreaCellEditor(),
						name: strings[NOTIFICATIONS]
					},

					{
						attributeName: INITIAL,
						editor: false,
						name: strings[INITIAL]
					}
				]);
			}
		}
	});

	A.DiagramBuilder.types[STATE] = A.DiagramNodeState;

	A.DiagramNodeCondition = A.Component.create({
		NAME: DIAGRAM_NODE_NAME,

		ATTRS: {
			type: {
				value: CONDITION
			}
		},

		EXTENDS: A.DiagramNodeState
	});

	A.DiagramBuilder.types[CONDITION] = A.DiagramNodeCondition;

	A.DiagramNodeStart = A.Component.create({
		NAME: DIAGRAM_NODE_NAME,

		ATTRS: {
			initial: {
				value: true
			},

			maxFields: {
				value: 1
			},

			required: {
				value: true
			},

			type: {
				value: START
			}
		},

		EXTENDS: A.DiagramNodeState,

		prototype: {
			getConnectionNode: function() {
				return new A.DiagramNodeCondition({
					xy: [100, 100] // TODO - find best position?
				});
			},

			_valueControlsToolbar: function(val) {
				var instance = this;
				var strings = instance.getStrings();

				return {
					activeState: false,
					children: [
						{
							handler: A.bind(instance._handleEditEvent, instance),
							icon: PENCIL,
							id: EDIT_EVENT,
							title: strings[EDIT_MESSAGE]
						},
						{
							handler: A.bind(instance._handleAddAnchorEvent, instance),
							icon: LINK,
							id: ADD_ANCHOR,
							title: strings[ADD_ANCHOR_MESSAGE]
						},
						{
							handler: A.bind(instance._handleAddNodeEvent, instance),
							icon: SHUFFLE,
							id: ADD_NODE
						}
					]
				};
			}
		}
	});

	A.DiagramBuilder.types[START] = A.DiagramNodeStart;

	A.DiagramNodeEnd = A.Component.create({
		NAME: DIAGRAM_NODE_NAME,

		ATTRS: {
			required: {
				value: true
			},

			type: {
				value: END
			}
		},

		EXTENDS: A.DiagramNodeState,

		prototype: {
			_handleAddAnchorEvent: function(event) {
				var instance = this;

				instance.addField({
					maxTargets: 0
				});
			},

			_valueControlsToolbar: function(val) {
				var instance = this;
				var strings = instance.getStrings();

				return {
					activeState: false,
					children: [
						{
							handler: A.bind(instance._handleEditEvent, instance),
							icon: PENCIL,
							id: EDIT_EVENT,
							title: strings[EDIT_MESSAGE]
						},
						{
							handler: A.bind(instance._handleAddAnchorEvent, instance),
							icon: LINK,
							id: ADD_ANCHOR,
							title: strings[ADD_ANCHOR_MESSAGE]
						}
					]
				};
			}
		}
	});

	A.DiagramBuilder.types[END] = A.DiagramNodeEnd;

	A.DiagramNodeJoin = A.Component.create({
		NAME: DIAGRAM_NODE_NAME,

		ATTRS: {
			type: {
				value: JOIN
			}
		},

		EXTENDS: A.DiagramNodeState
	});

	A.DiagramBuilder.types[JOIN] = A.DiagramNodeJoin;

	A.DiagramNodeFork = A.Component.create({
		NAME: DIAGRAM_NODE_NAME,

		ATTRS: {
			type: {
				value: FORK
			}
		},

		EXTENDS: A.DiagramNodeState
	});

	A.DiagramBuilder.types[FORK] = A.DiagramNodeFork;

	A.DiagramNodeTask = A.Component.create({
		NAME: DIAGRAM_NODE_NAME,

		ATTRS: {
			assignments: {
				value: {
					// roles: [
					// 	{
					// 		role: {
					// 			roleId: 1234,
					// 			roleType: 'string',
					// 			name: 'string',
					// 			autoCreate: true
					// 		}
					// 	}
					// ]

					// 'resource-actions': {
					// 	'resource-action': 'string'
					// }

					// 'scripted-assignment': {
					// 	script: 'string',
					// 	'script-language': 'string'
					// }

					// user: {
					// 	'user-id': 1234,
					// 	'screen-name': 'string',
					// 	'email-address': 'string'
					// }
				}
			},

			type: {
				value: TASK
			}
		},

		EXTENDS: A.DiagramNodeState,

		prototype: {
			getPropertyModel: function() {
				var instance = this;
				var strings = instance.getStrings();
				var parentModel = A.DiagramNodeTask.superclass.getPropertyModel.apply(this, arguments);

				return AArray(parentModel).concat([
					{
						attributeName: ASSIGNMENTS,
						editor: new A.TextAreaCellEditor(),
						name: strings[ASSIGNMENTS]
					}
				]);
			}
		}
	});

	A.DiagramBuilder.types[TASK] = A.DiagramNodeTask;

	// End of Liferay Workflow Nodes.






// console.log(A.DiagramNode.buildNodeId('Task1'));

	// A.on('available', function() { console.log('OKK'); }, '#' + A.DiagramNode.buildNodeId('Task1'));

	var availableFields = [
		{
			type: 'task',
			label: 'Task',
			iconClass: 'task-icon'
		},
		{
			type: 'join',
			label: 'Join',
			iconClass: 'join-icon'
		},
		{
			type: 'fork',
			label: 'Fork',
			iconClass: 'fork-icon'
		},

		{
			type: 'start',
			label: 'Start',
			iconClass: 'start-icon'
		},
		{
			type: 'end',
			label: 'End',
			iconClass: 'end-icon'
		},
		{
			type: 'condition',
			label: 'Condition',
			iconClass: 'condition-icon'
		}
	];

	task0 = new A.DiagramNodeTask({
		name: 'Task0',
		xy: [900, 200],
		fields: [
		]
	});

	diagramBuilder1 = new A.DiagramBuilder(
		{
			boundingBox: '#diagrambuilderBB',
			srcNode: '#diagrambuilderCB',
			// height: 600,
			availableFields: availableFields,
			fields: [
				task0,
				{
					name: 'StartNode',
					type: 'start',
					xy: [1200, 50],
					fields: [
						{}
					]
				},
				{
					name: 'EndNode',
					type: 'end',
					xy: [50, 50],
					fields: [
					]
				},
				{
					name: 'Task1',
					type: 'task',
					xy: [600, 200],
					// fields: [
					// 	{
					// 	}
					// ]
				},
				{
					name: 'Task2',
					type: 'task',
					xy: [300, 200],
					// fields: [
					// 	{},
					// 	{}
					// ]
				}
			]
		}
	).render();

	// diagramBuilder1.connect('StartNode', 'Task1');

	// diagramBuilder1.connect('StartNode', 'Task0');
	// diagramBuilder1.connect('Task0', 'Task1');
	// diagramBuilder1.connect('Task1', 'Task2');
	// diagramBuilder1.connect('Task2', 'EndNode');

	diagramBuilder1.connectAll([
		{
			source: 'StartNode',
			target: 'Task0'
		},

		{
			source: task0,
			target: 'Task1'
		},

		{
			source: 'Task1',
			target: 'Task2'
		},

		{
			source: 'Task2',
			target: 'EndNode'
		}
	]);

	// diagramBuilder2 = new A.DiagramBuilder(
	// 	{
	// 		after: {
	// 			cancel: function(event) {
	// 				console.log('cancel', event);
	// 			},
	//
	// 			save: function(event) {
	// 				console.log('save', event);
	// 			},
	//
	// 			addField: function(event) {
	// 				// console.log('addField', event);
	// 			}
	// 		},
	// 		availableFields: availableFields,
	//
	// 		fields: [
	// 			{
	// 				bodyContent: 'Node1',
	// 				xy: [200, 200]
	// 			},
	// 			{
	// 				bodyContent: 'Node2'
	// 			}
	// 		],
	// 		// fields: new A.ArrayList([{a:1}, {a:2}]),
	//
	// 		// propertyList: {
	// 		// 	recordset: [
	// 		// 		{
	// 		// 			name: 'Text1',
	// 		// 			value: 'Text value'
	// 		// 		},
	// 		// 		{
	// 		// 			name: 'Text2',
	// 		// 			value: 'Text value'
	// 		// 		},
	// 		// 		{
	// 		// 			name: 'Text3',
	// 		// 			value: 'Text value'
	// 		// 		}
	// 		// 	]
	// 		// }
	// 	}
	// ).render('#diagramBuilder2');

	// diagramBuilder2.set('height', 1000);
	// diagramBuilder2.set('fields', [1,2]);
	// diagramBuilder2.addField({bodyContent:'ABC'});

	// console.log(diagramBuilder2.get('fields'));

});

</script>

</body>
</html>